<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DaggerConnect ‚Äî Control Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#050710; --bg2:#07081180; --bg3:#0a0c18; --surface:#0d0f1e;
      --border:#161929; --border2:#1e2238;
      --accent:#4f8ef7; --accent-glow:rgba(79,142,247,.2);
      --accent2:#7c5cfc; --accent3:#0fcf8e; --accent4:#f4a118;
      --danger:#f04b4b; --warn:#f97316;
      --text:#eef2f8; --text2:#7d89a0; --text3:#313756;
      --sidebar-w:248px;
      --radius:12px;
      --card-bg:rgba(12,14,26,.75);
    }
    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      font-family:'Geist',system-ui,sans-serif;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;
      font-feature-settings:'ss01','ss02','cv01';
      -webkit-font-smoothing:antialiased;
    }

    /* Ambient glow layers */
    body::before{
      content:'';position:fixed;inset:0;
      background:
              radial-gradient(ellipse 70% 55% at 15% 0%, rgba(79,142,247,.06) 0%, transparent 55%),
              radial-gradient(ellipse 50% 70% at 85% 90%, rgba(124,92,252,.05) 0%, transparent 55%),
              radial-gradient(ellipse 40% 40% at 50% 50%, rgba(79,142,247,.02) 0%, transparent 60%);
      pointer-events:none;z-index:0;
    }
    /* Subtle noise texture */
    body::after{
      content:'';position:fixed;inset:0;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");
      background-size:200px 200px;
      pointer-events:none;z-index:0;opacity:.7;
    }

    .app{display:flex;min-height:100vh;position:relative;z-index:1;}

    /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
    .sidebar{
      width:var(--sidebar-w);min-height:100vh;
      background:rgba(5,6,14,.96);
      border-right:1px solid var(--border);
      display:flex;flex-direction:column;flex-shrink:0;
      position:fixed;left:0;top:0;bottom:0;z-index:100;
      backdrop-filter:blur(32px);
    }

    .logo{
      padding:18px 16px;
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:12px;
    }
    .logo-icon{
      width:36px;height:36px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      font-size:17px;flex-shrink:0;
      box-shadow:0 4px 20px rgba(79,142,247,.35), 0 0 0 1px rgba(79,142,247,.2);
    }
    .logo-text{font-size:14px;font-weight:700;letter-spacing:-.02em;color:var(--text);}
    .logo-sub{font-family:'Geist Mono',monospace;font-size:9px;color:var(--accent);letter-spacing:.1em;opacity:.7;margin-top:1px;}

    .nav{flex:1;padding:8px 0 12px;overflow-y:auto;scrollbar-width:none;}
    .nav::-webkit-scrollbar{display:none;}
    .nav-label{
      font-family:'Geist Mono',monospace;font-size:9px;letter-spacing:.13em;
      color:var(--text3);padding:16px 16px 5px;text-transform:uppercase;
    }
    .nav-item{
      display:flex;align-items:center;gap:9px;
      padding:7px 10px;margin:1px 8px;
      border-radius:9px;cursor:pointer;
      transition:background .15s,color .15s;
      font-size:12.5px;font-weight:500;
      color:var(--text2);
      letter-spacing:-.01em;
    }
    .nav-item:hover{background:rgba(255,255,255,.05);color:var(--text);}
    .nav-item.active{
      background:rgba(79,142,247,.12);color:var(--accent);
      box-shadow:inset 0 0 0 1px rgba(79,142,247,.18);
    }
    .nav-item.nav-disabled{opacity:.18;cursor:not-allowed;pointer-events:none;}
    .nav-item .icon{width:17px;text-align:center;font-size:13px;flex-shrink:0;opacity:.75;}
    .nav-item.active .icon{opacity:1;}
    .nav-badge{margin-left:auto;font-family:'Geist Mono',monospace;font-size:9px;padding:2px 7px;border-radius:5px;font-weight:600;}
    .nb-green{background:rgba(15,207,142,.12);color:var(--accent3);}
    .nb-red{background:rgba(240,75,75,.12);color:var(--danger);}
    .nb-amber{background:rgba(244,161,24,.12);color:var(--accent4);}

    .sidebar-footer{padding:10px 10px 12px;border-top:1px solid var(--border);}
    .api-status{
      display:flex;align-items:center;gap:8px;
      padding:8px 12px;
      background:rgba(255,255,255,.025);
      border-radius:9px;border:1px solid var(--border);
    }
    .api-dot{width:7px;height:7px;border-radius:50%;background:var(--danger);flex-shrink:0;}
    .api-dot.ok{background:var(--accent3);animation:pulseG 2.5s ease-in-out infinite;}
    @keyframes pulseG{0%,100%{box-shadow:0 0 0 0 rgba(15,207,142,.5);}50%{box-shadow:0 0 0 5px rgba(15,207,142,0);}}
    .api-label{font-family:'Geist Mono',monospace;font-size:10px;color:var(--text2);}

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh;}

    .topbar{
      padding:0 28px;height:56px;
      background:rgba(5,6,14,.85);
      backdrop-filter:blur(24px);
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:12px;
      position:sticky;top:0;z-index:50;
    }
    .topbar-title{font-size:14.5px;font-weight:600;flex:1;letter-spacing:-.02em;}
    .topbar-title span{color:var(--accent);}
    .content{padding:24px 28px;flex:1;}

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn{
      padding:6px 14px;border-radius:8px;
      font-size:12px;font-weight:500;
      cursor:pointer;border:none;
      font-family:'Geist',sans-serif;
      transition:all .15s;
      letter-spacing:-.01em;
      display:inline-flex;align-items:center;gap:5px;
      white-space:nowrap;
    }
    .btn-primary{
      background:var(--accent);color:#fff;
      box-shadow:0 1px 10px rgba(79,142,247,.25);
    }
    .btn-primary:hover{background:#3d7bf5;box-shadow:0 3px 18px rgba(79,142,247,.4);transform:translateY(-1px);}
    .btn-primary:active{transform:translateY(0);}
    .btn-ghost{
      background:rgba(255,255,255,.04);
      color:var(--text2);
      border:1px solid var(--border);
    }
    .btn-ghost:hover{background:rgba(255,255,255,.07);color:var(--text);border-color:var(--border2);}
    .btn-danger{background:rgba(240,75,75,.1);color:var(--danger);border:1px solid rgba(240,75,75,.2);}
    .btn-danger:hover{background:rgba(240,75,75,.18);transform:translateY(-1px);}
    .btn-success{background:rgba(15,207,142,.1);color:var(--accent3);border:1px solid rgba(15,207,142,.2);}
    .btn-success:hover{background:rgba(15,207,142,.18);transform:translateY(-1px);}
    .btn:disabled{opacity:.3;cursor:not-allowed;transform:none!important;}

    /* ‚îÄ‚îÄ STATUS PILL ‚îÄ‚îÄ */
    .pill{
      display:inline-flex;align-items:center;gap:5px;
      padding:4px 11px;border-radius:20px;
      font-family:'Geist Mono',monospace;font-size:10px;font-weight:500;
    }
    .pill-green{background:rgba(15,207,142,.1);color:var(--accent3);border:1px solid rgba(15,207,142,.2);}
    .pill-red{background:rgba(240,75,75,.1);color:var(--danger);border:1px solid rgba(240,75,75,.2);}
    .pill-amber{background:rgba(244,161,24,.1);color:var(--accent4);border:1px solid rgba(244,161,24,.2);}
    .pdot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
    .pdot-g{background:var(--accent3);animation:pulseG 2.5s ease-in-out infinite;}
    .pdot-r{background:var(--danger);}
    .pdot-a{background:var(--accent4);}

    /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
    .card{
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
      backdrop-filter:blur(12px);
      transition:border-color .2s;
    }
    .card:hover{border-color:var(--border2);}
    .card-header{
      padding:14px 18px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:10px;
    }
    .card-title{font-size:13px;font-weight:600;flex:1;letter-spacing:-.02em;}
    .card-body{padding:18px;}
    .card-footer{padding:12px 18px;border-top:1px solid var(--border);display:flex;align-items:center;gap:8px;background:rgba(0,0,0,.2);}

    /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;}
    @media(max-width:900px){.stats-row{grid-template-columns:repeat(2,1fr);}}
    @media(max-width:500px){.stats-row{grid-template-columns:1fr;}}
    .stat-card{
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:18px 18px 16px;position:relative;overflow:hidden;
      backdrop-filter:blur(12px);
      transition:border-color .2s, transform .2s, box-shadow .2s;
    }
    .stat-card:hover{border-color:rgba(var(--ac-rgb),.3);transform:translateY(-2px);box-shadow:0 8px 32px rgba(var(--ac-rgb),.08);}
    .stat-card::before{
      content:'';position:absolute;inset:0;
      background:linear-gradient(135deg,rgba(var(--ac-rgb),.06) 0%, transparent 55%);
      pointer-events:none;
    }
    .stat-card::after{
      content:'';position:absolute;top:0;left:0;right:0;height:2px;
      background:linear-gradient(90deg,transparent 5%,rgba(var(--ac-rgb),.7) 50%,transparent 95%);
    }
    .stat-card.c1{--ac-rgb:79,142,247}
    .stat-card.c2{--ac-rgb:124,92,252}
    .stat-card.c3{--ac-rgb:15,207,142}
    .stat-card.c4{--ac-rgb:244,161,24}
    .stat-label{font-family:'Geist Mono',monospace;font-size:9px;letter-spacing:.12em;color:var(--text2);text-transform:uppercase;margin-bottom:12px;}
    .stat-value{font-size:30px;font-weight:700;line-height:1;margin-bottom:5px;letter-spacing:-.04em;}
    .stat-sub{font-family:'Geist Mono',monospace;font-size:9px;color:var(--text3);}
    .stat-icon{position:absolute;right:16px;top:16px;font-size:18px;opacity:.12;}

    /* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px;}
    .grid-wide{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:16px;}
    .full{grid-column:1/-1;}
    .mb16{margin-bottom:16px;}
    .mb8{margin-bottom:8px;}
    .mt16{margin-top:16px;}
    .mt8{margin-top:8px;}
    .flex{display:flex;align-items:center;gap:8px;}
    .flex-col{display:flex;flex-direction:column;gap:8px;}
    .mla{margin-left:auto;}

    /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
    .tab-view{display:none;animation:fadeIn .2s ease;}
    .tab-view.active{display:block;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

    /* ‚îÄ‚îÄ SECTION HEAD ‚îÄ‚îÄ */
    .section-head{display:flex;align-items:center;gap:12px;margin-bottom:22px;}
    .section-head h2{font-size:18px;font-weight:700;letter-spacing:-.04em;}
    .section-div{flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent);}

    /* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
    .form-group{margin-bottom:14px;}
    .form-row2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .form-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
    label{
      font-family:'Geist Mono',monospace;
      font-size:9.5px;font-weight:500;
      color:var(--text2);letter-spacing:.09em;
      text-transform:uppercase;display:block;margin-bottom:6px;
    }
    input[type=text],input[type=number],input[type=password],select,textarea{
      width:100%;
      background:rgba(8,10,22,.9);
      border:1px solid var(--border);
      border-radius:8px;
      padding:8px 12px;
      color:var(--text);
      font-family:'Geist Mono',monospace;
      font-size:11.5px;
      outline:none;
      transition:border-color .18s,box-shadow .18s,background .18s;
      appearance:none;
    }
    input[type=text]:hover,input[type=number]:hover,input[type=password]:hover,select:hover{
      border-color:var(--border2);
    }
    input:focus,select:focus,textarea:focus{
      border-color:rgba(79,142,247,.6);
      box-shadow:0 0 0 3px var(--accent-glow);
      background:rgba(10,13,28,.95);
    }
    textarea{resize:vertical;min-height:80px;line-height:1.6;}
    .hint{font-family:'Geist Mono',monospace;font-size:9px;color:var(--text3);margin-top:5px;line-height:1.5;}

    /* ‚îÄ‚îÄ TOGGLE ‚îÄ‚îÄ */
    .toggle-row{display:flex;align-items:center;gap:12px;margin-bottom:12px;padding:3px 0;}
    .toggle-row label{margin-bottom:0;font-size:12.5px;font-weight:400;font-family:'Geist',sans-serif;color:var(--text);text-transform:none;letter-spacing:normal;flex:1;}
    .toggle{
      width:38px;height:21px;
      background:rgba(255,255,255,.07);
      border:1px solid var(--border2);
      border-radius:11px;
      position:relative;cursor:pointer;
      transition:all .22s;flex-shrink:0;
    }
    .toggle.on{background:var(--accent);border-color:var(--accent);box-shadow:0 0 10px rgba(79,142,247,.4);}
    .toggle::after{
      content:'';position:absolute;
      width:15px;height:15px;
      background:white;border-radius:50%;
      top:2px;left:2px;transition:left .22s cubic-bezier(.34,1.56,.64,1);
      box-shadow:0 1px 4px rgba(0,0,0,.5);
    }
    .toggle.on::after{left:19px;}

    /* ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ */
    .badge{
      display:inline-flex;align-items:center;
      padding:2px 8px;border-radius:5px;
      font-family:'Geist Mono',monospace;font-size:9px;font-weight:500;
    }
    .b-cyan{background:rgba(79,142,247,.1);color:var(--accent);}
    .b-purple{background:rgba(124,92,252,.1);color:#a78bfa;}
    .b-green{background:rgba(15,207,142,.1);color:var(--accent3);}
    .b-amber{background:rgba(244,161,24,.1);color:var(--accent4);}
    .b-red{background:rgba(240,75,75,.1);color:var(--danger);}

    /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
    table{width:100%;border-collapse:collapse;}
    th{
      font-family:'Geist Mono',monospace;font-size:9px;letter-spacing:.12em;
      color:var(--text3);text-align:left;
      padding:10px 14px;border-bottom:1px solid var(--border);text-transform:uppercase;
      background:rgba(0,0,0,.2);
    }
    td{padding:11px 14px;border-bottom:1px solid rgba(22,25,41,.7);font-size:12px;vertical-align:middle;}
    tr:last-child td{border-bottom:none;}
    tr:hover td{background:rgba(79,142,247,.025);}

    /* ‚îÄ‚îÄ TERMINAL ‚îÄ‚îÄ */
    .terminal{background:#03040a;border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;}
    .term-bar{
      background:rgba(8,10,20,.95);
      padding:9px 16px;
      display:flex;align-items:center;gap:8px;
      border-bottom:1px solid var(--border);
    }
    .tdot{width:10px;height:10px;border-radius:50%;}
    .term-log{
      padding:16px;
      font-family:'Geist Mono',monospace;font-size:11px;line-height:1.85;
      height:280px;overflow-y:auto;
      scrollbar-width:thin;scrollbar-color:var(--border) transparent;
    }
    .term-log .ts{color:var(--text3);}
    .term-log .inf{color:var(--accent);}
    .term-log .wrn{color:var(--accent4);}
    .term-log .err{color:var(--danger);}
    .term-log .ok{color:var(--accent3);}
    .term-log .raw{color:#93c5fd;}

    /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
    .prog-wrap{margin-bottom:14px;}
    .prog-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
    .prog-label{font-size:12px;font-weight:500;}
    .prog-val{font-family:'Geist Mono',monospace;font-size:10px;color:var(--text2);}
    .prog-bg{height:5px;background:rgba(255,255,255,.05);border-radius:3px;overflow:hidden;}
    .prog-fill{height:100%;border-radius:3px;transition:width .65s cubic-bezier(.4,0,.2,1);}
    .pf-cyan{background:linear-gradient(90deg,var(--accent2),var(--accent));}
    .pf-green{background:linear-gradient(90deg,#059669,var(--accent3));}
    .pf-amber{background:linear-gradient(90deg,#d97706,var(--accent4));}
    .pf-red{background:linear-gradient(90deg,#b91c1c,var(--danger));}

    /* old chart styles removed ‚Äî using canvas now */

    /* ‚îÄ‚îÄ ICON BUTTON ‚îÄ‚îÄ */
    .icn-btn{
      width:28px;height:28px;border-radius:7px;
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      cursor:pointer;display:flex;align-items:center;justify-content:center;
      font-size:12px;color:var(--text2);transition:all .15s;
      flex-shrink:0;
    }
    .icn-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(79,142,247,.08);}
    .icn-btn.d:hover{border-color:var(--danger);color:var(--danger);background:rgba(240,75,75,.08);}

    /* ‚îÄ‚îÄ PORT MAP ‚îÄ‚îÄ */
    .pm-item{
      display:flex;align-items:center;gap:9px;
      padding:10px 14px;
      background:rgba(8,10,22,.7);
      border:1px solid var(--border);border-radius:9px;
      margin-bottom:6px;
      font-family:'Geist Mono',monospace;font-size:10px;
      transition:border-color .15s, background .15s;
    }
    .pm-item:hover{border-color:var(--border2);background:rgba(79,142,247,.04);}

    /* ‚îÄ‚îÄ PROFILE GRID ‚îÄ‚îÄ */
    .prof-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;}
    .prof-card{
      border:1px solid var(--border);border-radius:10px;
      padding:12px 6px;text-align:center;cursor:pointer;
      transition:all .15s;background:rgba(8,10,22,.7);
    }
    .prof-card:hover{border-color:var(--border2);background:rgba(255,255,255,.04);transform:translateY(-1px);}
    .prof-card.sel{border-color:var(--accent);background:rgba(79,142,247,.09);box-shadow:0 0 0 1px rgba(79,142,247,.15);}
    .prof-emoji{font-size:20px;margin-bottom:6px;}
    .prof-name{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;}
    .prof-desc{font-size:8px;color:var(--text2);margin-top:3px;font-family:'Geist Mono',monospace;}

    /* ‚îÄ‚îÄ RANGE ‚îÄ‚îÄ */
    input[type=range]{
      -webkit-appearance:none;width:100%;height:4px;border-radius:2px;
      background:rgba(255,255,255,.07);border:none;outline:none;padding:0;box-shadow:none;
    }
    input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;width:14px;height:14px;border-radius:50%;
      background:var(--accent);cursor:pointer;
      box-shadow:0 0 8px rgba(79,142,247,.5);
      transition:transform .15s;
    }
    input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.2);}
    .range-lbls{display:flex;justify-content:space-between;font-family:'Geist Mono',monospace;font-size:8px;color:var(--text3);margin-top:4px;}

    /* ‚îÄ‚îÄ CONNECTION PATH ‚îÄ‚îÄ */
    .path-item{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:10px;}
    .path-hdr{background:rgba(8,10,22,.7);padding:11px 16px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:background .15s;}
    .path-hdr:hover{background:rgba(79,142,247,.05);}
    .path-num{
      width:22px;height:22px;background:var(--accent);color:#fff;
      border-radius:6px;display:flex;align-items:center;justify-content:center;
      font-size:10px;font-weight:700;flex-shrink:0;
    }
    .path-body{padding:16px;border-top:1px solid var(--border);}

    /* ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ */
    .notif{
      position:fixed;bottom:24px;right:24px;
      background:rgba(10,12,24,.97);
      border:1px solid var(--border2);border-radius:12px;
      padding:12px 18px;display:flex;align-items:center;gap:11px;font-size:12.5px;
      box-shadow:0 16px 50px rgba(0,0,0,.7), 0 0 0 1px rgba(255,255,255,.04);
      transform:translateY(90px) scale(.97);opacity:0;
      transition:all .3s cubic-bezier(.34,1.4,.64,1);
      z-index:1000;max-width:320px;
      backdrop-filter:blur(20px);
    }
    .notif.show{transform:translateY(0) scale(1);opacity:1;}

    /* ‚îÄ‚îÄ ERROR BANNER ‚îÄ‚îÄ */
    .err-banner{
      background:rgba(240,75,75,.07);border:1px solid rgba(240,75,75,.2);
      border-radius:10px;padding:10px 16px;
      font-family:'Geist Mono',monospace;font-size:11px;color:var(--danger);
      margin-bottom:16px;display:none;
      animation:fadeIn .2s ease;
    }
    .err-banner.show{display:flex;align-items:center;gap:8px;}

    /* HR */
    hr{border:none;border-top:1px solid var(--border);margin:18px 0;}

    /* ‚îÄ‚îÄ YAML ‚îÄ‚îÄ */
    #yaml-editor{
      width:100%;min-height:580px;background:#020307;border:none;
      padding:24px;font-family:'Geist Mono',monospace;font-size:11.5px;line-height:2;
      color:#93c5fd;resize:vertical;outline:none;border-radius:0;
    }

    ::-webkit-scrollbar{width:5px;height:5px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
    ::-webkit-scrollbar-thumb:hover{background:#2a2e50;}

    /* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
    #login-screen{
      position:fixed;inset:0;z-index:9999;
      background:var(--bg);
      display:flex;align-items:center;justify-content:center;
      flex-direction:column;
    }
    .login-card{
      background:rgba(10,12,22,.9);
      border:1px solid var(--border2);
      border-radius:18px;
      padding:42px;
      width:400px;max-width:94vw;
      box-shadow:0 40px 100px rgba(0,0,0,.7), 0 0 0 1px rgba(255,255,255,.04);
      position:relative;overflow:hidden;
      backdrop-filter:blur(32px);
      animation:fadeIn .3s ease;
    }
    .login-card::before{
      content:'';position:absolute;top:0;left:0;right:0;height:1px;
      background:linear-gradient(90deg,transparent,var(--accent2),var(--accent),var(--accent3),transparent);
    }
    .login-card::after{
      content:'';position:absolute;
      top:-80px;left:50%;transform:translateX(-50%);
      width:240px;height:160px;
      background:radial-gradient(ellipse,rgba(79,142,247,.1) 0%,transparent 70%);
      pointer-events:none;
    }
    .login-logo{text-align:center;margin-bottom:28px;position:relative;}
    .login-logo .icon{font-size:42px;margin-bottom:10px;display:block;filter:drop-shadow(0 4px 16px rgba(79,142,247,.4));}
    .login-logo h1{font-size:20px;font-weight:700;letter-spacing:-.04em;}
    .login-logo p{font-family:'Geist Mono',monospace;font-size:9.5px;color:var(--accent);letter-spacing:.15em;margin-top:5px;opacity:.75;}
    .login-err{
      background:rgba(240,75,75,.08);border:1px solid rgba(240,75,75,.2);
      border-radius:9px;padding:9px 14px;
      font-family:'Geist Mono',monospace;font-size:11px;color:var(--danger);
      margin-bottom:14px;display:none;
      animation:fadeIn .18s ease;
    }
    .login-err.show{display:block;}
    #login-screen.hidden{display:none;}

    .text-mono{font-family:'Geist Mono',monospace;}
    .text-xs{font-size:10px;} .text-sm{font-size:11px;}
    .text-muted{color:var(--text2);}
    .text-accent{color:var(--accent);} .text-green{color:var(--accent3);}
    .text-danger{color:var(--danger);} .text-amber{color:var(--accent4);}
    .w-full{width:100%;}

    /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
    .modal-ov{
      display:none;position:fixed;inset:0;
      background:rgba(0,0,0,.65);backdrop-filter:blur(8px);
      z-index:500;align-items:center;justify-content:center;
      animation:fadeIn .2s ease;
    }
    .modal-ov.open{display:flex;}
    .modal{
      background:rgba(8,10,20,.97);
      border:1px solid var(--border2);border-radius:16px;
      width:540px;max-width:95vw;max-height:88vh;overflow-y:auto;
      box-shadow:0 32px 100px rgba(0,0,0,.8), 0 0 0 1px rgba(255,255,255,.04);
      backdrop-filter:blur(32px);
      animation:modalIn .22s cubic-bezier(.34,1.4,.64,1);
    }
    @keyframes modalIn{from{transform:scale(.95) translateY(10px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
    .modal-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
    .modal-head h3{font-size:14px;font-weight:600;flex:1;letter-spacing:-.02em;}
    .modal-body{padding:22px;}
    .modal-foot{padding:14px 22px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;background:rgba(0,0,0,.2);}

    /* ‚îÄ‚îÄ HAMBURGER ‚îÄ‚îÄ */
    .hamburger{
      display:none;flex-direction:column;gap:4px;cursor:pointer;
      padding:7px 8px;border-radius:8px;
      border:1px solid var(--border);background:rgba(255,255,255,.04);flex-shrink:0;
    }
    .hamburger span{display:block;width:17px;height:2px;background:var(--text2);border-radius:2px;transition:all .2s;}
    .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:150;}
    .sidebar-overlay.open{display:block;}

    /* ‚îÄ‚îÄ CHART CANVAS ‚îÄ‚îÄ */
    .chart-wrapper{position:relative;margin-bottom:6px;}
    .chart-canvas{width:100%;height:96px;display:block;cursor:crosshair;border-radius:6px;}
    .chart-tooltip{
      position:absolute;
      background:rgba(6,8,18,.98);
      border:1px solid var(--border2);border-radius:9px;
      padding:8px 13px;font-family:'Geist Mono',monospace;font-size:10px;line-height:1.7;
      pointer-events:none;white-space:nowrap;
      box-shadow:0 6px 24px rgba(0,0,0,.8);z-index:30;
      opacity:0;transition:opacity .12s;top:8px;backdrop-filter:blur(10px);
    }
    .chart-range-btn{
      background:transparent;border:none;color:var(--text3);cursor:pointer;
      font-family:'Geist Mono',monospace;font-size:9px;font-weight:600;
      padding:3px 7px;border-radius:4px;transition:all .15s;
    }
    .chart-range-btn:hover{color:var(--text2);}
    .chart-range-btn.active{background:var(--accent);color:#fff;}
    .chart-stats-bar{
      display:flex;gap:14px;padding:7px 18px;border-bottom:1px solid var(--border);
      font-family:'Geist Mono',monospace;font-size:10px;flex-wrap:wrap;align-items:center;
    }

    /* ‚îÄ‚îÄ MOBILE RESPONSIVE ‚îÄ‚îÄ */
    @media(max-width:768px){
      .sidebar{transform:translateX(-100%);transition:transform .28s cubic-bezier(.4,0,.2,1);z-index:200;}
      .sidebar.mob-open{transform:translateX(0);}
      .main{margin-left:0;}
      .topbar{padding:0 14px;gap:8px;}
      .topbar-title{font-size:13.5px;}
      #clock{display:none;}
      .hamburger{display:flex;}
      .topbar-desktop-btns{display:none;}
      .mobile-actions{display:flex!important;}
      .content{padding:14px 16px;}
      .grid2,.grid3,.grid-wide{grid-template-columns:1fr!important;}
      .form-row2,.form-row3{grid-template-columns:1fr!important;}
      .stats-row{grid-template-columns:1fr 1fr!important;gap:10px;}
      .prof-grid{grid-template-columns:repeat(2,1fr)!important;}
      .section-head{flex-wrap:wrap;gap:8px;}
      .section-div{display:none;}
      #yaml-editor{min-height:320px;font-size:10px;}
      .notif{right:12px;left:12px;max-width:none;bottom:16px;}
      table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch;}
      .card-footer{flex-wrap:wrap;gap:6px;}
      .topbar-title span{display:inline;}
    }
    @media(max-width:420px){
      .stats-row{grid-template-columns:1fr!important;}
      .stat-value{font-size:24px;}
      .login-card{padding:24px;}
    }
  </style>
</head>
<body>


<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo"><div class="icon">üó°Ô∏è</div><h1>DaggerConnect</h1><p>CONTROL PANEL</p></div>
    <div class="login-err" id="login-err">Invalid token ‚Äî check start.sh output</div>
    <div class="form-group"><label>Auth Token</label><input type="password" id="login-token" placeholder="Paste token from start.sh‚Ä¶" onkeydown="if(event.key==='Enter')doLogin()"><div class="hint">Token printed by: sudo ./start.sh</div></div>
    <button class="btn btn-primary w-full mt16" onclick="doLogin()" style="justify-content:center;padding:11px">Unlock Panel</button>
    <div style="margin-top:18px;text-align:center"><span class="text-mono text-xs text-muted">Leave blank if no token is configured.</span></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
<div class="sidebar">
  <div class="logo">
    <div class="logo-icon">üó°Ô∏è</div>
    <div>
      <div class="logo-text">DaggerConnect</div>
      <div class="logo-sub" id="ver-label">PANEL v1.0.0</div>
    </div>
  </div>

  <nav class="nav">
    <div class="nav-label">Overview</div>
    <div class="nav-item active" role="button" tabindex="0" aria-label="Dashboard" onclick="switchTab('dashboard')" onkeydown="if(event.key==='Enter'||event.key===' ')switchTab('dashboard')"><span class="icon">üìä</span> Dashboard <span class="nav-badge nb-green" id="nb-live">Live</span></div>
    <div class="nav-item" role="button" tabindex="0" aria-label="Services" onclick="switchTab('services')" onkeydown="if(event.key==='Enter'||event.key===' ')switchTab('services')"><span class="icon">‚öôÔ∏è</span> Services</div>
    <div class="nav-item" role="button" tabindex="0" aria-label="Live Logs" onclick="switchTab('logs')" onkeydown="if(event.key==='Enter'||event.key===' ')switchTab('logs')"><span class="icon">üìã</span> Live Logs</div>

    <div class="nav-label">Setup</div>
    <div class="nav-item" role="button" tabindex="0" aria-label="Config Wizard" onclick="openWizard()" onkeydown="if(event.key==='Enter'||event.key===' ')openWizard()"><span class="icon">üßô</span> Config Wizard</div>

    <div class="nav-label">Configuration</div>
    <div class="nav-item" id="nav-server" role="button" tabindex="0" aria-label="Server Config" onclick="switchTab('server')" onkeydown="if(event.key==='Enter'||event.key===' ')switchTab('server')"><span class="icon">üñ•Ô∏è</span> Server Config</div>
    <div class="nav-item" id="nav-client" role="button" tabindex="0" aria-label="Client Config" onclick="switchTab('client')" onkeydown="if(event.key==='Enter'||event.key===' ')switchTab('client')"><span class="icon">üíª</span> Client Config</div>
    <div class="nav-item" id="nav-ports" role="button" tabindex="0" aria-label="Port Map Monitor" onclick="switchTab('ports')" onkeydown="if(event.key==='Enter'||event.key===' ')switchTab('ports')"><span class="icon">üîå</span> Port Map Monitor</div>

    <div class="nav-label">Advanced</div>
    <div class="nav-item" role="button" tabindex="0" aria-label="Transport Protocols" onclick="switchTab('transport')" onkeydown="if(event.key==='Enter'||event.key===' ')switchTab('transport')"><span class="icon">üåê</span> Transport / HTTP Mimic</div>
    <div class="nav-item" role="button" tabindex="0" aria-label="Obfuscation" onclick="switchTab('obfuscation')" onkeydown="if(event.key==='Enter'||event.key===' ')switchTab('obfuscation')"><span class="icon">üé≠</span> Obfuscation</div>
    <div class="nav-item" role="button" tabindex="0" aria-label="Security TLS" onclick="switchTab('security')" onkeydown="if(event.key==='Enter'||event.key===' ')switchTab('security')"><span class="icon">üîí</span> Security / TLS</div>

    <div class="nav-label">Tools</div>
    <div class="nav-item" role="button" tabindex="0" aria-label="Active Connections" onclick="switchTab('connections')" onkeydown="if(event.key==='Enter'||event.key===' ')switchTab('connections')"><span class="icon">üîó</span> Active Connections</div>
    <div class="nav-item" role="button" tabindex="0" aria-label="YAML Editor" onclick="switchTab('yaml')" onkeydown="if(event.key==='Enter'||event.key===' ')switchTab('yaml')"><span class="icon">üìÑ</span> YAML Editor</div>
  </nav>

  <div class="sidebar-footer">
    <div class="api-status" style="margin-bottom:8px">
      <div class="api-dot" id="api-dot"></div>
      <span class="api-label" id="api-label">API: connecting‚Ä¶</span>
      <span class="text-mono text-xs text-muted mla" id="api-port">:7070</span>
    </div>
    <div style="display:flex;align-items:center;gap:8px;padding:7px 11px;background:rgba(255,255,255,.03);border-radius:8px;border:1px solid var(--border);margin-top:6px;">
      <span style="font-size:11px;color:var(--text2);font-family:'Geist',sans-serif;">Node:</span>
      <span id="role-badge" class="badge b-cyan" style="cursor:pointer;font-size:10px" title="Click to change role" onclick="promptRoleChange()">‚Äî</span>
      <span class="text-mono text-xs text-muted mla" style="cursor:pointer;font-size:9px;color:var(--text3)" onclick="promptRoleChange()">change</span>
    </div>
  </div>
</div>

<!-- Sidebar overlay for mobile -->
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<div class="main">
  <div class="topbar">
    <div class="hamburger" onclick="toggleSidebar()" aria-label="Menu">
      <span></span><span></span><span></span>
    </div>
    <div class="topbar-title"><span>Dagger</span>Connect</div>
    <div id="global-pill" class="pill pill-amber"><div class="pdot pdot-a"></div> Connecting‚Ä¶</div>
    <span class="text-mono text-xs text-muted topbar-desktop-btns" id="clock"></span>
    <button class="btn btn-ghost topbar-desktop-btns" onclick="reloadAll()">‚Ü∫ Refresh</button>
    <button class="btn btn-danger topbar-desktop-btns" onclick="confirmAndStop()">&#x25a0; Stop All</button>
    <button class="btn btn-primary topbar-desktop-btns" onclick="confirmAndStart()">‚ñ∂ Start All</button>
    <!-- Mobile quick actions -->
    <div style="margin-left:auto;display:none" class="mobile-actions" id="mobile-actions">
      <button class="btn btn-ghost" style="padding:6px 10px;font-size:11px" onclick="toggleMobileMenu()" aria-label="Actions">‚ãÆ</button>
    </div>
    <div class="mobile-menu" id="mobile-menu" style="display:none;position:absolute;top:56px;right:12px;background:rgba(8,10,20,.98);border:1px solid var(--border2);border-radius:12px;padding:8px;z-index:200;min-width:160px;box-shadow:0 8px 32px rgba(0,0,0,.8)">
      <div onclick="reloadAll();toggleMobileMenu()" style="padding:8px 12px;cursor:pointer;font-size:12px;border-radius:6px;color:var(--text2)" onmouseover="this.style.background='rgba(255,255,255,.05)'" onmouseout="this.style.background=''">‚Ü∫ Refresh</div>
      <div onclick="confirmAndStart();toggleMobileMenu()" style="padding:8px 12px;cursor:pointer;font-size:12px;border-radius:6px;color:var(--accent3)" onmouseover="this.style.background='rgba(255,255,255,.05)'" onmouseout="this.style.background=''">‚ñ∂ Start All</div>
      <div onclick="confirmAndStop();toggleMobileMenu()" style="padding:8px 12px;cursor:pointer;font-size:12px;border-radius:6px;color:var(--danger)" onmouseover="this.style.background='rgba(255,255,255,.05)'" onmouseout="this.style.background=''">‚ñ† Stop All</div>
    </div>
  </div>

  <div class="content">

    <!-- Error banner -->
    <div class="err-banner" id="err-banner">‚ö† Cannot reach API ‚Äî make sure <code>start.sh</code> is running on this server.</div>

    <!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
    <div class="tab-view active" id="tab-dashboard">
      <div class="section-head">
        <h2>Dashboard</h2>
        <div class="section-div"></div>
        <span class="text-mono text-xs text-muted" id="last-update">Never updated</span>
      </div>

      <div class="stats-row">
        <div class="stat-card c1">
          <div class="stat-label">Download</div>
          <div class="stat-value text-accent" id="stat-dl">‚Äî</div>
          <div class="stat-sub" id="stat-dl-sub">Mbps ‚Üì</div>
          <div class="stat-icon">‚¨áÔ∏è</div>
          <div id="stat-dl-trend" style="position:absolute;bottom:14px;right:14px;font-size:10px;font-family:'Geist Mono',monospace;opacity:.7"></div>
        </div>
        <div class="stat-card c3">
          <div class="stat-label">Upload</div>
          <div class="stat-value text-green" id="stat-ul">‚Äî</div>
          <div class="stat-sub" id="stat-ul-sub">Mbps ‚Üë</div>
          <div class="stat-icon">‚¨ÜÔ∏è</div>
          <div id="stat-ul-trend" style="position:absolute;bottom:14px;right:14px;font-size:10px;font-family:'Geist Mono',monospace;opacity:.7"></div>
        </div>
        <div class="stat-card c4">
          <div class="stat-label">Connections</div>
          <div class="stat-value text-amber" id="stat-conns">‚Äî</div>
          <div class="stat-sub">Active TCP</div>
          <div class="stat-icon">üîó</div>
          <div id="stat-conns-trend" style="position:absolute;bottom:14px;right:14px;font-size:10px;font-family:'Geist Mono',monospace;opacity:.7"></div>
        </div>
        <div class="stat-card c2">
          <div class="stat-label">System CPU</div>
          <div class="stat-value" id="stat-cpu">‚Äî</div>
          <div class="stat-sub">% utilisation</div>
          <div class="stat-icon">üíª</div>
          <div id="stat-cpu-trend" style="position:absolute;bottom:14px;right:14px;font-size:10px;font-family:'Geist Mono',monospace;opacity:.7"></div>
        </div>
      </div>

      <div class="grid-wide">
        <div class="card">
          <div class="card-header">
            <span>üìà</span><span class="card-title">Network Traffic</span>
            <div style="margin-left:auto;display:flex;align-items:center;gap:6px">
              <div style="display:flex;gap:2px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:2px">
                <button class="chart-range-btn active" data-range="12" onclick="setChartRange(12,this)">1m</button>
                <button class="chart-range-btn" data-range="60" onclick="setChartRange(60,this)">5m</button>
                <button class="chart-range-btn" data-range="720" onclick="setChartRange(720,this)">1h</button>
                <button class="chart-range-btn" data-range="2880" onclick="setChartRange(2880,this)">4h</button>
              </div>
              <button class="btn btn-ghost" style="font-size:9px;padding:3px 8px" onclick="toggleCombinedChart(this)">‚äï Combined</button>
            </div>
          </div>
          <!-- Stats summary row -->
          <div id="net-stats-row" style="display:flex;gap:16px;padding:8px 18px;border-bottom:1px solid var(--border);font-family:'Geist Mono',monospace;font-size:10px;flex-wrap:wrap">
            <span>‚Üì <span id="net-dl-avg" style="color:var(--accent)">‚Äî</span> avg</span>
            <span>‚Üì <span id="net-dl-peak" style="color:var(--accent)">‚Äî</span> peak</span>
            <span>‚Üë <span id="net-ul-avg" style="color:var(--accent3)">‚Äî</span> avg</span>
            <span>‚Üë <span id="net-ul-peak" style="color:var(--accent3)">‚Äî</span> peak</span>
            <span style="color:var(--text3);margin-left:auto" id="net-range-label">last 1m</span>
          </div>
          <div class="card-body">
            <div id="chart-combined-wrapper" style="display:none">
              <div class="chart-wrapper">
                <canvas id="chart-combined" class="chart-canvas" height="120"></canvas>
                <div class="chart-tooltip" id="tooltip-combined"></div>
              </div>
            </div>
            <div id="chart-split-wrapper">
              <div class="chart-wrapper">
                <canvas id="chart-dl" class="chart-canvas" height="90"></canvas>
                <div class="chart-tooltip" id="tooltip-dl"></div>
              </div>
              <div class="chart-wrapper" style="margin-top:10px">
                <canvas id="chart-ul" class="chart-canvas" height="90"></canvas>
                <div class="chart-tooltip" id="tooltip-ul"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex-col" style="gap:16px">
          <div class="card">
            <div class="card-header"><span>‚öôÔ∏è</span><span class="card-title">Services</span></div>
            <div class="card-body" id="svc-summary" style="padding:14px">
              <div class="text-muted text-sm text-mono">Loading‚Ä¶</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><span>üíª</span><span class="card-title">Resources</span>
              <div style="margin-left:auto;display:flex;gap:2px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:2px">
                <button class="chart-range-btn active" data-range="12" onclick="setResRange(12,this)">1m</button>
                <button class="chart-range-btn" data-range="60" onclick="setResRange(60,this)">5m</button>
                <button class="chart-range-btn" data-range="720" onclick="setResRange(720,this)">1h</button>
                <button class="chart-range-btn" data-range="2880" onclick="setResRange(2880,this)">4h</button>
              </div>
            </div>
            <div class="card-body">
              <div class="prog-wrap">
                <div class="prog-head"><span class="prog-label">System CPU</span><span class="prog-val" id="sys-cpu-val">‚Äî</span></div>
                <div class="prog-bg"><div class="prog-fill pf-cyan" id="sys-cpu-bar" style="width:0%"></div></div>
              </div>
              <div style="display:flex;gap:10px;margin:4px 0 8px;font-family:'Geist Mono',monospace;font-size:9px;color:var(--text3)">
                <span>avg <span id="cpu-avg-val" style="color:var(--accent)">‚Äî</span></span>
                <span>peak <span id="cpu-peak-val" style="color:var(--accent4)">‚Äî</span></span>
                <span>min <span id="cpu-min-val" style="color:var(--text2)">‚Äî</span></span>
              </div>
              <div class="chart-wrapper" style="margin-bottom:12px">
                <canvas id="chart-cpu" class="chart-canvas" height="60"></canvas>
                <div class="chart-tooltip" id="tooltip-cpu"></div>
              </div>
              <div class="prog-wrap">
                <div class="prog-head"><span class="prog-label">RAM Used</span><span class="prog-val" id="sys-ram-val">‚Äî</span></div>
                <div class="prog-bg"><div class="prog-fill pf-green" id="sys-ram-bar" style="width:0%"></div></div>
              </div>
              <div style="display:flex;gap:10px;margin:4px 0 8px;font-family:'Geist Mono',monospace;font-size:9px;color:var(--text3)">
                <span>avg <span id="ram-avg-val" style="color:var(--accent3)">‚Äî</span></span>
                <span>peak <span id="ram-peak-val" style="color:var(--accent4)">‚Äî</span></span>
                <span>min <span id="ram-min-val" style="color:var(--text2)">‚Äî</span></span>
              </div>
              <div class="chart-wrapper" style="margin-bottom:12px">
                <canvas id="chart-ram" class="chart-canvas" height="60"></canvas>
                <div class="chart-tooltip" id="tooltip-ram"></div>
              </div>
              <div class="prog-wrap">
                <div class="prog-head"><span class="prog-label">Server Process</span><span class="prog-val" id="srv-cpu-val">‚Äî</span></div>
                <div class="prog-bg"><div class="prog-fill pf-amber" id="srv-cpu-bar" style="width:0%"></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>


    </div>

    <!-- ‚îÄ‚îÄ SERVICES ‚îÄ‚îÄ -->
    <div class="tab-view" id="tab-services">
      <div class="section-head">
        <h2>Services</h2>
        <div class="section-div"></div>
        <button class="btn btn-ghost" onclick="loadStatus()">‚Ü∫ Refresh</button>
      </div>

      <div id="services-cards">
        <div class="text-muted text-mono text-sm">Loading service status‚Ä¶</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ LOGS ‚îÄ‚îÄ -->
    <div class="tab-view" id="tab-logs">
      <div class="section-head">
        <h2>Live Logs</h2>
        <div class="section-div"></div>
        <button class="btn btn-ghost" onclick="clearLogs()">Clear</button>
        <button class="btn btn-ghost" onclick="downloadLogs()">‚¨á Export</button>
      </div>

      <div class="flex mb16">
        <select id="log-svc" style="width:180px">
          <option value="server">Server</option>
          <option value="client">Client</option>
        </select>
        <select id="log-lines" style="width:120px">
          <option value="50">50 lines</option>
          <option value="100" selected>100 lines</option>
          <option value="200">200 lines</option>
          <option value="500">500 lines</option>
        </select>
        <input type="text" id="log-filter" placeholder="Filter logs‚Ä¶" style="flex:1;min-width:100px;max-width:220px" oninput="filterLogs()">
        <select id="log-level-filter" style="width:110px">
          <option value="">All levels</option>
          <option value="ERROR">ERROR</option>
          <option value="WARN">WARN</option>
          <option value="INFO">INFO</option>
        </select>
        <button class="btn btn-primary mla" onclick="fetchLogs()">Fetch Logs</button>
        <button class="btn btn-ghost" id="autopoll-btn" onclick="toggleLogPoll()">‚ñ∂ Auto-poll (5s)</button>
      </div>
      <div id="log-stream-indicator" style="display:none;margin-bottom:8px;padding:6px 12px;background:rgba(15,207,142,.08);border:1px solid rgba(15,207,142,.2);border-radius:8px;font-family:'Geist Mono',monospace;font-size:10px;color:var(--accent3);align-items:center;gap:8px">
        <div class="pdot pdot-g"></div> Live polling active ‚Äî updates every 5s
        <button class="btn btn-ghost mla" style="padding:3px 8px;font-size:9px" onclick="toggleLogPoll()">Stop</button>
      </div>

      <div class="terminal">
        <div class="term-bar">
          <div class="tdot" style="background:#ef4444"></div>
          <div class="tdot" style="background:#f59e0b;margin-left:4px"></div>
          <div class="tdot" style="background:#10b981;margin-left:4px"></div>
          <span class="text-mono text-xs text-muted" style="margin-left:12px" id="log-title">DaggerConnect ‚Äî Logs</span>
        </div>
        <div class="term-log" id="log-output"><span class="text-muted">Press "Fetch Logs" or enable auto-poll.</span></div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ SERVER CONFIG ‚îÄ‚îÄ -->
    <div class="tab-view" id="tab-server">
      <div class="section-head">
        <h2>Server Config</h2>
        <div class="section-div"></div>
        <button class="btn btn-ghost" onclick="loadConfig('server')">‚Ü∫ Load from disk</button>
        <button class="btn btn-primary" onclick="saveAndRestart('server')">üìù Preview in YAML Editor</button>
      </div>

      <div class="card mb16">
        <div class="card-header">
          <span>üì°</span><span class="card-title">Listeners</span>
          <span class="badge b-cyan mla" style="font-size:8px">Multi-listener supported</span>
          <button class="btn btn-ghost" style="margin-left:8px;font-size:10px;padding:4px 8px" onclick="addListener()">+ Add Listener</button>
        </div>
        <div class="card-body" id="listeners-container" style="padding:14px;display:flex;flex-direction:column;gap:14px">
          <!-- listeners rendered by JS -->
        </div>
      </div>

      <div class="grid-wide">
        <div class="flex-col" style="gap:16px">
          <div class="card">
            <div class="card-header"><span>üåê</span><span class="card-title">Global Settings</span></div>
            <div class="card-body">
              <div class="form-group">
                <label>Pre-Shared Key (PSK)</label>
                <div class="flex">
                  <input type="password" id="srv-psk" value="" style="border-radius:8px 0 0 8px;flex:1">
                  <button class="btn btn-ghost" onclick="toggleInput('srv-psk')" style="border-radius:0 8px 8px 0;border-left:none">üëÅ</button>
                </div>
                <div class="hint">PSK = your license key. Buy: <a href="https://t.me/DaggerConnectBot" target="_blank" style="color:var(--accent)">@DaggerConnectBot</a></div>
              </div>
              <div class="toggle-row">
                <label>Verbose Logging</label>
                <div class="toggle" id="srv-verbose" onclick="this.classList.toggle('on')"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><span>üéØ</span><span class="card-title">Performance Profile</span></div>
            <div class="card-body">
              <input type="hidden" id="srv-profile" value="balanced">
              <div class="prof-grid">
                <div class="prof-card sel" onclick="selProfile(this,'balanced')"><div class="prof-emoji">‚öñÔ∏è</div><div class="prof-name">Balanced</div><div class="prof-desc">Default</div></div>
                <div class="prof-card" onclick="selProfile(this,'aggressive')"><div class="prof-emoji">‚ö°</div><div class="prof-name">Aggressive</div><div class="prof-desc">Max speed</div></div>
                <div class="prof-card" onclick="selProfile(this,'latency')"><div class="prof-emoji">üéØ</div><div class="prof-name">Latency</div><div class="prof-desc">Low ping</div></div>
                <div class="prof-card" onclick="selProfile(this,'cpu-efficient')"><div class="prof-emoji">üê¢</div><div class="prof-name">CPU Eff.</div><div class="prof-desc">Save CPU</div></div>
                <div class="prof-card" onclick="selProfile(this,'gaming')"><div class="prof-emoji">üéÆ</div><div class="prof-name">Gaming</div><div class="prof-desc">Real-time</div></div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex-col" style="gap:16px">
          <div class="card">
            <div class="card-header"><span>üîß</span><span class="card-title">SMUX / Advanced TCP</span></div>
            <div class="card-body">
              <div class="form-row2">
                <div class="form-group"><label>SMUX KeepAlive (s)</label><input type="number" id="smux-ka" value="5"></div>
                <div class="form-group"><label>Frame Size</label><input type="number" id="smux-frame" value="32768"></div>
              </div>
              <div class="form-group"><label>Max Recv Buffer</label>
                <input type="range" min="1048576" max="33554432" value="16777216" id="smux-recv" oninput="document.getElementById('smux-recv-lbl').textContent=Math.round(this.value/1048576)+'MB'">
                <div class="range-lbls"><span>1MB</span><span id="smux-recv-lbl">16MB</span><span>32MB</span></div>
              </div>
              <hr>
              <div class="toggle-row"><label>TCP NoDelay</label><div class="toggle on" id="tcp-nodelay" onclick="this.classList.toggle('on')"></div></div>
              <div class="form-row2">
                <div class="form-group"><label>TCP KeepAlive (s)</label><input type="number" id="tcp-ka" value="15"></div>
                <div class="form-group"><label>Max Connections</label><input type="number" id="max-conn" value="5000"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><span>üé≠</span><span class="card-title">HTTP Mimicry</span></div>
            <div class="card-body">
              <div class="form-group">
                <label>Fake Domain</label>
                <select id="mimic-domain">
                  <option>www.google.com</option>
                  <option>www.cloudflare.com</option>
                  <option>api.github.com</option>
                  <option>www.microsoft.com</option>
                </select>
              </div>
              <div class="form-group"><label>Fake Path</label><input type="text" id="mimic-path" value="/search"></div>
              <div class="toggle-row"><label>Chunked Encoding</label><div class="toggle on" id="mimic-chunked" onclick="this.classList.toggle('on')"></div></div>
              <div class="toggle-row"><label>Session Cookies</label><div class="toggle on" id="mimic-cookies" onclick="this.classList.toggle('on')"></div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ CLIENT CONFIG ‚îÄ‚îÄ -->
    <div class="tab-view" id="tab-client">
      <div class="section-head">
        <h2>Client Config</h2>
        <div class="section-div"></div>
        <button class="btn btn-ghost" onclick="loadConfig('client')">‚Ü∫ Load</button>
        <button class="btn btn-primary" onclick="saveAndRestart('client')">üìù Preview in YAML Editor</button>
      </div>

      <div class="grid-wide">
        <div>
          <div class="card mb16">
            <div class="card-header"><span>üîê</span><span class="card-title">Connection Settings</span></div>
            <div class="card-body">
              <div class="form-group">
                <label>Pre-Shared Key (PSK)</label>
                <div class="flex">
                  <input type="password" id="cli-psk" value="" style="border-radius:8px 0 0 8px;flex:1">
                  <button class="btn btn-ghost" onclick="toggleInput('cli-psk')" style="border-radius:0;border-left:none">üëÅ</button>
                </div>
                <div class="hint">Must match server PSK exactly. Buy: <a href="https://t.me/DaggerConnectBot" target="_blank" style="color:var(--accent)">@DaggerConnectBot</a></div>
              </div>
              <div class="form-group">
                <label>Performance Profile</label>
                <select id="cli-profile">
                  <option value="balanced">balanced</option>
                  <option value="aggressive">aggressive</option>
                  <option value="latency">latency</option>
                  <option value="cpu-efficient">cpu-efficient</option>
                  <option value="gaming">gaming</option>
                </select>
              </div>
              <div class="toggle-row"><label>Verbose Logging</label><div class="toggle" id="cli-verbose" onclick="this.classList.toggle('on')"></div></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><span>üõ£Ô∏è</span><span class="card-title">Connection Paths</span>
              <button class="btn btn-ghost mla" style="font-size:10px;padding:4px 8px" onclick="addClientPath()">+ Add</button>
            </div>
            <div class="card-body" id="client-paths"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><span>üìä</span><span class="card-title">Pool Size Guide</span></div>
          <div class="card-body" style="padding:0">
            <table>
              <thead><tr><th>Network</th><th>Pool</th><th>Aggressive</th></tr></thead>
              <tbody>
              <tr><td class="text-sm">Stable</td><td class="text-accent text-mono text-sm">2‚Äì3</td><td class="text-green text-mono text-sm">false</td></tr>
              <tr><td class="text-sm">Normal</td><td class="text-accent text-mono text-sm">3‚Äì4</td><td class="text-green text-mono text-sm">true</td></tr>
              <tr><td class="text-sm">Unstable</td><td class="text-accent text-mono text-sm">4‚Äì6</td><td class="text-green text-mono text-sm">true</td></tr>
              <tr><td class="text-sm">High Load</td><td class="text-accent text-mono text-sm">6‚Äì8</td><td class="text-green text-mono text-sm">true</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PORT MAPPINGS ‚îÄ‚îÄ -->
    <div class="tab-view" id="tab-ports">
      <div class="section-head">
        <h2>Port Map Monitor</h2>
        <div class="section-div"></div>
        <button class="btn btn-ghost" onclick="loadPortMaps()">‚Ü∫ Refresh</button>
        <button class="btn btn-primary" onclick="switchTab('server')">‚úèÔ∏è Edit Listeners</button>
      </div>

      <!-- Info banner -->
      <div style="display:flex;align-items:flex-start;gap:12px;padding:12px 16px;background:rgba(79,142,247,.07);border:1px solid rgba(79,142,247,.18);border-radius:10px;margin-bottom:16px;font-size:11px;line-height:1.6;color:var(--text2)">
        <span style="font-size:18px;flex-shrink:0">‚ÑπÔ∏è</span>
        <div>
          <strong style="color:var(--text)">Read-only view.</strong> Port maps now live inside each <strong>Listener</strong> in your server config.
          To add, edit or remove mappings, go to <strong>Server Config ‚Üí Listeners</strong> and use the YAML editor.
          This tab shows all active maps aggregated across all listeners from the current <code>server.yaml</code>.
        </div>
      </div>

      <div class="card">
        <div class="card-body" style="padding:0">
          <table>
            <thead><tr><th>#</th><th>Protocol</th><th>Bind</th><th></th><th>Target</th><th>Transport</th><th>Listener</th><th>Status</th></tr></thead>
            <tbody id="port-table"><tr><td colspan="8" class="text-muted text-sm text-mono" style="padding:16px">Loading‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TRANSPORT ‚îÄ‚îÄ -->
    <div class="tab-view" id="tab-transport">
      <div class="section-head">
        <h2>Transport Protocols</h2>
        <div class="section-div"></div>
        <select id="transport-selector" style="width:200px;font-size:12px" onchange="showTransportPanel(this.value)">
          <option value="httpsmux">httpsmux ‚≠ê  ‚Äî HTTPS Mimicry</option>
          <option value="httpmux">httpmux  ‚Äî HTTP Mimicry</option>
          <option value="wssmux">wssmux  ‚Äî WebSocket + TLS</option>
          <option value="wsmux">wsmux  ‚Äî WebSocket</option>
          <option value="kcpmux">kcpmux  ‚Äî KCP (UDP)</option>
          <option value="tcpmux">tcpmux  ‚Äî TCP Mux</option>
          <option value="rawmux">rawmux  ‚Äî Raw TCP</option>
          <option value="daggermux">daggermux ‚ö° ‚Äî pcap/KCP</option>
        </select>
        <button class="btn btn-primary" style="margin-left:8px" onclick="previewTransportYaml()">üìù Preview in YAML Editor</button>
      </div>

      <!-- ‚îÄ‚îÄ COMPARISON TABLE ‚îÄ‚îÄ -->
      <div class="card mb16">
        <div class="card-header"><span>üìä</span><span class="card-title">Protocol Comparison</span></div>
        <div class="card-body" style="padding:0">
          <table>
            <thead><tr><th>Protocol</th><th>Port</th><th>DPI Bypass</th><th>Latency</th><th>Throughput</th><th>Root?</th><th>Best For</th><th></th></tr></thead>
            <tbody>
            <tr id="trow-httpsmux"><td><span class="badge b-cyan">httpsmux ‚≠ê</span></td><td class="text-mono text-sm">443/TCP</td><td class="text-sm">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</td><td class="text-mono text-sm">~25ms</td><td class="text-mono text-sm">700 Mbps</td><td class="text-muted text-sm">No</td><td class="text-muted text-sm">Default ‚Äî HTTPS+TLS mimicry</td><td><button class="btn btn-ghost" style="font-size:9px;padding:3px 7px" onclick="selectTransport('httpsmux')">Select</button></td></tr>
            <tr id="trow-httpmux"><td><span class="badge b-purple">httpmux</span></td><td class="text-mono text-sm">80/TCP</td><td class="text-sm">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</td><td class="text-mono text-sm">~20ms</td><td class="text-mono text-sm">750 Mbps</td><td class="text-muted text-sm">No</td><td class="text-muted text-sm">HTTP mimicry, no TLS</td><td><button class="btn btn-ghost" style="font-size:9px;padding:3px 7px" onclick="selectTransport('httpmux')">Select</button></td></tr>
            <tr id="trow-wssmux"><td><span class="badge b-cyan">wssmux</span></td><td class="text-mono text-sm">443/TCP</td><td class="text-sm">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</td><td class="text-mono text-sm">~20ms</td><td class="text-mono text-sm">750 Mbps</td><td class="text-muted text-sm">No</td><td class="text-muted text-sm">WebSocket + TLS</td><td><button class="btn btn-ghost" style="font-size:9px;padding:3px 7px" onclick="selectTransport('wssmux')">Select</button></td></tr>
            <tr id="trow-wsmux"><td><span class="badge b-purple">wsmux</span></td><td class="text-mono text-sm">80/TCP</td><td class="text-sm">‚≠ê‚≠ê‚≠ê</td><td class="text-mono text-sm">~18ms</td><td class="text-mono text-sm">780 Mbps</td><td class="text-muted text-sm">No</td><td class="text-muted text-sm">WebSocket, no TLS</td><td><button class="btn btn-ghost" style="font-size:9px;padding:3px 7px" onclick="selectTransport('wsmux')">Select</button></td></tr>
            <tr id="trow-kcpmux"><td><span class="badge b-amber">kcpmux</span></td><td class="text-mono text-sm">Any/UDP</td><td class="text-sm">‚≠ê‚≠ê‚≠ê</td><td class="text-mono text-sm">~12ms</td><td class="text-mono text-sm">920 Mbps</td><td class="text-muted text-sm">No</td><td class="text-muted text-sm">Gaming / high-speed UDP</td><td><button class="btn btn-ghost" style="font-size:9px;padding:3px 7px" onclick="selectTransport('kcpmux')">Select</button></td></tr>
            <tr id="trow-tcpmux"><td><span class="badge b-green">tcpmux</span></td><td class="text-mono text-sm">Any/TCP</td><td class="text-sm">‚≠ê‚≠ê</td><td class="text-mono text-sm">~15ms</td><td class="text-mono text-sm">850 Mbps</td><td class="text-muted text-sm">No</td><td class="text-muted text-sm">Simple stable networks</td><td><button class="btn btn-ghost" style="font-size:9px;padding:3px 7px" onclick="selectTransport('tcpmux')">Select</button></td></tr>
            <tr id="trow-rawmux"><td><span class="badge b-red">rawmux</span></td><td class="text-mono text-sm">Any/TCP</td><td class="text-sm">‚≠ê‚≠ê</td><td class="text-mono text-sm">~10ms</td><td class="text-mono text-sm">980 Mbps</td><td class="text-muted text-sm">No</td><td class="text-muted text-sm">Max speed, no DPI concern</td><td><button class="btn btn-ghost" style="font-size:9px;padding:3px 7px" onclick="selectTransport('rawmux')">Select</button></td></tr>
            <tr id="trow-daggermux" style="background:rgba(124,58,237,.05)"><td><span class="badge b-purple">daggermux ‚ö°</span></td><td class="text-mono text-sm">Any/TCP</td><td class="text-sm text-green" style="color:var(--accent3)">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</td><td class="text-mono text-sm">~8ms</td><td class="text-mono text-sm">KCP-based</td><td style="color:var(--danger);font-size:11px;font-weight:700">YES</td><td class="text-muted text-sm">Hardest DPI bypass (pcap)</td><td><button class="btn btn-ghost" style="font-size:9px;padding:3px 7px" onclick="selectTransport('daggermux')">Select</button></td></tr>
            </tbody>
          </table>
          <div style="padding:8px 14px;border-top:1px solid var(--border);font-family:'Geist Mono',monospace;font-size:9px;color:var(--text3)">
            üîµ httpsmux = default for most users &nbsp;¬∑&nbsp; üî¥ daggermux = when all other methods are filtered
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           TRANSPORT PANELS
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

      <!-- HTTP / WebSocket Mimic (httpsmux / httpmux / wssmux / wsmux) -->
      <div id="tpanel-mimic" class="card mb16" style="display:none">
        <div class="card-header">
          <span>üåê</span>
          <span class="card-title">HTTP Mimic Settings</span>
          <span id="tpanel-mimic-badge" class="badge b-cyan mla">httpsmux</span>
          <span id="tpanel-tls-note" class="badge b-green" style="margin-left:6px;font-size:9px">TLS enabled</span>
        </div>
        <div class="card-body">
          <div class="hint mb16">Disguises your tunnel as legitimate browser traffic. Fake domain is used as the HTTP <code>Host</code> header / TLS SNI.</div>
          <div class="form-row2">
            <div class="form-group">
              <label>Fake Domain (Host / SNI)</label>
              <select id="mimic-domain" onchange="document.getElementById('mimic-custom-row').style.display=this.value==='custom'?'':'none'">
                <option value="www.google.com">www.google.com</option>
                <option value="www.cloudflare.com">www.cloudflare.com</option>
                <option value="api.github.com">api.github.com</option>
                <option value="www.microsoft.com">www.microsoft.com</option>
                <option value="www.apple.com">www.apple.com</option>
                <option value="static.cdninstagram.com">static.cdninstagram.com</option>
                <option value="custom">Custom‚Ä¶</option>
              </select>
            </div>
            <div class="form-group">
              <label>Fake Path</label>
              <input type="text" id="mimic-path" value="/search" placeholder="/search">
            </div>
          </div>
          <div id="mimic-custom-row" class="form-group" style="display:none">
            <label>Custom Domain</label>
            <input type="text" id="mimic-custom-domain" placeholder="cdn.example.com">
          </div>
          <div class="form-group">
            <label style="display:flex;align-items:center;gap:8px">
              Session Cookie
              <div class="toggle on" id="mimic-cookies" onclick="this.classList.toggle('on')" style="transform:scale(0.8)"></div>
              <span class="text-muted text-xs">(recommended ‚Äî mimics real browser sessions)</span>
            </label>
          </div>
          <div id="tls-cert-section">
            <hr style="margin:12px 0;border-color:var(--border)">
            <div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:10px">TLS Certificate <span class="badge b-green" style="font-size:8px">Required for httpsmux / wssmux</span></div>
            <div class="form-row2">
              <div class="form-group">
                <label>cert_file path</label>
                <input type="text" id="tls-cert-file" value="/etc/DaggerConnect/certs/cert.pem">
              </div>
              <div class="form-group">
                <label>key_file path</label>
                <input type="text" id="tls-key-file" value="/etc/DaggerConnect/certs/key.pem">
              </div>
            </div>
            <div class="hint">Need a cert? Generate one in the <a href="#" onclick="switchTab('security')" style="color:var(--accent)">Security / TLS</a> tab.</div>
          </div>
        </div>
      </div>

      <!-- KCP (kcpmux) -->
      <div id="tpanel-kcp" class="card mb16" style="display:none">
        <div class="card-header">
          <span>‚ö°</span><span class="card-title">KCP Settings</span>
          <span class="badge b-amber mla">kcpmux</span>
        </div>
        <div class="card-body">
          <div class="hint mb16">KCP runs over UDP. Tune for your network conditions. Higher FEC = more loss recovery, more bandwidth used.</div>
          <div class="form-row2">
            <div class="form-group">
              <label>MTU <span class="text-muted text-xs">(1350 = internet, 1400 = LAN)</span></label>
              <input type="number" id="kcp-mtu" value="1400" min="576" max="1500" oninput="calcFEC()">
            </div>
            <div class="form-group">
              <label>Socket Buffer <span class="text-muted text-xs">(bytes)</span></label>
              <input type="number" id="kcp-sockbuf" value="4194304">
            </div>
          </div>
          <div class="form-row2">
            <div class="form-group">
              <label>Send Window <span class="text-muted text-xs">(packets in-flight)</span></label>
              <input type="number" id="kcp-sndwnd" value="1024" oninput="calcFEC()">
            </div>
            <div class="form-group">
              <label>Receive Window</label>
              <input type="number" id="kcp-rcvwnd" value="1024" oninput="calcFEC()">
            </div>
          </div>
          <div class="form-row2">
            <div class="form-group">
              <label>FEC data_shard</label>
              <input type="number" id="kcp-data" value="10" min="1" max="100" oninput="calcFEC()">
            </div>
            <div class="form-group">
              <label>FEC parity_shard</label>
              <input type="number" id="kcp-parity" value="1" min="0" max="50" oninput="calcFEC()">
            </div>
          </div>
          <div id="fec-result" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px;font-family:'Geist Mono',monospace;font-size:10px;line-height:1.8;margin-top:8px"></div>
          <div class="hint mt8">Throughput ‚âà (snd_wnd √ó MTU) / RTT &nbsp;¬∑&nbsp; Start with parity=1, increase only if you see packet drops.</div>
        </div>
      </div>

      <!-- rawmux -->
      <div id="tpanel-rawmux" class="card mb16" style="display:none">
        <div class="card-header">
          <span>üîó</span><span class="card-title">RawMux Settings</span>
          <span class="badge b-red mla">rawmux</span>
        </div>
        <div class="card-body">
          <div class="hint mb16">Raw TCP mux ‚Äî minimal overhead, no DPI bypass. Best for internal/trusted networks where maximum throughput matters.</div>
          <div class="form-row2">
            <div class="form-group">
              <label>Handshake Timeout <span class="text-muted text-xs">(sec)</span></label>
              <input type="number" id="rawmux-handshake" value="10">
            </div>
            <div class="form-group">
              <label>Keepalive <span class="text-muted text-xs">(sec)</span></label>
              <input type="number" id="rawmux-keepalive" value="15">
            </div>
          </div>
          <div class="form-row2">
            <div class="form-group">
              <label>Read Buffer <span class="text-muted text-xs">(bytes)</span></label>
              <input type="number" id="rawmux-readbuf" value="4194304">
            </div>
            <div class="form-group">
              <label>Write Buffer <span class="text-muted text-xs">(bytes)</span></label>
              <input type="number" id="rawmux-writebuf" value="4194304">
            </div>
          </div>
          <div class="form-group">
            <label style="display:flex;align-items:center;gap:8px">
              Use pcap (use_pcap)
              <div class="toggle on" id="rawmux-pcap" onclick="this.classList.toggle('on')" style="transform:scale(0.8)"></div>
              <span class="text-muted text-xs">(recommended)</span>
            </label>
          </div>
          <div class="hint mt8">No HTTP mimicry ‚Äî use on networks without DPI or when raw speed is more important than stealth.</div>
        </div>
      </div>

      <!-- tcpmux -->
      <div id="tpanel-tcpmux" class="card mb16" style="display:none">
        <div class="card-header">
          <span>üîó</span><span class="card-title">TCP Mux Settings</span>
          <span class="badge b-green mla">tcpmux</span>
        </div>
        <div class="card-body">
          <div class="hint mb16">Simple TCP multiplexer. No DPI mimicry. Works on all networks without special OS requirements or root access.</div>
          <div class="pm-item" style="flex-direction:column;align-items:flex-start;gap:6px;padding:14px;background:var(--bg3);border-radius:8px">
            <span style="font-size:12px;color:var(--text2)">No protocol-specific settings for tcpmux.</span>
            <span style="font-size:11px;color:var(--text3)">Global TCP settings (nodelay, keepalive, buffer sizes) apply ‚Äî configure in Server Config or YAML editor.</span>
          </div>
        </div>
      </div>

      <!-- DaggerMux ‚Äî full panel from docs -->
      <div id="tpanel-daggermux" class="card mb16" style="display:none">
        <div class="card-header">
          <span>‚ö°</span>
          <span class="card-title">DaggerMux Config</span>
          <span class="badge b-red mla" style="font-size:9px">Requires root + libpcap</span>
          <span class="badge b-purple" style="margin-left:6px;font-size:9px">pcap/KCP inject</span>
        </div>
        <div class="card-body">

          <!-- Warning banner -->
          <div style="background:rgba(239,68,68,.07);border:1px solid rgba(239,68,68,.25);border-radius:8px;padding:12px;margin-bottom:16px;font-size:11px;line-height:1.7">
            <div style="font-weight:700;color:var(--danger);margin-bottom:6px">‚ö† Prerequisites</div>
            <div style="color:var(--text2)">
              ‚Ä¢ Root access required (pcap + raw socket)<br>
              ‚Ä¢ iptables NOTRACK rules <strong>mandatory</strong> (kernel sends RST without them)<br>
              ‚Ä¢ libpcap installed: <code style="color:var(--accent)">apt install libpcap-dev</code><br>
              ‚Ä¢ obfuscation <strong>must be disabled</strong> ‚Äî MTU violations otherwise<br>
              ‚Ä¢ IPv4 only
            </div>
          </div>

          <div class="grid2" style="gap:20px">
            <!-- Left column: KCP/FEC settings -->
            <div>
              <div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:10px;letter-spacing:.05em">KCP / FEC Settings</div>
              <div class="form-row2">
                <div class="form-group">
                  <label>MTU <span class="text-muted text-xs">(1350 = internet)</span></label>
                  <input type="number" id="fec-mtu" value="1350" min="576" max="1500" oninput="calcFEC()">
                </div>
                <div class="form-group">
                  <label>Socket Buffer <span class="text-muted text-xs">(bytes)</span></label>
                  <input type="number" id="dm-sockbuf" value="4194304">
                </div>
              </div>
              <div class="form-row2">
                <div class="form-group">
                  <label>Send Window <span class="text-muted text-xs">(pkts)</span></label>
                  <input type="number" id="dm-sndwnd" value="1024">
                </div>
                <div class="form-group">
                  <label>Receive Window</label>
                  <input type="number" id="dm-rcvwnd" value="1024">
                </div>
              </div>
              <div class="form-row2">
                <div class="form-group">
                  <label>FEC data_shard</label>
                  <input type="number" id="fec-data" value="10" min="1" max="100" oninput="calcFEC()">
                </div>
                <div class="form-group">
                  <label>FEC parity_shard</label>
                  <input type="number" id="fec-parity" value="1" min="0" max="50" oninput="calcFEC()">
                </div>
              </div>
              <div id="fec-result-dm" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px;font-family:'Geist Mono',monospace;font-size:10px;line-height:1.8;margin-top:4px"></div>

              <!-- FEC presets -->
              <div style="font-size:10px;font-weight:700;color:var(--text2);margin:10px 0 6px">FEC Presets by Network Quality</div>
              <div style="display:flex;flex-direction:column;gap:4px">
                <div class="pm-item" style="cursor:pointer;padding:6px 10px" onclick="setFecPreset(20,1)"><span class="badge b-green" style="font-size:9px">Low Loss &lt;1%</span><span class="text-mono text-xs mla" style="color:var(--text3)">data=20 parity=1 ‚Üí 1.05x</span></div>
                <div class="pm-item" style="cursor:pointer;padding:6px 10px" onclick="setFecPreset(10,1)"><span class="badge b-cyan" style="font-size:9px">Normal 1‚Äì5%</span><span class="text-mono text-xs mla" style="color:var(--text3)">data=10 parity=1 ‚Üí 1.10x</span></div>
                <div class="pm-item" style="cursor:pointer;padding:6px 10px" onclick="setFecPreset(10,2)"><span class="badge b-amber" style="font-size:9px">Poor 5‚Äì15%</span><span class="text-mono text-xs mla" style="color:var(--text3)">data=10 parity=2 ‚Üí 1.20x</span></div>
                <div class="pm-item" style="cursor:pointer;padding:6px 10px" onclick="setFecPreset(10,3)"><span class="badge b-red" style="font-size:9px">Very Poor &gt;15%</span><span class="text-mono text-xs mla" style="color:var(--text3)">data=10 parity=3 ‚Üí 1.30x</span></div>
              </div>
            </div>

            <!-- Right column: iptables + advanced -->
            <div>
              <div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:10px;letter-spacing:.05em">iptables NOTRACK Rules</div>
              <div class="form-group">
                <label>DaggerMux Port</label>
                <div class="flex">
                  <input type="number" id="ipt-port" value="2020" style="flex:1">
                  <button class="btn btn-ghost" style="margin-left:6px" onclick="checkIptables()">Check</button>
                  <button class="btn btn-danger" style="margin-left:6px" onclick="applyIptables()">Apply</button>
                </div>
                <div class="hint">Without these rules kernel sends RST and kills connections.</div>
              </div>
              <div id="ipt-status" style="display:none;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px;font-family:'Geist Mono',monospace;font-size:10px;line-height:1.8;margin-bottom:10px"></div>

              <!-- Advanced: network auto-detect -->
              <div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px">Network (leave blank for auto-detect)</div>
              <div class="form-group">
                <label>Interface name <span class="text-muted text-xs">(e.g. eth0 ‚Äî blank = auto)</span></label>
                <input type="text" id="dm-interface" placeholder="">
              </div>
              <div class="form-group">
                <label>Local IP <span class="text-muted text-xs">(blank = auto from routing)</span></label>
                <input type="text" id="dm-localip" placeholder="">
              </div>
              <div class="form-group">
                <label>Router MAC <span class="text-muted text-xs">(client only ‚Äî blank = ARP auto)</span></label>
                <input type="text" id="dm-routermac" placeholder="aa:bb:cc:dd:ee:ff">
              </div>
            </div>
          </div>

          <hr style="margin:16px 0;border-color:var(--border)">

          <!-- TCP Flags -->
          <div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:10px">TCP Flag Profiles <span class="text-muted text-xs" style="font-weight:400">(makes tunnel look like real TCP sessions)</span></div>
          <div class="grid3" style="gap:8px;margin-bottom:10px">
            <div class="pm-item" style="cursor:pointer;flex-direction:column;align-items:flex-start;gap:4px" onclick="applyFlagProfile('http')">
              <span class="badge b-cyan">HTTP Profile</span>
              <span style="font-family:'Geist Mono',monospace;font-size:9px;color:var(--text2)">PA, A, PA / PA, A</span>
              <span style="font-size:9px;color:var(--text3)">Most common ‚Äî looks like web traffic</span>
            </div>
            <div class="pm-item" style="cursor:pointer;flex-direction:column;align-items:flex-start;gap:4px" onclick="applyFlagProfile('stealth')">
              <span class="badge b-purple">Stealth Profile</span>
              <span style="font-family:'Geist Mono',monospace;font-size:9px;color:var(--text2)">PA, A, PA, FA / SA, PA, A</span>
              <span style="font-size:9px;color:var(--text3)">More variety ‚Äî harder to fingerprint</span>
            </div>
            <div class="pm-item" style="cursor:pointer;flex-direction:column;align-items:flex-start;gap:4px" onclick="applyFlagProfile('minimal')">
              <span class="badge b-green">Minimal Profile</span>
              <span style="font-family:'Geist Mono',monospace;font-size:9px;color:var(--text2)">PA / PA</span>
              <span style="font-size:9px;color:var(--text3)">Lowest overhead</span>
            </div>
          </div>
          <div class="form-row2">
            <div class="form-group">
              <label>local_flags <span class="text-muted text-xs">(comma-separated: PA,A)</span></label>
              <input type="text" id="dm-local-flags" value="PA,A" placeholder="PA,A">
            </div>
            <div class="form-group">
              <label>remote_flags <span class="text-muted text-xs">(comma-separated)</span></label>
              <input type="text" id="dm-remote-flags" value="PA,A" placeholder="PA,A">
            </div>
          </div>

          <!-- Quick presets -->
          <hr style="margin:16px 0;border-color:var(--border)">
          <div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px">Quick Presets</div>
          <div class="grid2" style="gap:8px">
            <div class="pm-item" style="cursor:pointer;flex-direction:column;align-items:flex-start;gap:3px" onclick="applyDaggerPreset('gaming')">
              <span class="badge b-cyan">üéÆ Gaming / Low Latency</span>
              <span style="font-size:9px;color:var(--text3)">MTU 1200 ¬∑ snd/rcv 512 ¬∑ data=10 parity=1</span>
            </div>
            <div class="pm-item" style="cursor:pointer;flex-direction:column;align-items:flex-start;gap:3px" onclick="applyDaggerPreset('throughput')">
              <span class="badge b-green">üì• High Throughput</span>
              <span style="font-size:9px;color:var(--text3)">MTU 1350 ¬∑ snd/rcv 2048 ¬∑ data=20 parity=1</span>
            </div>
            <div class="pm-item" style="cursor:pointer;flex-direction:column;align-items:flex-start;gap:3px" onclick="applyDaggerPreset('stealth')">
              <span class="badge b-purple">üõ°Ô∏è Maximum Stealth</span>
              <span style="font-size:9px;color:var(--text3)">MTU 1300 ¬∑ snd/rcv 1024 ¬∑ stealth flags</span>
            </div>
            <div class="pm-item" style="cursor:pointer;flex-direction:column;align-items:flex-start;gap:3px" onclick="applyDaggerPreset('lossy')">
              <span class="badge b-amber">üåê High Packet Loss</span>
              <span style="font-size:9px;color:var(--text3)">MTU 1280 ¬∑ snd/rcv 2048 ¬∑ data=10 parity=2</span>
            </div>
          </div>

        </div>
        <div class="card-footer">
          <span class="text-mono text-xs text-muted">Generates daggermux: block in server.yaml</span>
          <button class="btn btn-primary mla" onclick="previewTransportYaml()">üìù Preview in YAML Editor</button>
        </div>
      </div>
    </div>


    <!-- ‚îÄ‚îÄ OBFUSCATION ‚îÄ‚îÄ -->
    <div class="tab-view" id="tab-obfuscation">
      <div class="section-head"><h2>Traffic Obfuscation</h2><div class="section-div"></div>
        <button class="btn btn-primary" onclick="saveAndRestart('server')">üìù Preview in YAML Editor</button>
      </div>
      <div class="grid2">
        <div class="card">
          <div class="card-header"><span>üé≠</span><span class="card-title">Settings</span>
            <div class="toggle on mla" id="obfusc-en" onclick="this.classList.toggle('on')"></div>
          </div>
          <div class="card-body">
            <div class="form-group"><label>Min Padding (bytes)</label>
              <input type="range" min="0" max="512" value="32" id="ob-padmin" oninput="document.getElementById('ob-padmin-lbl').textContent=this.value">
              <div class="range-lbls"><span>0</span><span id="ob-padmin-lbl">32</span><span>512</span></div>
            </div>
            <div class="form-group"><label>Max Padding (bytes)</label>
              <input type="range" min="0" max="4096" value="1024" id="ob-padmax" oninput="document.getElementById('ob-padmax-lbl').textContent=this.value">
              <div class="range-lbls"><span>0</span><span id="ob-padmax-lbl">1024</span><span>4096</span></div>
            </div>
            <div class="form-group"><label>Min Delay (ms)</label>
              <input type="range" min="0" max="200" value="10" id="ob-delmin" oninput="document.getElementById('ob-delmin-lbl').textContent=this.value">
              <div class="range-lbls"><span>0</span><span id="ob-delmin-lbl">10</span><span>200</span></div>
            </div>
            <div class="form-group"><label>Max Delay (ms)</label>
              <input type="range" min="0" max="500" value="100" id="ob-delmax" oninput="document.getElementById('ob-delmax-lbl').textContent=this.value">
              <div class="range-lbls"><span>0</span><span id="ob-delmax-lbl">100</span><span>500</span></div>
            </div>
            <div class="form-group"><label>Burst Chance: <span id="ob-burst-lbl" class="text-accent text-mono">0.20</span></label>
              <input type="range" min="0" max="100" value="20" id="ob-burst" oninput="document.getElementById('ob-burst-lbl').textContent=(this.value/100).toFixed(2)">
              <div class="range-lbls"><span>0.0</span><span>0.5</span><span>1.0</span></div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><span>‚ö°</span><span class="card-title">Quick Presets</span></div>
          <div class="card-body flex-col" style="gap:8px">
            <div class="pm-item" style="cursor:pointer" onclick="applyOb(8,256,2,20,10)"><span class="badge b-green">Light</span><span class="text-muted text-xs mla">pad 8‚Äì256 ¬∑ delay 2‚Äì20ms</span></div>
            <div class="pm-item" style="cursor:pointer" onclick="applyOb(32,1024,10,100,20)"><span class="badge b-cyan">Balanced</span><span class="text-muted text-xs mla">pad 32‚Äì1024 ¬∑ delay 10‚Äì100ms</span></div>
            <div class="pm-item" style="cursor:pointer" onclick="applyOb(64,2048,15,150,30)"><span class="badge b-amber">Heavy</span><span class="text-muted text-xs mla">pad 64‚Äì2048 ¬∑ delay 15‚Äì150ms</span></div>
            <div class="pm-item" style="cursor:pointer" onclick="applyOb(128,4096,30,300,40)"><span class="badge b-red">Max Stealth</span><span class="text-muted text-xs mla">pad 128‚Äì4096 ¬∑ delay 30‚Äì300ms</span></div>
            <hr>
            <div class="pm-item" style="cursor:pointer" onclick="applyOb(0,0,0,0,0);document.getElementById('obfusc-en').classList.remove('on')"><span class="badge b-purple">Disabled</span><span class="text-muted text-xs mla">Gaming / VoIP use</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ SECURITY / TLS ‚îÄ‚îÄ -->
    <div class="tab-view" id="tab-security">
      <div class="section-head"><h2>Security & TLS</h2><div class="section-div"></div></div>
      <div class="grid2">
        <div class="card">
          <div class="card-header"><span>üîí</span><span class="card-title">TLS Certificate</span></div>
          <div class="card-body">
            <div id="cert-info-block" class="pm-item mb16 flex-col" style="align-items:flex-start;gap:4px">
              <span class="text-muted text-sm">Loading certificate info‚Ä¶</span>
            </div>
            <hr>
            <div class="form-group"><label>CN / Fake Domain</label><input type="text" id="cert-cn" value="www.google.com"></div>
            <div class="form-row2">
              <div class="form-group"><label>Validity (days)</label><input type="number" id="cert-days" value="365"></div>
              <div class="form-group"><label>Key Size</label><select id="cert-key"><option>RSA 4096</option><option>RSA 2048</option></select></div>
            </div>
            <button class="btn btn-primary w-full mt16" onclick="generateCert()">üîë Generate Self-Signed Cert</button>
            <div class="hint mt8">Generates to /etc/DaggerConnect/certs/cert.pem + key.pem</div>
          </div>
        </div>

      </div>
    </div>

    <!-- ‚îÄ‚îÄ ACTIVE CONNECTIONS ‚îÄ‚îÄ -->
    <div class="tab-view" id="tab-connections">
      <div class="section-head">
        <h2>Active Connections <span class="badge b-green" id="conn-count-badge" style="display:none;margin-left:8px">0</span></h2>
        <div class="section-div"></div>
        <span class="text-muted text-xs" id="conn-daggermux-note" style="font-size:10px;max-width:320px;line-height:1.4;text-align:right"></span>
        <button class="btn btn-ghost" onclick="loadConnections()">‚Ü∫ Refresh</button>
      </div>
      <div class="card mb16">
        <div class="card-body" style="padding:0">
          <table>
            <thead><tr><th>Local</th><th>Remote</th><th>State</th><th>Port</th></tr></thead>
            <tbody id="conn-table"><tr><td colspan="4" class="text-muted text-mono text-sm" style="padding:14px">Click Refresh to load.</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="section-head" style="margin-top:8px">
        <h2 style="font-size:15px">Connection History</h2>
        <div class="section-div"></div>
        <button class="btn btn-ghost" style="font-size:10px;padding:4px 8px" onclick="clearConnHistory()">Clear History</button>
      </div>
      <div class="card">
        <div class="card-body" style="padding:0">
          <table>
            <thead><tr><th>Time</th><th>Remote IP</th><th>Port</th><th>State</th><th>Duration</th></tr></thead>
            <tbody id="conn-history-table"><tr><td colspan="5" class="text-muted text-mono text-sm" style="padding:14px">No history yet. History is recorded while the panel is open.</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ YAML EDITOR ‚îÄ‚îÄ -->
    <div class="tab-view" id="tab-yaml">
      <div class="section-head">
        <h2>YAML Editor</h2>
        <div class="section-div"></div>
        <select id="yaml-target" style="width:160px" onchange="loadConfig(this.value)">
          <option value="server">Server Config</option>
          <option value="client">Client Config</option>
        </select>
        <button class="btn btn-ghost" onclick="loadConfig(document.getElementById('yaml-target').value)">‚Ü∫ Load</button>
        <button class="btn btn-ghost" onclick="importYamlToWizard()" title="Re-import YAML into wizard">üßô Import to Wizard</button>
        <button class="btn btn-primary" onclick="confirmSaveYaml()">üíæ Save & Restart</button>
      </div>
      <!-- Validation status bar -->
      <div id="yaml-validation-bar" style="margin-bottom:10px;padding:7px 14px;border-radius:8px;font-family:'Geist Mono',monospace;font-size:10px;display:none;align-items:center;gap:8px"></div>
      <div class="card">
        <div class="card-body" style="padding:0">
          <textarea id="yaml-editor" oninput="liveValidateYaml()">Loading‚Ä¶</textarea>
        </div>
        <div class="card-footer">
          <span class="text-mono text-xs text-muted" id="yaml-file-label">/etc/DaggerConnect/server.yaml</span>
          <button class="btn btn-ghost mla" onclick="validateYaml()">‚úì Validate</button>
          <button class="btn btn-primary" onclick="confirmSaveYaml()">Apply & Restart</button>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- ‚îÄ‚îÄ MODAL: Add Port Mapping ‚îÄ‚îÄ -->
<div class="modal-ov" id="add-port-modal">
  <div class="modal">
    <div class="modal-head">
      <span style="font-size:18px">üîå</span>
      <h3>Add Port Mapping</h3>
      <div class="icn-btn mla" onclick="document.getElementById('add-port-modal').classList.remove('open')">‚úï</div>
    </div>
    <div class="modal-body">
      <div class="form-group"><label>Protocol</label>
        <select id="pm-proto"><option value="tcp">tcp</option><option value="udp">udp</option><option value="both">both</option></select>
      </div>
      <div class="form-row2">
        <div class="form-group"><label>Bind IP</label><input type="text" id="pm-bind-ip" value="0.0.0.0"></div>
        <div class="form-group"><label>Bind Port</label><input type="number" id="pm-bind-port" placeholder="8080"></div>
      </div>
      <div class="form-row2">
        <div class="form-group"><label>Target IP</label><input type="text" id="pm-tgt-ip" value="127.0.0.1"></div>
        <div class="form-group"><label>Target Port</label><input type="number" id="pm-tgt-port" placeholder="80"></div>
      </div>
      <div class="form-group"><label>Label (optional)</label><input type="text" id="pm-label" placeholder="e.g. V2Ray, SSH, WireGuard"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="document.getElementById('add-port-modal').classList.remove('open')">Cancel</button>
      <button class="btn btn-primary" onclick="addPortMap()">Add Mapping</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ WIZARD MODAL ‚îÄ‚îÄ -->
<div class="modal-ov" id="wizard-modal">
  <div class="modal" style="max-width:560px;width:95%">
    <div class="modal-head">
      <span style="font-size:18px">üßô</span>
      <h3 id="wiz-title">Config Wizard</h3>
      <div style="margin-left:auto;display:flex;align-items:center;gap:10px">
        <span class="text-mono text-xs text-muted" id="wiz-step-lbl">Step 1 / 6</span>
        <div class="icn-btn" onclick="closeWizard()">‚úï</div>
      </div>
    </div>
    <!-- progress bar -->
    <div style="height:3px;background:var(--bg3)">
      <div id="wiz-progress" style="height:100%;background:var(--accent);transition:width .3s;width:16%"></div>
    </div>
    <div class="modal-body" id="wiz-body" style="min-height:260px;padding:24px"></div>
    <div class="modal-foot" style="gap:8px">
      <button class="btn btn-ghost" id="wiz-back" onclick="wizBack()" style="display:none">‚Üê Back</button>
      <button class="btn btn-ghost" style="font-size:10px;padding:4px 10px" onclick="wizImportFromYaml()" title="Load current YAML config into wizard">‚¨á Import YAML</button>
      <div style="flex:1"></div>
      <button class="btn btn-ghost" onclick="closeWizard()">Cancel</button>
      <button class="btn btn-primary" id="wiz-next" onclick="wizNext()">Next ‚Üí</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ -->
<div class="notif" id="notif">
  <span id="notif-icon">‚úÖ</span>
  <span id="notif-text">Done!</span>
</div>

<script>
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  CONFIG
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // API ‚Äî same origin when behind nginx (/api/ is proxied)
  // For direct SSH tunnel access to socat, set to 'http://localhost:7070'
  const API = '';
  let AUTH_TOKEN = sessionStorage.getItem('dagger_token') || '';
  let apiOnline = false;
  let logPollTimer = null;
  let netPollTimer = null;
  let prevRx = 0, prevTx = 0, prevSnapTs = 0;
  let NODE_ROLE = 'unknown'; // 'server' | 'client' | 'unknown'

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  CANVAS CHART WITH HOVER TOOLTIP
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const CHART_POINTS = 60; // default visible window (60s at 5s poll = 60 points)
  let CHART_RANGE = 12;    // 1 minute = 12 points at 5s poll
  let RES_RANGE   = 12;    // resource chart range
  let combinedMode = false;

  // ‚îÄ‚îÄ Persistent chart storage via sessionStorage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function loadHistory(key) {
    try { const d = JSON.parse(sessionStorage.getItem('dagger_hist_' + key)); if (Array.isArray(d) && d.length > 0) return d; } catch(e) {}
    return [];
  }
  function saveHistory(key, arr) {
    try { sessionStorage.setItem('dagger_hist_' + key, JSON.stringify(arr.slice(-2880))); } catch(e) {}
  }

  // Full history arrays (up to 2880 points = 4hr)
  let dlHistory   = loadHistory('dl');
  let ulHistory   = loadHistory('ul');
  let cpuHistory  = loadHistory('cpu');
  let ramHistory  = loadHistory('ram');
  let dlTimestamps  = loadHistory('dl_ts');
  let ulTimestamps  = loadHistory('ul_ts');
  let cpuTimestamps = loadHistory('cpu_ts');
  let ramTimestamps = loadHistory('ram_ts');

  // Get windowed view for drawing
  function getWindow(arr, n) {
    if (!n || n >= arr.length) return arr.slice();
    return arr.slice(-n);
  }

  // ‚îÄ‚îÄ Load server-side history on startup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadServerHistory() {
    try {
      const d = await api('/api/metrics/history?points=2880');
      if (!d.ok || !d.points || d.points.length === 0) return;
      const pts = d.points;
      // Only load if we have fewer local points (server has more history)
      if (pts.length <= dlHistory.length) return;

      // Rebuild history arrays from server data
      // Note: server doesn't have rx/tx delta, only raw bytes ‚Äî compute speed from consecutive points
      const newCpu  = []; const newRam  = [];
      const newCpuTs = []; const newRamTs = [];
      const newDl = []; const newUl = [];
      const newDlTs = []; const newUlTs = [];

      let prevRxH = 0, prevTxH = 0, prevTsH = 0;
      pts.forEach((p, i) => {
        newCpu.push(p.cpu  || 0);
        newRam.push(p.ram  || 0);
        newCpuTs.push(p.ts);
        newRamTs.push(p.ts);
        // Compute network speed from consecutive raw byte counts
        if (i > 0 && prevTsH > 0 && p.ts > prevTsH) {
          const elap = (p.ts - prevTsH) / 1000;
          const dlMbps = Math.max(0, ((p.rx || 0) - prevRxH) * 8 / 1e6 / elap);
          const ulMbps = Math.max(0, ((p.tx || 0) - prevTxH) * 8 / 1e6 / elap);
          newDl.push(dlMbps);
          newUl.push(ulMbps);
          newDlTs.push(p.ts);
          newUlTs.push(p.ts);
        }
        prevRxH = p.rx || 0; prevTxH = p.tx || 0; prevTsH = p.ts;
      });

      cpuHistory  = newCpu;  cpuTimestamps  = newCpuTs;
      ramHistory  = newRam;  ramTimestamps  = newRamTs;
      dlHistory   = newDl;   dlTimestamps   = newDlTs;
      ulHistory   = newUl;   ulTimestamps   = newUlTs;
      saveHistory('cpu', cpuHistory); saveHistory('cpu_ts', cpuTimestamps);
      saveHistory('ram', ramHistory); saveHistory('ram_ts', ramTimestamps);
      saveHistory('dl',  dlHistory);  saveHistory('dl_ts',  dlTimestamps);
      saveHistory('ul',  ulHistory);  saveHistory('ul_ts',  ulTimestamps);

      redrawAllCharts();
      updateNetStats();
      updateResStats();
    } catch(e) { console.warn('History load failed:', e); }
  }

  function drawChart(canvasId, history, color1, color2, label) {
    const canvas = document.getElementById(canvasId);
    if (!canvas || !canvas.getContext) return;
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.clientWidth;
    if (!W) return;  // not visible yet
    const H = canvas.clientHeight || 90;
    canvas.width = W * dpr;
    canvas.height = H * dpr;
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);

    const n = history.length;
    const max = n > 0 ? Math.max(...history, 0.001) : 0.001;
    const pad = { t: 8, r: 8, b: 18, l: 42 };
    const gW = W - pad.l - pad.r;
    const gH = H - pad.t - pad.b;

    // Background
    ctx.fillStyle = '#070910';
    ctx.fillRect(0, 0, W, H);

    if (n === 0) {
      ctx.fillStyle = '#4a5568';
      ctx.font = '9px monospace';
      ctx.textAlign = 'center';
      ctx.fillText('No data yet', W / 2, H / 2 + 3);
      return;
    }

    // Grid lines
    ctx.strokeStyle = 'rgba(30,34,53,0.9)';
    ctx.lineWidth = 1;
    [0, 0.25, 0.5, 0.75, 1].forEach(f => {
      const y = Math.round(pad.t + gH * (1 - f)) + 0.5;
      ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l + gW, y); ctx.stroke();
    });

    // Y-axis labels ‚Äî smart formatting
    ctx.fillStyle = '#4a5568';
    ctx.font = '8px monospace';
    ctx.textAlign = 'right';
    const isPercent = label.includes('%');
    [0, 0.5, 1].forEach(f => {
      let val;
      if (isPercent) val = (max * f).toFixed(0) + '%';
      else if (max >= 100) val = (max * f).toFixed(0);
      else if (max >= 1) val = (max * f).toFixed(1);
      else val = (max * f).toFixed(2);
      const y = pad.t + gH * (1 - f) + 3;
      ctx.fillText(val, pad.l - 4, y);
    });

    // xStep: pixel width between each data point
    const xOf = i => pad.l + (n > 1 ? (i / (n - 1)) * gW : gW / 2);
    const yOf = v => pad.t + gH * (1 - v / max);

    // Area gradient fill
    if (history.some(v => v > 0)) {
      const grad = ctx.createLinearGradient(0, pad.t, 0, pad.t + gH);
      grad.addColorStop(0, color1 + '55');
      grad.addColorStop(1, color1 + '05');
      ctx.beginPath();
      history.forEach((v, i) => { i === 0 ? ctx.moveTo(xOf(i), yOf(v)) : ctx.lineTo(xOf(i), yOf(v)); });
      ctx.lineTo(xOf(n-1), pad.t + gH);
      ctx.lineTo(xOf(0), pad.t + gH);
      ctx.closePath();
      ctx.fillStyle = grad;
      ctx.fill();

      // Line
      ctx.beginPath();
      ctx.strokeStyle = color1;
      ctx.lineWidth = 1.5;
      ctx.lineJoin = 'round';
      history.forEach((v, i) => { i === 0 ? ctx.moveTo(xOf(i), yOf(v)) : ctx.lineTo(xOf(i), yOf(v)); });
      ctx.stroke();
    }

    // X-axis label: show time range
    const rangeLabel = n > 1 ? _rangeStr(n) : '';
    ctx.fillStyle = '#4a5568';
    ctx.font = '8px monospace';
    ctx.textAlign = 'left';
    ctx.fillText(label, pad.l, H - 2);
    ctx.textAlign = 'right';
    ctx.fillText(rangeLabel, W - pad.r, H - 2);
  }

  function _rangeStr(n) {
    const secs = n * 5;  // 5s poll interval
    if (secs < 60) return secs + 's';
    if (secs < 3600) return Math.round(secs/60) + 'm';
    return (secs/3600).toFixed(1) + 'h';
  }

  function setupChartHover(canvasId, tooltipId, history, timestamps, color, unit) {
    const canvas = document.getElementById(canvasId);
    const tip = document.getElementById(tooltipId);
    if (!canvas || !tip) return;
    const _unit = unit || 'Mbps';

    canvas.addEventListener('mousemove', e => {
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const pad = { l: 42, r: 8 };
      const gW = rect.width - pad.l - pad.r;
      if (mx < pad.l || mx > pad.l + gW) { tip.style.opacity = '0'; return; }

      // Use the same windowed view as drawChart
      const viewArr = (() => {
        if (canvasId === 'chart-dl')  return getWindow(dlHistory,  CHART_RANGE);
        if (canvasId === 'chart-ul')  return getWindow(ulHistory,  CHART_RANGE);
        if (canvasId === 'chart-cpu') return getWindow(cpuHistory, RES_RANGE);
        if (canvasId === 'chart-ram') return getWindow(ramHistory, RES_RANGE);
        return getWindow(history, CHART_RANGE);
      })();
      const viewTs = (() => {
        if (canvasId === 'chart-dl')  return getWindow(dlTimestamps,  CHART_RANGE);
        if (canvasId === 'chart-ul')  return getWindow(ulTimestamps,  CHART_RANGE);
        if (canvasId === 'chart-cpu') return getWindow(cpuTimestamps, RES_RANGE);
        if (canvasId === 'chart-ram') return getWindow(ramTimestamps, RES_RANGE);
        return getWindow(timestamps, CHART_RANGE);
      })();
      const n = viewArr.length;
      if (n === 0) { tip.style.opacity = '0'; return; }

      const idx = Math.min(n - 1, Math.max(0, Math.round(((mx - pad.l) / gW) * (n - 1))));
      const val = viewArr[idx] || 0;
      const ts  = viewTs[idx];
      const timeStr = ts ? new Date(ts).toLocaleTimeString('en-US', { hour12: false }) : '‚Äî';
      const max = Math.max(...viewArr, 0.001);
      const pct = ((val / max) * 100).toFixed(0);
      const fmt = v => _unit === '%' ? v.toFixed(1) + '%' : v.toFixed(2) + ' ' + _unit;

      tip.innerHTML = `<span style="color:${color};font-weight:700">${fmt(val)}</span>  <span style="color:#4a5568">${timeStr}</span><br><span style="color:#4a5568">Peak: ${fmt(max)} ¬∑ ${pct}% of peak</span>`;
      tip.style.opacity = '1';

      // Position tooltip: keep inside canvas
      const tipW = tip.offsetWidth || 180;
      let left = mx + 10;
      if (left + tipW > rect.width) left = mx - tipW - 10;
      tip.style.left = left + 'px';
    });

    canvas.addEventListener('mouseleave', () => { tip.style.opacity = '0'; });

    // Touch support
    canvas.addEventListener('touchmove', e => {
      e.preventDefault();
      const t = e.touches[0];
      canvas.dispatchEvent(new MouseEvent('mousemove', { clientX: t.clientX, clientY: t.clientY }));
    }, { passive: false });
    canvas.addEventListener('touchend', () => { tip.style.opacity = '0'; });
  }

  function updateChart(type, val) {
    const now = Date.now();
    const MAX = 2880;
    if (type === 'dl') {
      dlHistory.push(val);   if (dlHistory.length > MAX)   dlHistory.shift();
      dlTimestamps.push(now); if (dlTimestamps.length > MAX) dlTimestamps.shift();
      saveHistory('dl', dlHistory); saveHistory('dl_ts', dlTimestamps);
      drawChart('chart-dl', getWindow(dlHistory, CHART_RANGE), '#00d4ff', '#7c3aed', '‚Üì Download (Mbps)');
      updateNetStats();
    } else if (type === 'ul') {
      ulHistory.push(val);   if (ulHistory.length > MAX)   ulHistory.shift();
      ulTimestamps.push(now); if (ulTimestamps.length > MAX) ulTimestamps.shift();
      saveHistory('ul', ulHistory); saveHistory('ul_ts', ulTimestamps);
      drawChart('chart-ul', getWindow(ulHistory, CHART_RANGE), '#10b981', '#059669', '‚Üë Upload (Mbps)');
      if (combinedMode) drawCombinedChart();
    } else if (type === 'cpu') {
      cpuHistory.push(val);   if (cpuHistory.length > MAX)   cpuHistory.shift();
      cpuTimestamps.push(now); if (cpuTimestamps.length > MAX) cpuTimestamps.shift();
      saveHistory('cpu', cpuHistory); saveHistory('cpu_ts', cpuTimestamps);
      drawChart('chart-cpu', getWindow(cpuHistory, RES_RANGE), '#4f8ef7', '#7c5cfc', 'CPU (%)');
      updateResStats();
    } else if (type === 'ram') {
      ramHistory.push(val);   if (ramHistory.length > MAX)   ramHistory.shift();
      ramTimestamps.push(now); if (ramTimestamps.length > MAX) ramTimestamps.shift();
      saveHistory('ram', ramHistory); saveHistory('ram_ts', ramTimestamps);
      drawChart('chart-ram', getWindow(ramHistory, RES_RANGE), '#0fcf8e', '#059669', 'RAM (%)');
    }
  }

  function redrawAllCharts() {
    drawChart('chart-dl',  getWindow(dlHistory,  CHART_RANGE), '#00d4ff', '#7c3aed', '‚Üì Download (Mbps)');
    drawChart('chart-ul',  getWindow(ulHistory,  CHART_RANGE), '#10b981', '#059669', '‚Üë Upload (Mbps)');
    drawChart('chart-cpu', getWindow(cpuHistory, RES_RANGE),   '#4f8ef7', '#7c5cfc', 'CPU (%)');
    drawChart('chart-ram', getWindow(ramHistory, RES_RANGE),   '#0fcf8e', '#059669', 'RAM (%)');
    if (combinedMode) drawCombinedChart();
  }

  function setChartRange(n, btn) {
    CHART_RANGE = n;
    document.querySelectorAll('#tab-dashboard .card-header .chart-range-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    const labels = {12:'last 1m', 60:'last 5m', 720:'last 1h', 2880:'last 4h'};
    const lbl = document.getElementById('net-range-label');
    if (lbl) lbl.textContent = labels[n] || ('last ' + n + 'pts');
    redrawAllCharts();
    updateNetStats();
  }

  function setResRange(n, btn) {
    RES_RANGE = n;
    const btns = document.querySelectorAll('[onclick^="setResRange"]');
    btns.forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    drawChart('chart-cpu', getWindow(cpuHistory, RES_RANGE), '#4f8ef7', '#7c5cfc', 'CPU (%)');
    drawChart('chart-ram', getWindow(ramHistory, RES_RANGE), '#0fcf8e', '#059669', 'RAM (%)');
    updateResStats();
  }

  function toggleCombinedChart(btn) {
    combinedMode = !combinedMode;
    document.getElementById('chart-combined-wrapper').style.display = combinedMode ? 'block' : 'none';
    document.getElementById('chart-split-wrapper').style.display = combinedMode ? 'none' : 'block';
    if (btn) { btn.textContent = combinedMode ? '‚äò Split' : '‚äï Combined'; }
    if (combinedMode) drawCombinedChart();
  }

  function drawCombinedChart() {
    const canvas = document.getElementById('chart-combined');
    if (!canvas || !canvas.getContext) return;
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.clientWidth;
    const H = canvas.clientHeight || 120;
    canvas.width = W * dpr; canvas.height = H * dpr;
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    const dl = getWindow(dlHistory, CHART_RANGE);
    const ul = getWindow(ulHistory, CHART_RANGE);
    const n = Math.max(dl.length, ul.length, 1);
    const max = Math.max(...dl, ...ul, 0.001);
    const pad = { t: 8, r: 8, b: 18, l: 42 };
    const gW = W - pad.l - pad.r;
    const gH = H - pad.t - pad.b;
    ctx.fillStyle = '#070910'; ctx.fillRect(0, 0, W, H);
    // Grid
    ctx.strokeStyle = 'rgba(30,34,53,0.9)'; ctx.lineWidth = 1;
    [0, 0.25, 0.5, 0.75, 1].forEach(f => {
      const y = Math.round(pad.t + gH * (1 - f)) + 0.5;
      ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l + gW, y); ctx.stroke();
    });
    const xOf = (i, len) => pad.l + (len > 1 ? (i / (len - 1)) * gW : gW / 2);
    const yOf = v => pad.t + gH * (1 - v / max);
    // Draw area
    const drawArea = (data, color) => {
      if (!data.length || !data.some(v => v > 0)) return;
      const len = data.length;
      const grad = ctx.createLinearGradient(0, pad.t, 0, pad.t + gH);
      grad.addColorStop(0, color + '44'); grad.addColorStop(1, color + '05');
      ctx.beginPath();
      data.forEach((v, i) => { i === 0 ? ctx.moveTo(xOf(i,len), yOf(v)) : ctx.lineTo(xOf(i,len), yOf(v)); });
      ctx.lineTo(xOf(len-1,len), pad.t + gH); ctx.lineTo(xOf(0,len), pad.t + gH); ctx.closePath();
      ctx.fillStyle = grad; ctx.fill();
      ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 1.5; ctx.lineJoin = 'round';
      data.forEach((v, i) => { i === 0 ? ctx.moveTo(xOf(i,len), yOf(v)) : ctx.lineTo(xOf(i,len), yOf(v)); });
      ctx.stroke();
    };
    drawArea(dl, '#00d4ff'); drawArea(ul, '#10b981');
    // Y labels
    ctx.fillStyle = '#4a5568'; ctx.font = '8px monospace'; ctx.textAlign = 'right';
    [0, 0.5, 1].forEach(f => {
      const v = max * f;
      const label = max >= 100 ? v.toFixed(0) : max >= 1 ? v.toFixed(1) : v.toFixed(2);
      ctx.fillText(label, pad.l - 4, pad.t + gH * (1 - f) + 3);
    });
    ctx.textAlign = 'left'; ctx.fillText('‚Üì cyan  ‚Üë green  Mbps', pad.l, H - 2);
    ctx.textAlign = 'right'; ctx.fillText(_rangeStr(n), W - pad.r, H - 2);
  }

  function statsOf(arr) {
    const v = arr.filter(x => x > 0);
    if (!v.length) return { avg: '‚Äî', peak: '‚Äî', min: '‚Äî' };
    const avg  = (v.reduce((a, b) => a + b, 0) / v.length).toFixed(2);
    const peak = Math.max(...v).toFixed(2);
    const min  = Math.min(...v).toFixed(2);
    return { avg, peak, min };
  }

  function updateNetStats() {
    const dl = getWindow(dlHistory, CHART_RANGE);
    const ul = getWindow(ulHistory, CHART_RANGE);
    const ds = statsOf(dl); const us = statsOf(ul);
    const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v + (v === '‚Äî' ? '' : ' Mbps'); };
    set('net-dl-avg', ds.avg); set('net-dl-peak', ds.peak);
    set('net-ul-avg', us.avg); set('net-ul-peak', us.peak);
  }

  function updateResStats() {
    const cpu = getWindow(cpuHistory, RES_RANGE);
    const ram = getWindow(ramHistory, RES_RANGE);
    const cs = statsOf(cpu); const rs = statsOf(ram);
    const setRes = (id, v, unit) => { const el = document.getElementById(id); if (el) el.textContent = v + (v === '‚Äî' ? '' : unit); };
    setRes('cpu-avg-val',  cs.avg,  '%'); setRes('cpu-peak-val', cs.peak, '%'); setRes('cpu-min-val', cs.min, '%');
    setRes('ram-avg-val',  rs.avg,  '%'); setRes('ram-peak-val', rs.peak, '%'); setRes('ram-min-val', rs.min, '%');
  }

  // Init charts on load
  window.addEventListener('load', () => {
    redrawAllCharts();
    setupChartHover('chart-dl',  'tooltip-dl',  dlHistory,  dlTimestamps,  '#00d4ff', 'Mbps');
    setupChartHover('chart-ul',  'tooltip-ul',  ulHistory,  ulTimestamps,  '#10b981', 'Mbps');
    setupChartHover('chart-cpu', 'tooltip-cpu', cpuHistory, cpuTimestamps, '#4f8ef7', '%');
    setupChartHover('chart-ram', 'tooltip-ram', ramHistory, ramTimestamps, '#0fcf8e', '%');
  });
  window.addEventListener('resize', redrawAllCharts);

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  API CALLS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function api(path, opts={}) {
    try {
      const headers = { 'Content-Type': 'application/json' };
      if (AUTH_TOKEN) headers['X-Auth-Token'] = AUTH_TOKEN;
      const r = await fetch(API + path, { headers, ...opts });
      if (r.status === 401) {
        // Token rejected ‚Äî show login again
        logout();
        throw new Error('Unauthorized');
      }
      const data = await r.json();
      setApiStatus(true);
      return data;
    } catch (e) {
      setApiStatus(false);
      throw e;
    }
  }

  async function post(path, body) {
    return api(path, { method: 'POST', body: JSON.stringify(body) });
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  API STATUS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function setApiStatus(ok) {
    apiOnline = ok;
    const dot = document.getElementById('api-dot');
    const lbl = document.getElementById('api-label');
    const err = document.getElementById('err-banner');
    if (ok) {
      dot.classList.add('ok');
      lbl.textContent = 'API: online';
      err.classList.remove('show');
    } else {
      dot.classList.remove('ok');
      lbl.textContent = 'API: offline';
      err.classList.add('show');
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  STATUS POLLING
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function loadStatus() {
    try {
      const d = await api('/api/status');

      // Global pill
      const srv = d.server.state === 'active';
      const cli = d.client.state === 'active';
      const gpill = document.getElementById('global-pill');
      if (srv && cli) {
        gpill.className = 'pill pill-green';
        gpill.innerHTML = '<div class="pdot pdot-g"></div> All Online';
      } else if (srv || cli) {
        // One service running ‚Äî on a single-role node this is the normal running state
        const activeOne = srv ? 'Server' : 'Client';
        gpill.className = 'pill pill-green';
        gpill.innerHTML = `<div class="pdot pdot-g"></div> ${activeOne} Running`;
      } else {
        gpill.className = 'pill pill-red';
        gpill.innerHTML = '<div class="pdot pdot-r"></div> Offline';
      }

      // Stats cards
      document.getElementById('stat-conns').textContent = d.server.connections;
      document.getElementById('stat-cpu').textContent = d.system.cpu_pct;

      // Trend indicators
      function setTrend(elId, newVal, arr) {
        const el = document.getElementById(elId);
        if (!el) return;
        const recent = arr.slice(-6).filter(v => v > 0);
        if (recent.length < 2) { el.textContent = ''; return; }
        const prev = recent.slice(0, -1).reduce((a, b) => a + b, 0) / (recent.length - 1);
        const curr = recent[recent.length - 1];
        const delta = curr - prev;
        const pct = prev > 0 ? Math.abs(delta / prev * 100).toFixed(0) : 0;
        if (Math.abs(delta) < 0.05) { el.textContent = '‚Üí stable'; el.style.color = 'var(--text3)'; }
        else if (delta > 0) { el.innerHTML = `‚Üë +${pct}%`; el.style.color = 'var(--accent3)'; }
        else { el.innerHTML = `‚Üì -${pct}%`; el.style.color = 'var(--danger)'; }
      }

      // Resource bars
      const cpuPct = parseFloat(d.system.cpu_pct) || 0;
      const ramPct = d.system.ram_total_mb > 0 ? Math.round(d.system.ram_used_mb / d.system.ram_total_mb * 100) : 0;
      const srvCpu = parseFloat(d.server.cpu) || 0;

      document.getElementById('sys-cpu-val').textContent = cpuPct + '%';
      document.getElementById('sys-cpu-bar').style.width = Math.min(cpuPct, 100) + '%';
      document.getElementById('sys-ram-val').textContent = d.system.ram_used_mb + ' / ' + d.system.ram_total_mb + ' MB';
      document.getElementById('sys-ram-bar').style.width = ramPct + '%';
      document.getElementById('srv-cpu-val').textContent = 'Server ' + srvCpu + '% ¬∑ ' + d.server.mem_mb + ' MB';
      document.getElementById('srv-cpu-bar').style.width = Math.min(srvCpu * 4, 100) + '%';

      // Update CPU/RAM charts
      updateChart('cpu', cpuPct);
      updateChart('ram', ramPct);
      setTrend('stat-cpu-trend', cpuPct, cpuHistory);

      // Services summary (dashboard) ‚Äî show both but mark remote one clearly
      const sumEl = document.getElementById('svc-summary');
      if (sumEl) {
        if (NODE_ROLE === 'server') {
          // On server node: show server service + a locked placeholder for client
          sumEl.innerHTML = renderSvcRow('Server (Iran/relay) ‚Äî this node', d.server, 'server') +
                  renderSvcRowLocked('Client (Foreign/exit) ‚Äî remote node');
        } else if (NODE_ROLE === 'client') {
          // On client node: show client service + locked placeholder for server
          sumEl.innerHTML = renderSvcRowLocked('Server (Iran/relay) ‚Äî remote node') +
                  renderSvcRow('Client (Foreign/exit) ‚Äî this node', d.client, 'client');
        } else {
          sumEl.innerHTML = renderSvcRow('Server (Iran/relay)', d.server, 'server') +
                  renderSvcRow('Client (Foreign/exit)', d.client, 'client');
        }
      }

      // Services tab cards ‚Äî only show the relevant service card
      const cardsEl = document.getElementById('services-cards');
      if (cardsEl) {
        if (NODE_ROLE === 'server') {
          cardsEl.innerHTML = renderSvcCard('DaggerConnect Server', d.server, 'server') +
                  renderSvcCardLocked('DaggerConnect Client', 'client', 'This service runs on the CLIENT (Foreign) VPS');
        } else if (NODE_ROLE === 'client') {
          cardsEl.innerHTML = renderSvcCardLocked('DaggerConnect Server', 'server', 'This service runs on the SERVER (Iran) VPS') +
                  renderSvcCard('DaggerConnect Client', d.client, 'client');
        } else {
          cardsEl.innerHTML = renderSvcCard('DaggerConnect Server', d.server, 'server') +
                  renderSvcCard('DaggerConnect Client', d.client, 'client');
        }
      }

      // Network speed ‚Äî use snap_ts from API so elapsed time is precise
      // even accounting for server-side sleep and API latency
      const rx = d.system.rx_bytes;
      const tx = d.system.tx_bytes;
      const snapTs = d.system.snap_ts || 0;
      if (prevRx > 0 && prevSnapTs > 0 && snapTs > prevSnapTs) {
        const elapsedSec = (snapTs - prevSnapTs) / 1000;
        const dlMbps = Math.max(0, (rx - prevRx) * 8 / 1e6 / elapsedSec);
        const ulMbps = Math.max(0, (tx - prevTx) * 8 / 1e6 / elapsedSec);
        document.getElementById('stat-dl').textContent = dlMbps.toFixed(1);
        document.getElementById('stat-ul').textContent = ulMbps.toFixed(1);
        updateChart('dl', dlMbps);
        updateChart('ul', ulMbps);
        setTrend('stat-dl-trend', dlMbps, dlHistory);
        setTrend('stat-ul-trend', ulMbps, ulHistory);
      }
      setTrend('stat-conns-trend', d.server.connections, Array(CHART_POINTS).fill(d.server.connections));
      prevRx = rx; prevTx = tx; prevSnapTs = snapTs;
      document.getElementById('last-update').textContent = 'Updated ' + new Date().toLocaleTimeString();

    } catch(e) {
      console.warn('Status poll failed:', e);
    }
  }

  function renderSvcRow(name, svc, id) {
    const on = svc.state === 'active';
    const cls = on ? 'pdot-g' : 'pdot-r';
    const stateLabel = on ? 'running' : 'stopped';
    return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
    <div class="pdot ${cls}" style="width:8px;height:8px;border-radius:50%;flex-shrink:0"></div>
    <div style="flex:1">
      <div style="font-size:12px;font-weight:600">${name}</div>
      <div class="text-mono text-xs text-muted">${stateLabel} ¬∑ PID ${svc.pid || '‚Äî'} ¬∑ ${svc.mem_mb || 0} MB</div>
    </div>
    <div class="icn-btn" title="Restart" onclick="svcAction('${id}','restart')">‚Ü∫</div>
    <div class="icn-btn d" title="${on ? 'Stop' : 'Start'}" onclick="svcAction('${id}','${on ? 'stop' : 'start'}')">${on ? '‚ñ†' : '‚ñ∂'}</div>
  </div>`;
  }

  function renderSvcCard(name, svc, id) {
    const on = svc.state === 'active';
    const cpuW = Math.min((parseFloat(svc.cpu) || 0) * 4, 100);
    const memW = Math.min((svc.mem_mb || 0) / 512 * 100, 100);
    return `<div class="card mb16">
    <div class="card-header">
      <span>${id === 'server' ? 'üñ•Ô∏è' : 'üíª'}</span>
      <span class="card-title">${name}</span>
      <div class="pill ${on ? 'pill-green' : 'pill-red'}">
        <div class="pdot ${on ? 'pdot-g' : 'pdot-r'}"></div>
        ${on ? 'Running' : 'Stopped'}
      </div>
      <button class="btn btn-success mla" onclick="svcAction('${id}','start')">‚ñ∂ Start</button>
      <button class="btn btn-ghost" onclick="svcAction('${id}','restart')">‚Ü∫ Restart</button>
      <button class="btn btn-danger" onclick="svcAction('${id}','stop')">‚ñ† Stop</button>
    </div>
    <div class="card-body">
      <div class="form-row2">
        <div class="prog-wrap">
          <div class="prog-head"><span class="prog-label">CPU</span><span class="prog-val">${svc.cpu || 0}%</span></div>
          <div class="prog-bg"><div class="prog-fill pf-cyan" style="width:${cpuW}%"></div></div>
        </div>
        <div class="prog-wrap">
          <div class="prog-head"><span class="prog-label">Memory</span><span class="prog-val">${svc.mem_mb || 0} MB</span></div>
          <div class="prog-bg"><div class="prog-fill pf-green" style="width:${memW}%"></div></div>
        </div>
      </div>
      <div class="flex" style="flex-wrap:wrap;gap:6px;margin-top:4px">
        <span class="badge b-cyan">PID: ${svc.pid || '‚Äî'}</span>
        <span class="badge b-amber">Uptime: ${svc.uptime || '‚Äî'}</span>
        ${id === 'server' ? `<span class="badge b-green">Connections: ${svc.connections}</span>` : ''}
        <span class="badge ${on ? 'b-green' : 'b-red'}">${svc.state || 'unknown'}</span>
      </div>
    </div>
    <div class="card-footer">
      <button class="btn btn-ghost mla" onclick="switchTab('logs');document.getElementById('log-svc').value='${id}';fetchLogs()">View Logs</button>
      <button class="btn btn-ghost" onclick="switchTab('yaml');document.getElementById('yaml-target').value='${id}';loadConfig('${id}')">Edit Config</button>
      <button class="btn btn-ghost" onclick="svcAction('${id}','enable')">Enable Autostart</button>
    </div>
  </div>`;
  }

  function renderSvcRowLocked(name) {
    return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);opacity:0.3;pointer-events:none">
    <div style="width:8px;height:8px;border-radius:50%;background:var(--text3);flex-shrink:0"></div>
    <div style="flex:1">
      <div style="font-size:12px;font-weight:600">${name}</div>
      <div class="text-mono text-xs text-muted">üîí Not on this node</div>
    </div>
  </div>`;
  }

  function renderSvcCardLocked(name, id, reason) {
    return `<div class="card mb16" style="opacity:0.28;pointer-events:none;user-select:none;">
    <div class="card-header">
      <span>${id === 'server' ? 'üñ•Ô∏è' : 'üíª'}</span>
      <span class="card-title">${name}</span>
      <span class="badge b-amber mla">üîí Remote node</span>
    </div>
    <div class="card-body" style="display:flex;align-items:center;justify-content:center;min-height:80px;flex-direction:column;gap:8px">
      <div style="font-size:20px">üîí</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);text-align:center">${reason}</div>
    </div>
  </div>`;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  SERVICE ACTIONS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function svcAction(svc, action) {
    try {
      showNotif(`${action}ing ${svc}‚Ä¶`, '‚è≥');
      const d = await post(`/api/service/${action}`, { service: svc });
      showNotif(d.msg || `${action} sent`, d.ok ? '‚úÖ' : '‚ùå');
      setTimeout(loadStatus, 1200);
    } catch(e) {
      showNotif('API unreachable', '‚ùå');
    }
  }

  // ‚îÄ‚îÄ‚îÄ Role-aware Stop/Start All ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function roleAwareSvcAction(action) {
    if (action === 'stop') {
      const ok = await showConfirmModal('Confirm Stop', `Stop DaggerConnect on this <strong>${NODE_ROLE}</strong> node?`);
      if (!ok) return;
    }
    if (NODE_ROLE === 'server') {
      svcAction('server', action);
    } else if (NODE_ROLE === 'client') {
      svcAction('client', action);
    } else {
      svcAction('server', action);
      svcAction('client', action);
    }
  }

  async function confirmAndStop() {
    const ok = await showConfirmModal('‚ö†Ô∏è Stop All Services', `Stop all DaggerConnect services on this <strong>${NODE_ROLE || 'node'}</strong>?<br><br>This will terminate all active connections.`);
    if (!ok) return;
    roleAwareSvcAction('stop');
  }
  async function confirmAndStart() {
    roleAwareSvcAction('start');
  }

  function toggleMobileMenu() {
    const menu = document.getElementById('mobile-menu');
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    // Close on outside click
    setTimeout(() => {
      document.addEventListener('click', function _close(e) {
        if (!e.target.closest('#mobile-menu') && !e.target.closest('.mobile-actions')) {
          menu.style.display = 'none';
          document.removeEventListener('click', _close);
        }
      });
    }, 50);
  }

  // ‚îÄ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
      const yamlTab = document.getElementById('tab-yaml');
      if (yamlTab && yamlTab.classList.contains('active')) {
        e.preventDefault();
        saveYamlRaw();
      }
    }
    if ((e.ctrlKey || e.metaKey) && e.key === 'r' && !['INPUT','TEXTAREA','SELECT'].includes(document.activeElement?.tagName)) {
      e.preventDefault();
      loadStatus();
      showNotif('Refreshed', '‚Ü∫');
    }
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  LOGS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function fetchLogs() {
    const svc = document.getElementById('log-svc').value;
    const lines = document.getElementById('log-lines').value;
    document.getElementById('log-title').textContent = `DaggerConnect ‚Äî ${svc} ¬∑ last ${lines} lines`;
    try {
      const d = await api(`/api/logs?service=${svc}&lines=${lines}`);
      const out = document.getElementById('log-output');
      // Store raw lines for filtering
      out._rawLines = d.lines || [];
      renderFilteredLogs();
      out.scrollTop = out.scrollHeight;
    } catch(e) {
      document.getElementById('log-output').innerHTML = '<span class="err">Failed to fetch logs ‚Äî is the API running?</span>';
    }
  }

  function renderFilteredLogs() {
    const out = document.getElementById('log-output');
    const filter = (document.getElementById('log-filter')?.value || '').toLowerCase();
    const levelFilter = document.getElementById('log-level-filter')?.value || '';
    const lines = out._rawLines || [];
    out.innerHTML = '';
    lines.forEach(line => {
      if (filter && !line.toLowerCase().includes(filter)) return;
      if (levelFilter && !line.includes(levelFilter)) return;
      const div = document.createElement('div');
      let cls = 'raw';
      if (/\bERROR\b|\bERR\b|error/i.test(line)) cls = 'err';
      else if (/\bWARN\b|warn/i.test(line)) cls = 'wrn';
      else if (/\bINFO\b|info/i.test(line)) cls = 'inf';
      else if (/started|connected|OK|success/i.test(line)) cls = 'ok';
      div.innerHTML = `<span class="${cls}">${escHtml(line)}</span>`;
      out.appendChild(div);
    });
    out.scrollTop = out.scrollHeight;
  }

  function filterLogs() { renderFilteredLogs(); }

  function clearLogs() { document.getElementById('log-output').innerHTML = ''; }

  function downloadLogs() {
    const text = document.getElementById('log-output').innerText;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'}));
    a.download = 'daggerconnect.log';
    a.click();
    showNotif('Logs exported', '‚¨áÔ∏è');
  }

  let logPolling = false;
  function toggleLogPoll() {
    logPolling = !logPolling;
    document.getElementById('autopoll-btn').textContent = logPolling ? '‚è∏ Stop auto-poll' : '‚ñ∂ Auto-poll (5s)';
    const indicator = document.getElementById('log-stream-indicator');
    if (indicator) indicator.style.display = logPolling ? 'flex' : 'none';
    if (logPolling) {
      fetchLogs();
      logPollTimer = setInterval(fetchLogs, 5000);
    } else {
      clearInterval(logPollTimer);
      logPollTimer = null;
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  CONFIG (YAML)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function loadConfig(target) {
    try {
      const d = await api(`/api/config?target=${target}`);
      if (d.ok) {
        // decode escaped newlines back
        const content = d.content.replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\');
        document.getElementById('yaml-editor').value = content;
        document.getElementById('yaml-file-label').textContent = d.file;
      } else {
        document.getElementById('yaml-editor').value = `# ${d.msg}`;
      }
    } catch(e) {
      document.getElementById('yaml-editor').value = '# Cannot reach API';
    }
  }

  async function loadTemplate(transport) {
    try {
      const d = await api(`/api/config/template?transport=${transport}&role=${NODE_ROLE}`);
      if (d.ok) {
        const content = d.template.replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\');
        document.getElementById('yaml-target').value = NODE_ROLE === 'client' ? 'client' : 'server';
        switchTab('yaml', true);
        document.getElementById('yaml-editor').value = content;
        document.getElementById('yaml-file-label').textContent = `Template: ${transport} (${d.role}) ‚Äî edit PSK before saving!`;
        showNotif(`Template loaded for ${transport} (${d.role}) ‚Äî edit PSK!`, 'üìÑ');
      }
    } catch(e) {
      showNotif('Failed to load template', '‚ùå');
    }
  }

  async function saveYamlRaw() {
    const target = document.getElementById('yaml-target').value;
    const content = document.getElementById('yaml-editor').value;
    try {
      showNotif('Saving config‚Ä¶', '‚è≥');
      const d = await post('/api/config', { target, content });
      if (d.ok) {
        showNotif('Saved! Restarting service‚Ä¶', 'üíæ');
        setTimeout(() => svcAction(target, 'restart'), 800);
      } else {
        showNotif(d.msg, '‚ùå');
      }
    } catch(e) {
      showNotif('API unreachable', '‚ùå');
    }
  }

  async function validateYaml() {
    const txt = document.getElementById('yaml-editor').value;
    const target = document.getElementById('yaml-target').value;
    showNotif('Validating YAML‚Ä¶', 'üîç');
    try {
      const d = await post('/api/config/validate', { target, content: txt });
      showNotif(d.msg || (d.valid ? 'YAML valid ‚úì' : 'YAML invalid'), d.valid ? '‚úÖ' : '‚ö†Ô∏è');
    } catch(e) {
      const keys = [];
      let ok = true;
      for (const line of txt.split('\n')) {
        if (/^[a-z_]+:/.test(line)) {
          const key = line.split(':')[0];
          if (keys.includes(key)) { ok = false; break; }
          keys.push(key);
        }
      }
      showNotif(ok ? 'Basic check: no duplicate keys' : 'Duplicate top-level key!', ok ? '‚úÖ' : '‚ö†Ô∏è');
    }
  }

  let _yamlValidTimer = null;
  function liveValidateYaml() {
    clearTimeout(_yamlValidTimer);
    _yamlValidTimer = setTimeout(() => {
      const txt = document.getElementById('yaml-editor').value;
      const bar = document.getElementById('yaml-validation-bar');
      if (!bar || !txt.trim()) { if(bar) bar.style.display='none'; return; }
      bar.style.display = 'flex';
      // Basic client-side checks
      const errors = [];
      const lines = txt.split('\n');
      const topKeys = [];
      let inList = false;
      lines.forEach((line, i) => {
        if (/^[a-z_]+:/.test(line)) {
          const key = line.split(':')[0];
          if (topKeys.includes(key)) errors.push(`Line ${i+1}: Duplicate key "${key}"`);
          topKeys.push(key);
        }
        // Check for tabs (YAML doesn't allow tabs)
        if (line.includes('\t')) errors.push(`Line ${i+1}: Tab character found (use spaces)`);
      });
      if (!topKeys.includes('mode')) errors.push('Missing required key: mode');
      if (!topKeys.includes('psk')) errors.push('Missing required key: psk');
      if (errors.length === 0) {
        bar.style.background = 'rgba(15,207,142,.08)';
        bar.style.border = '1px solid rgba(15,207,142,.2)';
        bar.style.color = 'var(--accent3)';
        bar.innerHTML = '‚úì Basic validation passed ‚Äî no duplicate keys or syntax issues detected';
      } else {
        bar.style.background = 'rgba(240,75,75,.08)';
        bar.style.border = '1px solid rgba(240,75,75,.2)';
        bar.style.color = 'var(--danger)';
        bar.innerHTML = '‚ö† ' + errors.slice(0, 3).join(' ¬∑ ') + (errors.length > 3 ? ` +${errors.length-3} more` : '');
      }
    }, 600);
  }

  async function confirmSaveYaml() {
    const target = document.getElementById('yaml-target').value;
    const ok = await showConfirmModal('üíæ Apply & Restart', `Save and apply <strong>${target}.yaml</strong>? The ${target} service will restart.`);
    if (ok) saveYamlRaw();
  }

  // ‚îÄ‚îÄ YAML ‚Üí Wizard import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Called from within the wizard ‚Äî fetches current YAML from API then calls importYamlToWizard
  async function wizImportFromYaml() {
    const target = NODE_ROLE === 'client' ? 'client' : 'server';
    try {
      const d = await api(`/api/config?target=${target}`);
      if (!d.ok) { showNotif('Could not load config: ' + (d.msg||'error'), '‚ö†Ô∏è'); return; }
      const content = d.content.replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\');
      // Temporarily put it in the editor so importYamlToWizard can read it
      const editor = document.getElementById('yaml-editor');
      const prev = editor ? editor.value : '';
      if (editor) editor.value = content;
      importYamlToWizard();
    } catch(e) {
      showNotif('Failed to load config', '‚ùå');
    }
  }

  function importYamlToWizard() {
    const yaml = document.getElementById('yaml-editor').value;
    if (!yaml || yaml.startsWith('#') || yaml.startsWith('Loading')) {
      showNotif('Load a config first before importing to wizard', '‚ö†Ô∏è');
      return;
    }
    // Parse key fields from YAML text
    const getVal = (key) => {
      const m = yaml.match(new RegExp('^' + key + ':\\s*["\']?([^"\'\\n]+)["\']?', 'm'));
      return m ? m[1].trim() : '';
    };
    const role = getVal('mode') || 'server';
    const psk  = getVal('psk');
    const prof = getVal('profile') || 'balanced';
    const verbose = /^verbose:\s*true/m.test(yaml);

    // Extract listeners (server) or paths (client)
    const listeners = [];
    const paths = [];
    const listenerBlocks = yaml.match(/^  - addr:[^\n]*\n(?:    [^\n]+\n)*/gm) || [];

    if (role === 'server') {
      listenerBlocks.forEach(block => {
        const addrM = block.match(/addr:\s*["\']?([^"'\n]+)["\']?/);
        const tM    = block.match(/transport:\s*["\']?([^"'\n]+)["\']?/);
        const maps  = [];
        const mapMatches = block.matchAll(/type:\s*(\w+).*?bind:\s*["\']?([^"'\n]+)["\']?.*?target:\s*["\']?([^"'\n]+)["\']?/gs);
        for (const mm of mapMatches) maps.push({ type: mm[1], bind: mm[2], target: mm[3] });
        if (addrM) listeners.push({ addr: addrM[1], transport: tM ? tM[1] : 'httpsmux', maps });
      });
    } else {
      const pathBlocks = yaml.match(/^  - transport:[^\n]*\n(?:    [^\n]+\n)*/gm) || [];
      pathBlocks.forEach(block => {
        const tM    = block.match(/transport:\s*["\']?([^"'\n]+)["\']?/);
        const addrM = block.match(/addr:\s*["\']?([^"'\n]+)["\']?/);
        const pool  = block.match(/connection_pool:\s*(\d+)/);
        if (addrM) paths.push({ transport: tM ? tM[1] : 'httpsmux', addr: addrM[1], pool: pool ? pool[1] : 3 });
      });
    }

    // Pre-fill wizard data ‚Äî start from step 1 (role) so user can walk through and change everything
    const primaryTransport = listeners.length > 0 ? listeners[0].transport : (paths.length > 0 ? paths[0].transport : 'httpsmux');
    wizData = {
      role, psk, profile: prof, verbose,
      transport: primaryTransport,
      ip:   listeners.length > 0 ? (listeners[0].addr.split(':').slice(0,-1).join(':') || '0.0.0.0') : '0.0.0.0',
      port: listeners.length > 0 ? (listeners[0].addr.split(':').pop() || '443') : '443',
      addr: paths.length > 0 ? paths[0].addr : '',
      listeners: listeners.map(l => ({
        addr:      l.addr,
        transport: l.transport,
        ports:     (l.maps || []).map(m => ({ type: m.type, bind: m.bind, target: m.target })),
        tun:       null,
      })),
      paths,
      ports: listeners.length > 0 ? (listeners[0].maps || []).map(m => ({ type: m.type, bind: m.bind, target: m.target })) : [],
    };
    wizStep = 0;   // Always start at step 1 so user reviews everything
    document.getElementById('wizard-modal').classList.add('open');
    renderWizStep();
    showNotif('YAML imported ‚Äî walk through steps to review/change, then Generate', 'üßô');
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  MULTI-LISTENER MANAGEMENT
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let listenerCount = 0;
  function makeListenerHTML(idx) {
    listenerCount++;
    const id = 'lst' + listenerCount;
    return `<div class="card" id="${id}" style="border:1px solid var(--border2)">
      <div class="card-header" style="padding:10px 14px;cursor:pointer" onclick="toggleListenerBody('${id}')">
        <span style="font-size:13px">üì°</span>
        <span class="card-title" id="${id}-title">Listener ${idx}</span>
        <span class="badge b-purple mla" id="${id}-badge">httpsmux ¬∑ :443</span>
        ${idx > 1 ? `<button class="icn-btn d" title="Remove listener" onclick="event.stopPropagation();removeListener('${id}')" style="margin-left:8px">‚úï</button>` : ''}
      </div>
      <div class="card-body" id="${id}-body" style="padding:14px">
        <div class="form-row2" style="margin-bottom:10px">
          <div class="form-group">
            <label>Bind IP</label>
            <input type="text" id="${id}-ip" value="0.0.0.0" oninput="updateListenerBadge('${id}')">
          </div>
          <div class="form-group">
            <label>Port</label>
            <input type="number" id="${id}-port" value="${idx === 1 ? '443' : 80 + (idx-2)*20}" oninput="updateListenerBadge('${id}')">
          </div>
        </div>
        <div class="form-group" style="margin-bottom:10px">
          <label>Transport</label>
          <select id="${id}-transport" onchange="updateListenerBadge('${id}')">
            <option value="httpsmux">httpsmux ‚Äî HTTPS Mimicry ‚≠ê</option>
            <option value="httpmux">httpmux ‚Äî HTTP Mimicry</option>
            <option value="wssmux">wssmux ‚Äî WebSocket Secure</option>
            <option value="wsmux">wsmux ‚Äî WebSocket</option>
            <option value="kcpmux">kcpmux ‚Äî KCP (UDP)</option>
            <option value="tcpmux">tcpmux ‚Äî TCP Mux</option>
            <option value="rawmux">rawmux ‚Äî Raw TCP Mux</option>
            <option value="daggermux">daggermux ‚Äî DaggerMux ‚ö°</option>
          </select>
        </div>
        <div style="margin-bottom:6px">
          <div style="font-family:'Geist Mono',monospace;font-size:9px;letter-spacing:.1em;color:var(--text2);text-transform:uppercase;margin-bottom:8px">Port Maps</div>
          <div id="${id}-maps" style="display:flex;flex-direction:column;gap:6px"></div>
          <button class="btn btn-ghost" style="margin-top:8px;font-size:10px;padding:4px 8px" onclick="addListenerMap('${id}')">+ Add Map</button>
        </div>
        <!-- TUN config -->
        <div style="margin-top:10px">
          <div class="toggle-row" style="margin-bottom:8px">
            <label>Enable TUN Interface</label>
            <div class="toggle" id="${id}-tun-en" onclick="this.classList.toggle('on');toggleTunSection('${id}')"></div>
          </div>
          <div id="${id}-tun-section" style="display:none;background:rgba(79,142,247,.04);border:1px solid rgba(79,142,247,.12);border-radius:8px;padding:12px">
            <div class="form-row2">
              <div class="form-group"><label>TUN Name</label><input type="text" id="${id}-tun-name" value="dagger${idx-1}" placeholder="dagger0"></div>
              <div class="form-group"><label>MTU</label><input type="number" id="${id}-tun-mtu" value="1400"></div>
            </div>
            <div class="form-row2">
              <div class="form-group"><label>Local IP (server)</label><input type="text" id="${id}-tun-local" value="10.0.${idx-1}.1" placeholder="10.0.0.1"></div>
              <div class="form-group"><label>Peer IP (client)</label><input type="text" id="${id}-tun-peer" value="10.0.${idx-1}.2" placeholder="10.0.0.2"></div>
            </div>
            <div class="hint">local_ip = this server's TUN IP ¬∑ peer_ip = client's TUN IP. Must match client path TUN config.</div>
          </div>
        </div>
      </div>
    </div>`;
  }

  function toggleListenerBody(id) {
    const body = document.getElementById(id + '-body');
    if (body) body.style.display = body.style.display === 'none' ? 'block' : 'none';
  }

  function updateListenerBadge(id) {
    const transport = document.getElementById(id + '-transport')?.value || 'httpsmux';
    const port = document.getElementById(id + '-port')?.value || '443';
    const badge = document.getElementById(id + '-badge');
    if (badge) badge.textContent = transport + ' ¬∑ :' + port;
  }

  function toggleTunSection(id) {
    const en = document.getElementById(id + '-tun-en');
    const sec = document.getElementById(id + '-tun-section');
    if (sec) sec.style.display = en?.classList.contains('on') ? 'block' : 'none';
  }

  let _listenerMapCounters = {};
  function addListenerMap(listId, type, bind, target) {
    if (!_listenerMapCounters[listId]) _listenerMapCounters[listId] = 0;
    _listenerMapCounters[listId]++;
    const mid = listId + '-map' + _listenerMapCounters[listId];
    const mapsEl = document.getElementById(listId + '-maps');
    if (!mapsEl) return;
    const div = document.createElement('div');
    div.id = mid;
    div.style.cssText = 'display:grid;grid-template-columns:80px 1fr 1fr auto;gap:6px;align-items:center';
    const selTcp = (!type || type === 'tcp') ? 'selected' : '';
    const selUdp = (type === 'udp') ? 'selected' : '';
    const selBoth = (type === 'both') ? 'selected' : '';
    div.innerHTML = `
      <select style="font-size:11px">
        <option value="tcp" ${selTcp}>TCP</option><option value="udp" ${selUdp}>UDP</option><option value="both" ${selBoth}>Both</option>
      </select>
      <input type="text" placeholder="0.0.0.0:8080" style="font-size:11px" value="${bind||''}">
      <input type="text" placeholder="127.0.0.1:80" style="font-size:11px" value="${target||''}">
      <button class="icn-btn d" onclick="document.getElementById('${mid}').remove()" style="flex-shrink:0">‚úï</button>`;
    mapsEl.appendChild(div);
  }

  function removeListener(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
  }

  function addListener(silent) {
    const container = document.getElementById('listeners-container');
    const count = container.querySelectorAll('.card').length + 1;
    const div = document.createElement('div');
    div.innerHTML = makeListenerHTML(count);
    const card = div.firstElementChild;        // grab reference BEFORE appendChild moves it
    container.appendChild(card);
    addListenerMap(card.id);
    if (!silent) showNotif('Listener ' + count + ' added', 'üì°');
  }

  function initListeners() {
    const container = document.getElementById('listeners-container');
    if (container && container.children.length === 0) {
      const div = document.createElement('div');
      div.innerHTML = makeListenerHTML(1);
      container.appendChild(div.firstElementChild);
      const id = container.querySelector('.card').id;
      addListenerMap(id);
    }
  }

  function buildServerYaml() {
    const psk       = document.getElementById('srv-psk').value || 'CHANGEME';
    const profile   = document.getElementById('srv-profile').value || 'balanced';
    const verbose   = document.getElementById('srv-verbose').classList.contains('on');
    const nodelay   = document.getElementById('tcp-nodelay').classList.contains('on');
    const tcpKa     = document.getElementById('tcp-ka').value || '15';
    const maxConn   = document.getElementById('max-conn').value || '5000';
    const smuxKa    = document.getElementById('smux-ka').value || '5';
    const smuxFrame = document.getElementById('smux-frame').value || '32768';
    const smuxRecv  = document.getElementById('smux-recv').value || '16777216';
    const mimicDom  = document.getElementById('mimic-domain').value || 'www.google.com';
    const mimicPath = document.getElementById('mimic-path').value || '/search';
    const mimicCook = document.getElementById('mimic-cookies').classList.contains('on');
    const obEn      = document.getElementById('obfusc-en') ? document.getElementById('obfusc-en').classList.contains('on') : false;
    const obPadMin  = document.getElementById('ob-padmin') ? document.getElementById('ob-padmin').value : '16';
    const obPadMax  = document.getElementById('ob-padmax') ? document.getElementById('ob-padmax').value : '256';
    const obDelMin  = document.getElementById('ob-delmin') ? document.getElementById('ob-delmin').value : '5';
    const obDelMax  = document.getElementById('ob-delmax') ? document.getElementById('ob-delmax').value : '50';
    const obBurst   = (parseFloat(document.getElementById('ob-burst') ? document.getElementById('ob-burst').value : '15') / 100).toFixed(2);

    // Collect all listeners
    const listenerCards = document.querySelectorAll('#listeners-container > .card');
    let hasCert = false; let hasMimic = false;
    let listenersYaml = '';
    listenerCards.forEach(card => {
      const id = card.id;
      const ip = document.getElementById(id + '-ip')?.value || '0.0.0.0';
      const port = document.getElementById(id + '-port')?.value || '443';
      const transport = document.getElementById(id + '-transport')?.value || 'httpsmux';
      const needsCert  = ['httpsmux','wssmux'].includes(transport);
      const needsMimic = ['httpsmux','httpmux','wssmux','wsmux'].includes(transport);
      if (needsCert) hasCert = true;
      if (needsMimic) hasMimic = true;

      // Collect maps
      let mapsYaml = '';
      card.querySelectorAll('[id^="' + id + '-map"]').forEach(mapEl => {
        const inputs = mapEl.querySelectorAll('input');
        const sel    = mapEl.querySelector('select');
        const type   = sel?.value || 'tcp';
        const bind   = inputs[0]?.value.trim();
        const target = inputs[1]?.value.trim();
        if (bind && target) mapsYaml += `      - type: ${type}\n        bind: "${bind}"\n        target: "${target}"\n`;
      });
      if (!mapsYaml) mapsYaml = '      - type: tcp\n        bind: "0.0.0.0:2222"\n        target: "127.0.0.1:22"\n';

      // TUN
      const tunEn    = document.getElementById(id + '-tun-en')?.classList.contains('on');
      const tunName  = document.getElementById(id + '-tun-name')?.value || 'dagger0';
      const tunLocal = document.getElementById(id + '-tun-local')?.value || '10.0.0.1';
      const tunPeer  = document.getElementById(id + '-tun-peer')?.value  || '10.0.0.2';
      const tunMtu   = document.getElementById(id + '-tun-mtu')?.value   || '1400';

      listenersYaml += `  - addr: "${ip}:${port}"\n    transport: "${transport}"\n`;
      if (needsCert) listenersYaml += `    cert_file: "/etc/DaggerConnect/certs/cert.pem"\n    key_file: "/etc/DaggerConnect/certs/key.pem"\n`;
      listenersYaml += `    maps:\n${mapsYaml}`;
      if (tunEn) listenersYaml += `    tun:\n      enabled: true\n      name: "${tunName}"\n      local_ip: "${tunLocal}"\n      peer_ip: "${tunPeer}"\n      mtu: ${tunMtu}\n`;
    });

    let yaml = `mode: "server"\npsk: "${psk}"\nprofile: "${profile}"\nverbose: ${verbose}\n`;
    if (hasCert)  yaml += `\ncert_file: "/etc/DaggerConnect/certs/cert.pem"\nkey_file: "/etc/DaggerConnect/certs/key.pem"\n`;
    if (hasMimic) yaml += `\nhttp_mimic:\n  fake_domain: "${mimicDom}"\n  fake_path: "${mimicPath}"\n  session_cookie: ${mimicCook}\n`;
    yaml += `\nlisteners:\n${listenersYaml}`;
    yaml += `\nsmux:\n  keepalive_interval: ${smuxKa}\n  max_frame_size: ${smuxFrame}\n  max_receive_buffer: ${smuxRecv}\n`;
    yaml += `\ntcp:\n  nodelay: ${nodelay}\n  keepalive: ${tcpKa}\n  max_connections: ${maxConn}\n`;
    yaml += `\nobfuscation:\n  enabled: ${obEn}\n  min_padding: ${obPadMin}\n  max_padding: ${obPadMax}\n  min_delay_ms: ${obDelMin}\n  max_delay_ms: ${obDelMax}\n  burst_chance: ${obBurst}\n`;
    return yaml;
  }

  function buildClientYaml() {
    const psk     = document.getElementById('cli-psk').value || 'CHANGEME';
    const profile = document.getElementById('cli-profile').value || 'balanced';
    const verbose = document.getElementById('cli-verbose').classList.contains('on');
    let pathsYaml = '';
    document.querySelectorAll('#client-paths .path-item').forEach(item => {
      const transport = item.querySelectorAll('select')[0]?.value || 'httpsmux';
      const addr      = item.querySelectorAll('input[type=text]')[0]?.value.trim() || 'SERVER_IP:443';
      const pool      = item.querySelectorAll('input[type=number]')[0]?.value || '3';
      const retry     = item.querySelectorAll('input[type=number]')[1]?.value || '5';
      const timeout   = item.querySelectorAll('input[type=number]')[2]?.value || '20';
      const agg       = item.querySelector('.toggle')?.classList.contains('on') ?? true;
      pathsYaml += `  - transport: "${transport}"\n    addr: "${addr}"\n    connection_pool: ${pool}\n    aggressive_pool: ${agg}\n    retry_interval: ${retry}\n    dial_timeout: ${timeout}\n`;
    });
    if (!pathsYaml) pathsYaml = '  - transport: "httpsmux"\n    addr: "SERVER_IP:443"\n    connection_pool: 3\n    aggressive_pool: true\n    retry_interval: 5\n    dial_timeout: 20\n';
    let yaml = `mode: "client"\npsk: "${psk}"\nprofile: "${profile}"\nverbose: ${verbose}\n`;
    yaml += `\nhttp_mimic:\n  fake_domain: "www.google.com"\n  fake_path: "/search"\n  session_cookie: true\n`;
    yaml += `\npaths:\n${pathsYaml}`;
    yaml += `\nobfuscation:\n  enabled: false\n  min_padding: 16\n  max_padding: 256\n  min_delay_ms: 5\n  max_delay_ms: 50\n  burst_chance: 0.15\n`;
    return yaml;
  }

  async function saveAndRestart(target) {
    const yaml = target === 'client' ? buildClientYaml() : buildServerYaml();
    document.getElementById('yaml-target').value = target;
    switchTab('yaml', true);
    document.getElementById('yaml-editor').value = yaml;
    document.getElementById('yaml-file-label').textContent = `Preview ‚Äî /etc/DaggerConnect/${target}.yaml  (click Apply & Restart to save)`;
    showNotif('Review YAML below, then click Apply & Restart', '‚ÑπÔ∏è');
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  PORT MAPS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function loadPortMaps() {
    try {
      const d = await api('/api/portmaps');
      const maps = d.maps || [];

      // Dashboard mini
      const dash = document.getElementById('portmap-dash');
      if (dash) {
        if (maps.length === 0) {
          dash.innerHTML = '<div class="text-muted text-sm text-mono" style="padding:14px">No port mappings found in server.yaml</div>';
        } else {
          dash.innerHTML = '<div style="padding:10px 14px">' +
                  maps.slice(0,4).map(m =>
                          `<div class="pm-item mb8">
              <span class="badge ${m.type==='udp'?'b-amber':'b-cyan'}">${m.type.toUpperCase()}</span>
              <span class="text-mono text-xs">${m.bind}</span>
              <span class="text-accent" style="font-size:13px">‚Üí</span>
              <span class="text-mono text-xs">${m.target}</span>
              <span class="badge b-cyan mla">Configured</span>
            </div>`
                  ).join('') + '</div>';
        }
      }

      // Port table
      const tb = document.getElementById('port-table');
      if (tb) {
        if (maps.length === 0) {
          tb.innerHTML = '<tr><td colspan="8" class="text-muted text-mono text-sm" style="padding:16px">No mappings in server.yaml</td></tr>';
        } else {
          tb.innerHTML = maps.map((m, i) => {
            return `<tr>
            <td class="text-mono text-muted">${i+1}</td>
            <td><span class="badge ${m.type==='udp'?'b-amber':m.type==='both'?'b-purple':'b-cyan'}">${m.type.toUpperCase()}</span></td>
            <td class="text-mono text-sm">${m.bind}</td>
            <td class="text-accent">‚Üí</td>
            <td class="text-mono text-sm">${m.target}</td>
            <td><span class="badge b-purple" style="font-size:9px">${m.transport||'‚Äî'}</span></td>
            <td class="text-mono text-sm" style="color:var(--text3);font-size:10px">${m.listener||'‚Äî'}</td>
            <td><span class="badge b-green">Active</span></td>
          </tr>`;
          }).join('');
        }
      }
    } catch(e) {
      console.warn('portmaps failed', e);
    }
  }

  async function addPortMap() {
    const proto    = document.getElementById('pm-proto').value;
    const bindIp   = document.getElementById('pm-bind-ip').value || '0.0.0.0';
    const bindPort = document.getElementById('pm-bind-port').value;
    const tgtIp    = document.getElementById('pm-tgt-ip').value || '127.0.0.1';
    const tgtPort  = document.getElementById('pm-tgt-port').value;
    if (!bindPort || !tgtPort) { showNotif('Fill in all port fields', '‚ö†Ô∏è'); return; }

    document.getElementById('add-port-modal').classList.remove('open');

    // Always load fresh server.yaml so we're editing the real current config
    showNotif('Loading server.yaml‚Ä¶', '‚è≥');
    let yaml = document.getElementById('yaml-editor').value;
    const isStale = !yaml || yaml.startsWith('# ') || yaml.startsWith('Loading');
    if (isStale) {
      try {
        const d = await api('/api/config?target=server');
        if (d.ok) {
          yaml = d.content.replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\');
          document.getElementById('yaml-target').value = 'server';
        } else {
          showNotif('Could not load server.yaml: ' + d.msg, '‚ùå'); return;
        }
      } catch(e) {
        showNotif('API unreachable', '‚ùå'); return;
      }
    }

    const entry = `      - type: ${proto}\n        bind: "${bindIp}:${bindPort}"\n        target: "${tgtIp}:${tgtPort}"`;
    let updated;
    if (yaml.includes('    maps:')) {
      updated = yaml.replace(/(    maps:(?:\n(?:      - .*|        .*|\s*))*)/,
              (m) => m.trimEnd() + '\n' + entry + '\n');
    } else {
      // Find end of first listener block and inject maps: there
      updated = yaml + '\n    maps:\n' + entry + '\n';
    }

    document.getElementById('yaml-target').value = 'server';
    switchTab('yaml', true);
    document.getElementById('yaml-editor').value = updated;
    document.getElementById('yaml-file-label').textContent = 'Preview ‚Äî will save to /etc/DaggerConnect/server.yaml';
    showNotif('Mapping added ‚Äî review and click Apply & Restart', 'üîå');
  }

  async function deletePortMap(bindEnc, targetEnc, typeEnc) {
    const bind   = decodeURIComponent(bindEnc);
    const target = decodeURIComponent(targetEnc);
    const type   = decodeURIComponent(typeEnc);
    const confirmed = await showConfirmModal(
      'Delete Port Mapping',
      `Remove: <code>${type.toUpperCase()} ${bind} ‚Üí ${target}</code>?<br><br>This will edit <code>server.yaml</code> and restart the server service.`
    );
    if (!confirmed) return;
    showNotif('Removing mapping‚Ä¶', '‚è≥');
    try {
      const d = await api('/api/config?target=server');
      if (!d.ok) { showNotif('Could not load server.yaml: ' + d.msg, '‚ùå'); return; }
      const yaml = d.content.replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\');
      // Remove the map entry block matching bind + target
      const lines = yaml.split('\n');
      const out = [];
      let i = 0;
      while (i < lines.length) {
        const l = lines[i];
        if (/^\s+- type:/.test(l)) {
          // Collect the full map entry (type + bind + target lines)
          let j = i + 1;
          while (j < lines.length && /^\s{8,}/.test(lines[j])) j++;
          const block = lines.slice(i, j).join('\n');
          if (block.includes('"' + bind + '"') && block.includes('"' + target + '"')) {
            i = j; continue; // skip this block
          }
        }
        out.push(l);
        i++;
      }
      const newYaml = out.join('\n');
      const d2 = await post('/api/config', { target: 'server', content: newYaml });
      if (d2.ok) {
        showNotif('Mapping removed ‚Äî review in YAML editor', '‚úÖ');
        document.getElementById('yaml-target').value = 'server';
        switchTab('yaml', true);
        document.getElementById('yaml-editor').value = newYaml;
        document.getElementById('yaml-file-label').textContent = 'Preview ‚Äî /etc/DaggerConnect/server.yaml (click Apply & Restart to save)';
      } else {
        showNotif('Save failed: ' + d2.msg, '‚ùå');
      }
    } catch(e) {
      showNotif('Error: ' + e.message, '‚ùå');
    }
  }

  async function applyDaggerMuxConfig() {
    const dataShard   = parseInt(document.getElementById('fec-data').value) || 10;
    const parityShard = parseInt(document.getElementById('fec-parity').value) || 1;
    const port        = parseInt(document.getElementById('ipt-port').value) || 2020;
    showNotif('Loading server.yaml‚Ä¶', '‚è≥');
    try {
      const d = await api('/api/config?target=server');
      if (!d.ok) { showNotif('Could not load server.yaml: ' + d.msg, '‚ùå'); return; }
      let yaml = d.content.replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\');
      // Replace or append daggermux block
      const block = `daggermux:\n  mtu: 1350\n  snd_wnd: 1024\n  rcv_wnd: 1024\n  data_shard: ${dataShard}\n  parity_shard: ${parityShard}\n  sock_buf: 4194304\n  local_flags:\n    - "PA"\n    - "A"\n  remote_flags:\n    - "PA"\n    - "A"`;
      if (yaml.includes('\ndaggermux:')) {
        yaml = yaml.replace(/\ndaggermux:[\s\S]*?(?=\n[a-z]|$)/, '\n' + block);
      } else {
        yaml = yaml.trimEnd() + '\n\n' + block + '\n';
      }
      document.getElementById('yaml-target').value = 'server';
      switchTab('yaml', true);
      document.getElementById('yaml-editor').value = yaml;
      document.getElementById('yaml-file-label').textContent = 'Preview ‚Äî /etc/DaggerConnect/server.yaml  (click Apply & Restart to save)';
      showNotif('DaggerMux config applied ‚Äî review and click Apply & Restart', '‚ö°');
    } catch(e) {
      showNotif('API error: ' + e.message, '‚ùå');
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  CONNECTIONS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function loadConnections() {
    try {
      const d = await api('/api/connections');
      const tb = document.getElementById('conn-table');
      const badge = document.getElementById('conn-count-badge');

      if (!d.connections || d.connections.length === 0) {
        tb.innerHTML = `<tr><td colspan="4" class="text-muted text-mono text-sm" style="padding:14px">No active connections (role: ${d.role || 'unknown'}${d.ports && d.ports.length ? ', ports: ' + d.ports.join(', ') : ''})</td></tr>`;
        if (badge) { badge.textContent = '0'; badge.style.display = 'none'; }
        return;
      }

      // Group by port
      const byPort = {};
      d.connections.forEach(c => {
        const p = c.port || '?';
        if (!byPort[p]) byPort[p] = [];
        byPort[p].push(c);
      });

      let html = '';
      Object.keys(byPort).sort().forEach(port => {
        html += `<tr style="background:var(--bg3)"><td colspan="4" class="text-xs" style="padding:5px 12px;color:var(--text3)">Port ${port} ‚Äî ${byPort[port].length} connection(s)</td></tr>`;
        byPort[port].forEach(c => {
          const stateCls = c.state === 'ESTAB' ? 'b-green' : c.state && c.state.includes('TIME') ? 'b-amber' : 'b-red';
          html += `<tr>
          <td class="text-mono text-sm" style="cursor:pointer" title="Click to copy" onclick="navigator.clipboard?.writeText('${escHtml(c.local)}')">${escHtml(c.local)}</td>
          <td class="text-mono text-sm" style="cursor:pointer" title="Click to copy" onclick="navigator.clipboard?.writeText('${escHtml(c.remote)}')">${escHtml(c.remote)}</td>
          <td><span class="badge ${stateCls}">${escHtml(c.state || 'ESTAB')}</span></td>
          <td class="text-mono text-xs text-muted">${port}</td>
        </tr>`;
        });
      });

      tb.innerHTML = html;
      const total = d.connections.length;
      if (badge) { badge.textContent = total; badge.style.display = total > 0 ? '' : 'none'; }

      // Track connection history
      d.connections.forEach(c => {
        const key = c.remote + ':' + c.port;
        if (!connHistoryMap[key]) {
          connHistoryMap[key] = { remote: c.remote, port: c.port, state: c.state, since: Date.now(), seen: true };
          renderConnHistory();
        } else {
          connHistoryMap[key].seen = true;
          connHistoryMap[key].state = c.state;
        }
      });
      // Mark disconnected connections
      Object.keys(connHistoryMap).forEach(k => {
        if (!connHistoryMap[k].seen) {
          if (!connHistoryMap[k].ended) connHistoryMap[k].ended = Date.now();
        }
        connHistoryMap[k].seen = false;
      });

      // daggermux note
      if (d.daggermux_note) {
        const noteEl = document.getElementById('conn-daggermux-note');
        if (noteEl) noteEl.textContent = d.daggermux_note;
      }
    } catch(e) {
      showNotif('Cannot load connections', '‚ùå');
    }
  }

  let connHistoryMap = {};
  function renderConnHistory() {
    const tb = document.getElementById('conn-history-table');
    if (!tb) return;
    const entries = Object.values(connHistoryMap).sort((a,b) => b.since - a.since).slice(0, 50);
    if (entries.length === 0) { tb.innerHTML = '<tr><td colspan="5" class="text-muted text-mono text-sm" style="padding:14px">No history yet.</td></tr>'; return; }
    tb.innerHTML = entries.map(e => {
      const dur = e.ended ? Math.round((e.ended - e.since) / 1000) + 's' : 'active';
      const stateCls = !e.ended ? 'b-green' : 'b-red';
      const stateLabel = !e.ended ? 'connected' : 'disconnected';
      const time = new Date(e.since).toLocaleTimeString('en-US', { hour12: false });
      return `<tr>
        <td class="text-mono text-xs">${time}</td>
        <td class="text-mono text-sm">${escHtml(e.remote)}</td>
        <td class="text-mono text-xs text-muted">${e.port}</td>
        <td><span class="badge ${stateCls}">${stateLabel}</span></td>
        <td class="text-mono text-xs text-muted">${dur}</td>
      </tr>`;
    }).join('');
  }

  function clearConnHistory() {
    connHistoryMap = {};
    renderConnHistory();
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  CERT GENERATION
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function generateCert() {
    const cn = document.getElementById('cert-cn').value;
    const days = document.getElementById('cert-days').value;
    showNotif('Generating certificate (takes ~10s)‚Ä¶', 'üîí');
    try {
      const d = await post('/api/cert/generate', { cn, days: parseInt(days) });
      if (d.ok) {
        showNotif('Certificate generated! Expires: ' + d.expires, 'üîí');
        loadCertInfo();
      } else {
        showNotif('Cert gen failed: ' + d.msg, '‚ùå');
      }
    } catch(e) {
      showNotif('API unreachable', '‚ùå');
    }
  }

  async function loadCertInfo() {
    try {
      const d = await api('/api/cert/info');
      const el = document.getElementById('cert-info-block');
      if (!el) return;
      if (d.ok) {
        const color = d.days_left > 30 ? 'var(--accent3)' : d.days_left > 7 ? 'var(--accent4)' : 'var(--danger)';
        el.innerHTML = `
        <div class="flex"><span class="text-muted text-xs">CN</span><span class="text-mono text-xs mla">${d.cn}</span></div>
        <div class="flex"><span class="text-muted text-xs">Expires</span><span class="text-mono text-xs mla">${d.expires}</span></div>
        <div class="flex"><span class="text-muted text-xs">Days Left</span><span class="text-mono text-xs mla" style="color:${color}">${d.days_left}d</span></div>`;
      } else {
        el.innerHTML = '<span class="text-muted text-sm">No certificate found ‚Äî generate one below.</span>';
      }
    } catch(e) {}
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  PSK
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function generatePSK(targetId) {
    try {
      const d = await api('/api/psk/generate');
      if (d.ok) {
        document.getElementById(targetId).value = d.psk;
        showNotif('PSK generated via openssl', 'üîë');
      }
    } catch(e) {
      // Fallback: browser-side random
      const arr = new Uint8Array(32);
      crypto.getRandomValues(arr);
      const b64 = btoa(String.fromCharCode(...arr));
      document.getElementById(targetId).value = b64;
      showNotif('PSK generated (browser fallback)', 'üîë');
    }
  }

  function copyPSK(targetId) {
    const src = document.getElementById('gen-psk').value;
    document.getElementById(targetId).value = src;
    showNotif('PSK copied to ' + targetId, 'üìã');
  }

  function toggleInput(id) {
    const el = document.getElementById(id);
    el.type = el.type === 'password' ? 'text' : 'password';
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  OBFUSCATION PRESETS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function applyOb(padMin, padMax, delMin, delMax, burst) {
    document.getElementById('ob-padmin').value = padMin;
    document.getElementById('ob-padmin-lbl').textContent = padMin;
    document.getElementById('ob-padmax').value = padMax;
    document.getElementById('ob-padmax-lbl').textContent = padMax;
    document.getElementById('ob-delmin').value = delMin;
    document.getElementById('ob-delmin-lbl').textContent = delMin;
    document.getElementById('ob-delmax').value = delMax;
    document.getElementById('ob-delmax-lbl').textContent = delMax;
    document.getElementById('ob-burst').value = burst;
    document.getElementById('ob-burst-lbl').textContent = (burst/100).toFixed(2);
    document.getElementById('obfusc-en').classList[padMax > 0 ? 'add' : 'remove']('on');
    showNotif('Preset applied ‚Äî save via server config', 'üé≠');
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  PROFILE SELECT
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function selProfile(el, val) {
    el.closest('.prof-grid').querySelectorAll('.prof-card').forEach(c => c.classList.remove('sel'));
    el.classList.add('sel');
    document.getElementById('srv-profile').value = val;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  CLIENT PATHS UI
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let pathCount = 1;

  function makePathHTML(num, labelText, badgeClass, badgeText) {
    return `<div class="path-hdr" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'" style="display:flex;align-items:center;gap:8px;padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border)">
    <div class="path-num">${num}</div>
    <span style="flex:1;font-size:12px;font-weight:700">${labelText}</span>
    <span class="badge ${badgeClass}" style="margin-right:4px">${badgeText}</span>
    <button class="icn-btn d" title="Remove path" style="flex-shrink:0" onclick="event.stopPropagation();removeClientPath(this)">‚úï</button>
  </div>
  <div class="path-body" style="padding:14px">
    <div class="form-row2">
      <div class="form-group"><label>Transport</label>
        <select><option value="httpsmux">httpsmux</option><option value="httpmux">httpmux</option><option value="wssmux">wssmux</option><option value="wsmux">wsmux</option><option value="kcpmux">kcpmux</option><option value="tcpmux">tcpmux</option><option value="rawmux">rawmux</option><option value="daggermux">daggermux</option></select>
      </div>
      <div class="form-group"><label>Server Address</label><input type="text" placeholder="ip:port"></div>
    </div>
    <div class="form-row3">
      <div class="form-group"><label>Pool</label><input type="number" value="3" min="1" max="16"></div>
      <div class="form-group"><label>Retry (s)</label><input type="number" value="5" min="1"></div>
      <div class="form-group"><label>Timeout (s)</label><input type="number" value="20" min="1"></div>
    </div>
    <div class="toggle-row"><label>Aggressive Pool</label><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
  </div>`;
  }

  function removeClientPath(btn) {
    const c = document.getElementById('client-paths');
    if (c.querySelectorAll('.path-item').length <= 1) { showNotif('Need at least one path', '‚ö†Ô∏è'); return; }
    btn.closest('.path-item').remove();
    c.querySelectorAll('.path-item .path-num').forEach((el, i) => el.textContent = i + 1);
    pathCount = c.querySelectorAll('.path-item').length;
    showNotif('Path removed', 'üóë');
  }

  function addClientPath() {
    pathCount++;
    const div = document.createElement('div');
    div.className = 'path-item';
    div.innerHTML = makePathHTML(pathCount, 'New Path', 'b-red', 'Unconfigured');
    document.getElementById('client-paths').appendChild(div);
    showNotif('Path added', 'üõ£Ô∏è');
  }

  // Initial client path
  (function() {
    const div = document.createElement('div');
    div.className = 'path-item';
    div.innerHTML = makePathHTML(1, 'Primary ‚Äî httpsmux', 'b-green', 'Primary');
    document.getElementById('client-paths').appendChild(div);
  })();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  MOBILE SIDEBAR
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function toggleSidebar() {
    const sb = document.querySelector('.sidebar');
    const ov = document.getElementById('sidebar-overlay');
    sb.classList.toggle('mob-open');
    ov.classList.toggle('open');
  }

  // Close sidebar when a nav item is clicked on mobile
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.nav-item').forEach(el => {
      el.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          document.querySelector('.sidebar').classList.remove('mob-open');
          document.getElementById('sidebar-overlay').classList.remove('open');
        }
      });
    });
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  LICENSE KEY FUNCTIONS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  TRANSPORT PANEL SELECTOR
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let _currentTransport = 'httpsmux';

  function selectTransport(t) {
    _currentTransport = t;
    const sel = document.getElementById('transport-selector');
    if (sel) sel.value = t;
    showTransportPanel(t);
  }

  function showTransportPanel(t) {
    _currentTransport = t;
    const allPanels = ['tpanel-mimic','tpanel-kcp','tpanel-rawmux','tpanel-tcpmux','tpanel-daggermux'];
    allPanels.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });

    // Highlight selected row
    document.querySelectorAll('[id^="trow-"]').forEach(r => r.style.outline = '');
    const row = document.getElementById('trow-' + t);
    if (row) row.style.outline = '2px solid var(--accent)';

    const hasMimic = ['httpsmux','httpmux','wssmux','wsmux'].includes(t);
    const hasTls   = ['httpsmux','wssmux'].includes(t);

    if (hasMimic) {
      const panel = document.getElementById('tpanel-mimic');
      if (panel) panel.style.display = '';
      const colors = { httpsmux:'b-cyan', httpmux:'b-purple', wssmux:'b-cyan', wsmux:'b-purple' };
      const badge = document.getElementById('tpanel-mimic-badge');
      if (badge) { badge.textContent = t; badge.className = 'badge ' + (colors[t]||'b-cyan') + ' mla'; }
      const tlsNote = document.getElementById('tpanel-tls-note');
      if (tlsNote) { tlsNote.textContent = hasTls ? 'TLS enabled' : 'No TLS'; tlsNote.className = 'badge ' + (hasTls ? 'b-green' : 'b-amber'); }
      const tlsSect = document.getElementById('tls-cert-section');
      if (tlsSect) tlsSect.style.display = hasTls ? '' : 'none';
    } else if (t === 'kcpmux') {
      const panel = document.getElementById('tpanel-kcp');
      if (panel) panel.style.display = '';
      calcFEC();
    } else if (t === 'rawmux') {
      const panel = document.getElementById('tpanel-rawmux');
      if (panel) panel.style.display = '';
    } else if (t === 'tcpmux') {
      const panel = document.getElementById('tpanel-tcpmux');
      if (panel) panel.style.display = '';
    } else if (t === 'daggermux') {
      const panel = document.getElementById('tpanel-daggermux');
      if (panel) panel.style.display = '';
      calcFEC();
    }
  }

  // ‚îÄ‚îÄ Preview in YAML Editor ‚Äî reads current YAML and patches transport block ‚îÄ‚îÄ
  async function previewTransportYaml() {
    const t = _currentTransport || document.getElementById('transport-selector')?.value || 'httpsmux';
    try {
      const target = NODE_ROLE === 'client' ? 'client' : 'server';
      const d = await api('/api/config?target=' + target);
      let yaml = d.ok
        ? d.content.replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\')
        : _buildTransportYamlFromScratch(t);

      yaml = _patchTransportInYaml(yaml, t);

      document.getElementById('yaml-target').value = target;
      switchTab('yaml', true);
      document.getElementById('yaml-editor').value = yaml;
      document.getElementById('yaml-file-label').textContent =
        `Preview ‚Äî transport: ${t}  (click Apply & Restart to save)`;
      showNotif('Transport settings patched into YAML ‚Äî review and save', '‚ÑπÔ∏è');
    } catch(e) {
      showNotif('Could not load config: ' + e.message, '‚ùå');
    }
  }

  function _buildTransportYamlFromScratch(t) {
    return `mode: "server"\npsk: "CHANGEME"\nprofile: "balanced"\nverbose: false\n\nlisteners:\n  - addr: "0.0.0.0:443"\n    transport: "${t}"\n    maps:\n      - type: tcp\n        bind: "0.0.0.0:8080"\n        target: "127.0.0.1:8080"\n`;
  }

  function _patchTransportInYaml(yaml, t) {
    const hasMimic = ['httpsmux','httpmux','wssmux','wsmux'].includes(t);
    const hasTls   = ['httpsmux','wssmux'].includes(t);

    // Helper: replace a top-level YAML block (key: ...) safely.
    // Matches from "^key:" up to (but not including) the next top-level key or end of string.
    function replaceBlock(src, key, newBlock) {
      // Build regex: match from ^key: to just before the next ^[a-z] line or end of string
      const re = new RegExp('(^' + key + ':[ \\t]*\\n(?:(?!^[a-z])[\\s\\S])*)', 'm');
      if (re.test(src)) {
        return src.replace(re, newBlock);
      }
      return src.trimEnd() + '\n\n' + newBlock;
    }

    // 1. Always patch the transport field in all listeners entries
    yaml = yaml.replace(/^([ \t]+transport:[ \t]*)["']?\w+["']?/gm,
      `$1"${t}"`);

    // 2. Patch http_mimic block if mimic transport
    if (hasMimic) {
      const domEl    = document.getElementById('mimic-domain');
      const pathEl   = document.getElementById('mimic-path');
      const cookEl   = document.getElementById('mimic-cookies');
      const customEl = document.getElementById('mimic-custom-domain');
      const domain   = domEl?.value === 'custom' ? (customEl?.value || 'www.google.com') : (domEl?.value || 'www.google.com');
      const fakePath = pathEl?.value || '/search';
      const cookie   = cookEl?.classList.contains('on') ? 'true' : 'false';
      const certFile = document.getElementById('tls-cert-file')?.value || '/etc/DaggerConnect/certs/cert.pem';
      const keyFile  = document.getElementById('tls-key-file')?.value  || '/etc/DaggerConnect/certs/key.pem';

      const mimicBlock = `http_mimic:\n  fake_domain: "${domain}"\n  fake_path: "${fakePath}"\n  session_cookie: ${cookie}\n`;
      yaml = replaceBlock(yaml, 'http_mimic', mimicBlock);

      // Patch cert/key if TLS
      if (hasTls) {
        if (/^cert_file:/m.test(yaml)) {
          yaml = yaml.replace(/^cert_file:\s*.+/m, `cert_file: "${certFile}"`);
          yaml = yaml.replace(/^key_file:\s*.+/m,  `key_file: "${keyFile}"`);
        } else {
          yaml = yaml.trimEnd() + `\ncert_file: "${certFile}"\nkey_file: "${keyFile}"\n`;
        }
      }
    } else {
      // Remove http_mimic block if not a mimic transport
      yaml = yaml.replace(new RegExp('(^http_mimic:[ \\t]*\\n(?:(?!^[a-z])[\\s\\S])*)', 'm'), '');
    }

    // 3. Patch daggermux block
    if (t === 'daggermux') {
      const mtu     = document.getElementById('fec-mtu')?.value    || '1350';
      const sndwnd  = document.getElementById('dm-sndwnd')?.value  || '1024';
      const rcvwnd  = document.getElementById('dm-rcvwnd')?.value  || '1024';
      const data    = document.getElementById('fec-data')?.value   || '10';
      const parity  = document.getElementById('fec-parity')?.value || '1';
      const sockbuf = document.getElementById('dm-sockbuf')?.value || '4194304';
      const iface   = document.getElementById('dm-interface')?.value || '';
      const localIp = document.getElementById('dm-localip')?.value  || '';
      const routMac = document.getElementById('dm-routermac')?.value || '';
      const lFlags  = (document.getElementById('dm-local-flags')?.value || 'PA,A').split(',').map(f => `    - "${f.trim()}"`).join('\n');
      const rFlags  = (document.getElementById('dm-remote-flags')?.value || 'PA,A').split(',').map(f => `    - "${f.trim()}"`).join('\n');

      const dmBlock = `daggermux:\n  interface: "${iface}"\n  local_ip: "${localIp}"\n  router_mac: "${routMac}"\n  mtu: ${mtu}\n  snd_wnd: ${sndwnd}\n  rcv_wnd: ${rcvwnd}\n  data_shard: ${data}\n  parity_shard: ${parity}\n  sock_buf: ${sockbuf}\n  local_flags:\n${lFlags}\n  remote_flags:\n${rFlags}\n`;
      const obfBlock = `obfuscation:\n  enabled: false\n`;
      yaml = replaceBlock(yaml, 'daggermux', dmBlock);
      yaml = replaceBlock(yaml, 'obfuscation', obfBlock);
    }

    // 4. Patch kcpmux block
    if (t === 'kcpmux') {
      const mtu    = document.getElementById('kcp-mtu')?.value    || '1400';
      const sndwnd = document.getElementById('kcp-sndwnd')?.value || '1024';
      const rcvwnd = document.getElementById('kcp-rcvwnd')?.value || '1024';
      const data   = document.getElementById('kcp-data')?.value   || '10';
      const par    = document.getElementById('kcp-parity')?.value || '1';
      const sockbuf= document.getElementById('kcp-sockbuf')?.value|| '4194304';
      const kcpBlock = `kcpmux:\n  nodelay: 1\n  interval: 10\n  resend: 2\n  nc: 1\n  sndwnd: ${sndwnd}\n  rcvwnd: ${rcvwnd}\n  mtu: ${mtu}\n`;
      yaml = replaceBlock(yaml, 'kcpmux', kcpBlock);
    }

    // 5. Patch rawmux block
    if (t === 'rawmux') {
      const ht  = document.getElementById('rawmux-handshake')?.value || '10';
      const ka  = document.getElementById('rawmux-keepalive')?.value || '15';
      const rb  = document.getElementById('rawmux-readbuf')?.value   || '4194304';
      const wb  = document.getElementById('rawmux-writebuf')?.value  || '4194304';
      const pcap= document.getElementById('rawmux-pcap')?.classList.contains('on') ? 'true' : 'false';
      const rawBlock = `rawmux:\n  handshake_timeout: ${ht}\n  keepalive: ${ka}\n  read_buffer: ${rb}\n  write_buffer: ${wb}\n  use_pcap: ${pcap}\n`;
      yaml = replaceBlock(yaml, 'rawmux', rawBlock);
    }

    return yaml;
  }

  // ‚îÄ‚îÄ Auto-detect transport from YAML when tab opens ‚îÄ‚îÄ
  async function loadTransportFromYaml() {
    try {
      const target = NODE_ROLE === 'client' ? 'client' : 'server';
      const d = await api('/api/config?target=' + target);
      if (!d.ok) { selectTransport('httpsmux'); return; }
      const yaml = d.content.replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\');
      // Find the first transport in listeners block
      const lm = yaml.match(/^listeners:[\s\S]*?transport:\s*["']?(\w+)/m);
      if (lm) selectTransport(lm[1].replace(/["']/g, ''));
      else selectTransport('httpsmux');
    } catch(e) { selectTransport('httpsmux'); }
  }

  // ‚îÄ‚îÄ FEC calculator ‚îÄ‚îÄ
  function calcFEC() {
    const data   = parseInt(document.getElementById('fec-data')?.value   || document.getElementById('kcp-data')?.value)   || 10;
    const parity = parseInt(document.getElementById('fec-parity')?.value || document.getElementById('kcp-parity')?.value) || 1;
    const ratio   = (data + parity) / data;
    const overhead = ((parity / data) * 100).toFixed(1);
    const maxLoss  = ((parity / (data + parity)) * 100).toFixed(1);
    const color = ratio <= 1.1 ? 'var(--accent3)' : ratio <= 1.2 ? 'var(--accent4)' : 'var(--danger)';
    const html =
      `<div>Bandwidth multiplier: <span style="color:${color};font-weight:700">${ratio.toFixed(3)}x</span></div>` +
      `<div>Overhead: <span style="color:${color}">${overhead}%</span> extra bandwidth</div>` +
      `<div>Max packet loss recovered: <span style="color:var(--accent3)">${maxLoss}%</span></div>` +
      `<div style="margin-top:4px;color:var(--text3)">100 Mbps ‚Üí ${(100 * ratio).toFixed(0)} Mbps consumed</div>`;
    ['fec-result','fec-result-dm'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = html; });
  }

  function setFecPreset(data, parity) {
    const dEl = document.getElementById('fec-data');
    const pEl = document.getElementById('fec-parity');
    if (dEl) dEl.value = data;
    if (pEl) pEl.value = parity;
    calcFEC();
  }

  function applyFlagProfile(name) {
    const profiles = {
      http:    { local: 'PA,A,PA',    remote: 'PA,A' },
      stealth: { local: 'PA,A,PA,FA', remote: 'SA,PA,A' },
      minimal: { local: 'PA',         remote: 'PA' },
    };
    const p = profiles[name];
    if (!p) return;
    const lEl = document.getElementById('dm-local-flags');
    const rEl = document.getElementById('dm-remote-flags');
    if (lEl) lEl.value = p.local;
    if (rEl) rEl.value = p.remote;
    showNotif(name + ' flag profile applied', '‚úÖ');
  }

  function applyDaggerPreset(name) {
    const presets = {
      gaming:     { mtu:1200, snd:512,  rcv:512,  data:10, par:1, local:'PA,A',    remote:'PA,A',    sockbuf:4194304  },
      throughput: { mtu:1350, snd:2048, rcv:2048, data:20, par:1, local:'PA',      remote:'PA',      sockbuf:8388608  },
      stealth:    { mtu:1300, snd:1024, rcv:1024, data:10, par:1, local:'PA,A,PA', remote:'PA,A,PA', sockbuf:4194304  },
      lossy:      { mtu:1280, snd:2048, rcv:2048, data:10, par:2, local:'PA,A',    remote:'PA,A',    sockbuf:8388608  },
    };
    const p = presets[name];
    if (!p) return;
    const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = v; };
    set('fec-mtu', p.mtu);  set('dm-sndwnd', p.snd);  set('dm-rcvwnd', p.rcv);
    set('fec-data', p.data); set('fec-parity', p.par);
    set('dm-local-flags', p.local); set('dm-remote-flags', p.remote);
    set('dm-sockbuf', p.sockbuf);
    calcFEC();
    showNotif(name + ' preset applied', '‚úÖ');
  }

  document.addEventListener('DOMContentLoaded', () => {
    showTransportPanel('httpsmux');
    calcFEC();
  });

  async function checkIptables() {
    const port = document.getElementById('ipt-port').value || 2020;
    const el = document.getElementById('ipt-status');
    el.style.display = 'block';
    el.innerHTML = 'Checking‚Ä¶';
    try {
      const d = await api(`/api/daggermux/iptables?port=${port}`);
      if (d.rules_active) {
        el.innerHTML = `<span style="color:var(--accent3)">‚úì Rules active for port ${port}</span>\n${escHtml(d.raw_prerouting)}\n${escHtml(d.mangle_output)}`;
      } else {
        el.innerHTML = `<span style="color:var(--danger)">‚úó No NOTRACK rules found for port ${port}</span>\nClick "Apply" to set them.`;
      }
    } catch(e) {
      el.innerHTML = '<span style="color:var(--danger)">API unreachable</span>';
    }
  }

  async function applyIptables() {
    const port = parseInt(document.getElementById('ipt-port').value) || 2020;
    const el = document.getElementById('ipt-status');
    el.style.display = 'block';
    el.innerHTML = 'Applying iptables rules‚Ä¶';
    showNotif('Applying iptables NOTRACK rules‚Ä¶', '‚ö°');
    try {
      const d = await post('/api/daggermux/iptables', { port });
      if (d.ok) {
        el.innerHTML = `<span style="color:var(--accent3)">‚úì ${escHtml(d.msg)}</span>`;
        showNotif('iptables rules applied!', '‚úÖ');
      } else {
        el.innerHTML = `<span style="color:var(--danger)">‚úó ${escHtml(d.msg)}</span>`;
        showNotif('iptables failed: ' + d.msg, '‚ùå');
      }
    } catch(e) {
      el.innerHTML = '<span style="color:var(--danger)">API unreachable</span>';
      showNotif('API unreachable', '‚ùå');
    }
  }


  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  ROLE MANAGEMENT
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function loadRole() {
    try {
      const d = await api('/api/role');
      if (d.ok) applyRole(d.role);
    } catch(e) {}
  }

  function applyRole(role) {
    NODE_ROLE = role;
    const badge = document.getElementById('role-badge');
    if (!badge) return;
    const labels = { server: 'üñ• SERVER', client: 'üíª CLIENT', unknown: '? UNKNOWN' };
    const classes = { server: 'b-cyan', client: 'b-purple', unknown: 'b-amber' };
    badge.textContent = labels[role] || '? UNKNOWN';
    badge.className = 'badge ' + (classes[role] || 'b-amber');

    const navSrv   = document.getElementById('nav-server');
    const navCli   = document.getElementById('nav-client');
    const navPorts = document.getElementById('nav-ports');
    const tabSrv   = document.getElementById('tab-server');
    const tabCli   = document.getElementById('tab-client');
    const tabPorts = document.getElementById('tab-ports');

    if (role === 'server') {
      // SERVER: show server config + ports, hide/disable client config
      setNavEnabled(navSrv,   true);
      setNavEnabled(navCli,   false);
      setNavEnabled(navPorts, true);
      setTabAccessible(tabCli, false, 'server');
      setTabAccessible(tabSrv, true,  'server');
      setTabAccessible(tabPorts, true, 'server');
    } else if (role === 'client') {
      // CLIENT: show client config, hide/disable server config + ports
      setNavEnabled(navSrv,   false);
      setNavEnabled(navCli,   true);
      setNavEnabled(navPorts, false);
      setTabAccessible(tabSrv,   false, 'client');
      setTabAccessible(tabPorts, false, 'client');
      setTabAccessible(tabCli,   true,  'client');
    } else {
      // UNKNOWN: show everything
      setNavEnabled(navSrv,   true);
      setNavEnabled(navCli,   true);
      setNavEnabled(navPorts, true);
      setTabAccessible(tabSrv,   true,  null);
      setTabAccessible(tabCli,   true,  null);
      setTabAccessible(tabPorts, true,  null);
    }

    // ‚îÄ‚îÄ YAML editor: set correct default + disable irrelevant option ‚îÄ‚îÄ
    const yamlTarget = document.getElementById('yaml-target');
    if (yamlTarget) {
      const optServer = yamlTarget.querySelector('option[value="server"]');
      const optClient = yamlTarget.querySelector('option[value="client"]');
      if (role === 'server') {
        yamlTarget.value = 'server';
        if (optServer) { optServer.disabled = false; optServer.textContent = 'Server Config'; }
        if (optClient) { optClient.disabled = true;  optClient.textContent = 'Client Config (remote node)'; }
      } else if (role === 'client') {
        yamlTarget.value = 'client';
        if (optServer) { optServer.disabled = true;  optServer.textContent = 'Server Config (remote node)'; }
        if (optClient) { optClient.disabled = false; optClient.textContent = 'Client Config'; }
      } else {
        if (optServer) { optServer.disabled = false; optServer.textContent = 'Server Config'; }
        if (optClient) { optClient.disabled = false; optClient.textContent = 'Client Config'; }
      }
    }
  }

  function setNavEnabled(el, enabled) {
    if (!el) return;
    if (enabled) {
      el.classList.remove('nav-disabled');
      el.style.pointerEvents = '';
    } else {
      el.classList.add('nav-disabled');
      el.classList.remove('active');
      el.style.pointerEvents = 'none';
    }
  }

  function setTabAccessible(tab, accessible, role) {
    if (!tab) return;
    // Remove any existing overlay
    const existing = tab.querySelector('.role-overlay');
    if (existing) existing.remove();

    if (!accessible) {
      // If this tab is currently active, redirect to dashboard
      if (tab.classList.contains('active')) {
        tab.classList.remove('active');
        const dash = document.getElementById('tab-dashboard');
        if (dash) dash.classList.add('active');
      }
      // Inject a full-cover overlay so content is invisible and unclickable
      const overlay = document.createElement('div');
      overlay.className = 'role-overlay';
      const roleLabel = role === 'server' ? 'SERVER' : role === 'client' ? 'CLIENT' : '';
      const oppositeLabel = role === 'server' ? 'client' : 'server';
      overlay.style.cssText = 'position:absolute;inset:0;background:var(--bg);z-index:10;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:10px;border-radius:12px;';
      overlay.innerHTML = `
      <div style="font-size:28px">üîí</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3)">Not available on ${roleLabel} node</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text3)">This section belongs to the ${oppositeLabel.toUpperCase()} VPS</div>`;
      // Tab needs relative positioning for the overlay
      tab.style.position = 'relative';
      tab.appendChild(overlay);
    }
  }

  async function promptRoleChange() {
    const newRole = NODE_ROLE === 'server' ? 'client' : 'server';
    const label = { server: 'SERVER (Iran/relay VPS)', client: 'CLIENT (Foreign/exit VPS)' };
    // Use in-page confirm modal instead of window.confirm() (blocked in iframes/some contexts)
    const confirmed = await showConfirmModal(
            'Switch Node Role',
            `Switch this node to <strong>${label[newRole] || newRole}</strong>?<br><br>This only affects the panel UI ‚Äî it does not change your DaggerConnect config files.`
    );
    if (!confirmed) return;
    try {
      const d = await post('/api/role', { role: newRole });
      if (d.ok) {
        applyRole(newRole);
        showNotif('Role ‚Üí ' + newRole.toUpperCase(), 'üîÑ');
      } else {
        showNotif('Role change failed: ' + d.msg, '‚ùå');
      }
    } catch(e) {
      showNotif('API unreachable', '‚ùå');
    }
  }

  // In-page confirm modal (replaces window.confirm which is blocked in some browsers)
  function showConfirmModal(title, message) {
    return new Promise(resolve => {
      const overlay = document.createElement('div');
      overlay.className = 'modal-ov open';
      overlay.style.zIndex = '10000';
      overlay.innerHTML = `
      <div class="modal" style="max-width:400px">
        <div class="modal-head"><span>${escHtml(title)}</span><button class="modal-close" onclick="this.closest('.modal-ov').remove()">‚úï</button></div>
        <div class="modal-body" style="padding:20px">
          <p style="margin:0 0 20px;line-height:1.6;color:var(--text)">${message}</p>
          <div class="flex" style="gap:8px;justify-content:flex-end">
            <button class="btn btn-ghost" id="_confirm-cancel">Cancel</button>
            <button class="btn btn-primary" id="_confirm-ok">Confirm</button>
          </div>
        </div>
      </div>`;
      document.body.appendChild(overlay);
      overlay.querySelector('#_confirm-ok').onclick = () => { overlay.remove(); resolve(true); };
      overlay.querySelector('#_confirm-cancel').onclick = () => { overlay.remove(); resolve(false); };
      overlay.addEventListener('click', e => { if (e.target === overlay) { overlay.remove(); resolve(false); } });
    });
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  NOTIFICATIONS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let notifTimer;
  function showNotif(msg, icon='‚úÖ') {
    document.getElementById('notif-text').textContent = msg;
    document.getElementById('notif-icon').textContent = icon;
    const el = document.getElementById('notif');
    el.classList.add('show');
    clearTimeout(notifTimer);
    notifTimer = setTimeout(() => el.classList.remove('show'), 3500);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  TAB NAVIGATION
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let _connPollTimer = null;

  function switchTab(id, noLoad) {
    // Block navigation to role-restricted tabs
    const roleRestricted = {
      server: NODE_ROLE === 'client',
      ports:  NODE_ROLE === 'client',
      client: NODE_ROLE === 'server',
    };
    if (roleRestricted[id]) {
      showNotif('Not available on this node role', 'üîí');
      return;
    }

    document.querySelectorAll('.tab-view').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const el = document.getElementById('tab-' + id);
    if (el) el.classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => {
      if (n.getAttribute('onclick') && n.getAttribute('onclick').includes("'" + id + "'")) n.classList.add('active');
    });

    // Stop connections auto-poll when leaving that tab
    if (id !== 'connections') {
      clearInterval(_connPollTimer);
      _connPollTimer = null;
    }

    // Tab-specific loads
    if (id === 'ports') loadPortMaps();
    if (id === 'server' && !noLoad) loadListenersFromServerYaml();
    if (id === 'transport') loadTransportFromYaml();
    if (id === 'connections') {
      loadConnections();
      clearInterval(_connPollTimer);
      _connPollTimer = setInterval(loadConnections, 15000); // auto-refresh every 15s
    }
    if (id === 'security') loadCertInfo();
    if (id === 'yaml' && !noLoad) loadConfig(document.getElementById('yaml-target').value);
  }

  // ‚îÄ‚îÄ Parse server.yaml and populate all listener cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadListenersFromServerYaml() {
    try {
      const d = await api('/api/config?target=server');
      if (!d.ok) return;
      const yaml = d.content.replace(/\\n/g, '\n').replace(/\\"/g, '"').replace(/\\\\/g, '\\');
      populateListenersFromYaml(yaml);
    } catch(e) { /* silently fall back to empty form */ }
  }

  function populateListenersFromYaml(yaml) {
    if (!yaml || yaml.startsWith('#')) return;
    const container = document.getElementById('listeners-container');
    if (!container) return;

    // Helper: strip surrounding quotes from a YAML value
    const stripQ = s => s ? s.trim().replace(/^["']|["']$/g, '') : '';

    // Parse global settings from top-level keys only (first occurrence before indented block)
    const globalLine = key => {
      const m = yaml.match(new RegExp('^' + key + ':\\s*(.+)', 'm'));
      return m ? stripQ(m[1]) : '';
    };
    const psk     = globalLine('psk');
    const profile = globalLine('profile') || 'balanced';

    // Fill global form fields
    const pskEl = document.getElementById('srv-psk');
    if (pskEl && psk) pskEl.value = psk;
    const proEl = document.getElementById('srv-profile');
    if (proEl && profile) proEl.value = profile;

    // ‚îÄ‚îÄ Extract the listeners: block only ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Find "listeners:" line, then take all lines indented by 2+ spaces after it
    const listenersMatch = yaml.match(/^listeners:\s*\n((?:[ \t]+[^\n]*\n?)*)/m);
    if (!listenersMatch) {
      if (container.children.length === 0) initListeners();
      return;
    }
    const listenersBlock = listenersMatch[1];

    // Split into individual listener entries by "  - " at the start of a line
    // Each entry starts with "  - addr:" or "  - " 
    const entries = listenersBlock.split(/(?=^  - )/m).filter(s => s.trim());
    if (entries.length === 0) {
      if (container.children.length === 0) initListeners();
      return;
    }

    // Rebuild listener cards
    container.innerHTML = '';
    listenerCount = 0;

    entries.forEach(entry => {
      // Extract addr and transport ‚Äî they are 4-space indented keys within this entry
      const addrM  = entry.match(/(?:^|\n)[ \t]*-?[ \t]*addr:\s*(.+)/);
      const transM = entry.match(/(?:^|\n)[ \t]*transport:\s*(.+)/);
      const addr   = addrM  ? stripQ(addrM[1])  : '0.0.0.0:443';
      const trans  = transM ? stripQ(transM[1]) : 'httpsmux';
      const parts  = addr.split(':');
      const ip     = parts.length > 1 ? parts.slice(0, -1).join(':') : '0.0.0.0';
      const port   = parts[parts.length - 1] || '443';

      // Add card (silent = no notification spam)
      addListener(true);
      const cards = container.querySelectorAll(':scope > .card');
      const card  = cards[cards.length - 1];
      if (!card) return;
      const id = card.id;

      // Clear the default map that addListener created, then populate from YAML
      const mapsEl = document.getElementById(id + '-maps');
      if (mapsEl) mapsEl.innerHTML = '';
      _listenerMapCounters[id] = 0;

      // Set values ‚Äî do this after the DOM element exists
      const ipEl    = document.getElementById(id + '-ip');
      const portEl  = document.getElementById(id + '-port');
      const transEl = document.getElementById(id + '-transport');
      if (ipEl)    ipEl.value    = ip;
      if (portEl)  portEl.value  = port;
      if (transEl) { transEl.value = trans; updateListenerBadge(id); }

      // Parse maps ‚Äî iterate entry lines looking for type/bind/target
      const entryLines = entry.split('\n');
      let curType = 'tcp', curBind = '', curTarget = '';
      entryLines.forEach(el => {
        const tM = el.match(/^\s+type:\s*["']?(\w+)/);
        const bM = el.match(/^\s+bind:\s*(.+)/);
        const rM = el.match(/^\s+target:\s*(.+)/);
        if (tM)  curType   = stripQ(tM[1]);
        if (bM)  curBind   = stripQ(bM[1]);
        if (rM)  curTarget = stripQ(rM[1]);
        if (curBind && curTarget) {
          addListenerMap(id, curType, curBind, curTarget);
          curBind = ''; curTarget = ''; curType = 'tcp';
        }
      });
    });
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  CLOCK
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function updateClock() {
    const el = document.getElementById('clock');
    if (el) el.textContent = new Date().toLocaleTimeString('en-US', {hour12:false});
  }
  setInterval(updateClock, 1000); updateClock();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  UTILITIES
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function reloadAll() {
    loadStatus();
    loadPortMaps();
    showNotif('Refreshed', '‚Ü∫');
  }

  // Modal backdrop close
  document.querySelectorAll('.modal-ov').forEach(o => {
    o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
  });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  LOGIN / AUTH
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function doLogin() {
    const token = document.getElementById('login-token').value.trim();
    const errEl = document.getElementById('login-err');
    errEl.classList.remove('show');

    // Try /api/ping (no auth required) to check if API is reachable at all
    try {
      const ping = await fetch(API + '/api/ping');
      if (!ping.ok && ping.status !== 401) {
        errEl.textContent = 'API unreachable ‚Äî is start.sh running?';
        errEl.classList.add('show');
        return;
      }
    } catch(e) {
      errEl.textContent = 'Cannot reach API at ' + (API || 'same origin') + ' ‚Äî is start.sh running?';
      errEl.classList.add('show');
      return;
    }

    // Validate token via /api/auth
    try {
      const r = await fetch(API + '/api/auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      });
      const d = await r.json();
      if (d.ok) {
        AUTH_TOKEN = token;
        sessionStorage.setItem('dagger_token', token);
        document.getElementById('login-screen').classList.add('hidden');
        init();
      } else {
        errEl.textContent = 'Invalid token';
        errEl.classList.add('show');
        AUTH_TOKEN = '';
        sessionStorage.removeItem('dagger_token');
      }
    } catch(e) {
      errEl.textContent = 'Auth check failed: ' + e.message;
      errEl.classList.add('show');
    }
  }

  function logout() {
    AUTH_TOKEN = '';
    sessionStorage.removeItem('dagger_token');
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('login-token').value = '';
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  STARTUP
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function init() {
    // Check version + role
    try {
      const v = await api('/api/version');
      if (v.ok) {
        document.getElementById('ver-label').textContent = v.version.substring(0, 20);
        if (v.role && v.role !== 'unknown') applyRole(v.role);
      }
    } catch(e) {}

    // Load role separately in case version failed
    await loadRole();

    // Initialize multi-listener UI
    initListeners();

    loadStatus();
    loadPortMaps();
    loadCertInfo();

    // Load server-side metrics history (fills charts from server data)
    loadServerHistory();

    // Poll every 5s
    setInterval(loadStatus, 5000);
    setInterval(loadPortMaps, 30000);
  }

  // ‚îÄ‚îÄ Auto-login if token in sessionStorage ‚îÄ‚îÄ
  (async () => {
    if (AUTH_TOKEN) {
      // Quietly validate stored token
      try {
        const r = await fetch(API + '/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: AUTH_TOKEN })
        });
        const d = await r.json();
        if (d.ok) {
          document.getElementById('login-screen').classList.add('hidden');
          init();
          return;
        }
      } catch(e) {}
      // Token invalid, clear it
      AUTH_TOKEN = '';
      sessionStorage.removeItem('dagger_token');
    }
    // No valid token ‚Äî show login
  })();
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  CONFIG WIZARD
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  CONFIG WIZARD
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const WIZ_STEPS = [
    'role',           // 1. Server or client?
    'transport',      // 2. Primary transport protocol
    'connection',     // 3. PSK + listen/server addr
    'transport_opts', // 4. Transport-specific options
    'listeners',      // 5. Multi-listener (server) / multi-path (client)
    'performance',    // 6. Profile + advanced TCP
    'review',         // 7. Review & generate
  ];
  let wizStep = 0;
  let wizData = {};

  function openWizard() {
    wizStep = 0;
    wizData = { ports: [], paths: [], listeners: [] };
    document.getElementById('wizard-modal').classList.add('open');
    renderWizStep();
  }
  function closeWizard() {
    document.getElementById('wizard-modal').classList.remove('open');
  }
  function wizSetProgress(step) {
    const pct = Math.round((step + 1) / WIZ_STEPS.length * 100);
    document.getElementById('wiz-progress').style.width = pct + '%';
    document.getElementById('wiz-step-lbl').textContent = `Step ${step + 1} / ${WIZ_STEPS.length}`;
  }
  function wizBack() {
    if (wizStep > 0) { wizStep--; renderWizStep(); }
  }
  function wizNext() {
    if (!wizCollect()) return;
    if (wizStep < WIZ_STEPS.length - 1) { wizStep++; renderWizStep(); }
    else { wizFinish(); }
  }

  function renderWizStep() {
    const body    = document.getElementById('wiz-body');
    const nextBtn = document.getElementById('wiz-next');
    const backBtn = document.getElementById('wiz-back');
    backBtn.style.display = wizStep > 0 ? '' : 'none';
    nextBtn.textContent   = wizStep === WIZ_STEPS.length - 1 ? '‚úÖ Generate YAML' : 'Next ‚Üí';
    wizSetProgress(wizStep);
    const step = WIZ_STEPS[wizStep];

    // ‚îÄ‚îÄ STEP 1: Role ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (step === 'role') {
      document.getElementById('wiz-title').textContent = "What is this server's role?";
      body.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
          <div class="prof-card${wizData.role==='server'?' sel':''}" style="padding:20px;cursor:pointer" onclick="wizSelectRole('server',this)">
            <div style="font-size:28px;margin-bottom:8px">üñ•Ô∏è</div>
            <div style="font-weight:700;margin-bottom:4px">Server</div>
            <div style="font-size:11px;color:var(--text3)">Iran/relay VPS<br>Receives client connections</div>
          </div>
          <div class="prof-card${wizData.role==='client'?' sel':''}" style="padding:20px;cursor:pointer" onclick="wizSelectRole('client',this)">
            <div style="font-size:28px;margin-bottom:8px">üíª</div>
            <div style="font-weight:700;margin-bottom:4px">Client</div>
            <div style="font-size:11px;color:var(--text3)">Foreign/exit VPS<br>Connects out to server</div>
          </div>
        </div>
        <div class="hint">Each VPS runs one role. Run this wizard on each machine separately.</div>`;
    }

    // ‚îÄ‚îÄ STEP 2: Transport ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    else if (step === 'transport') {
      document.getElementById('wiz-title').textContent = 'Choose transport protocol';
      const opts = [
        { val:'httpsmux', badge:'b-cyan',   star:'‚≠ê', desc:'HTTPS mimicry ‚Äî best DPI bypass, recommended' },
        { val:'httpmux',  badge:'b-purple', star:'',   desc:'HTTP mimicry ‚Äî no TLS, slightly faster' },
        { val:'wssmux',   badge:'b-green',  star:'',   desc:'WebSocket Secure ‚Äî good for CDN setups' },
        { val:'wsmux',    badge:'b-amber',  star:'',   desc:'WebSocket ‚Äî no TLS' },
        { val:'kcpmux',   badge:'b-red',    star:'',   desc:'KCP over UDP ‚Äî low latency, lossy links' },
        { val:'tcpmux',   badge:'b-purple', star:'',   desc:'TCP mux ‚Äî simple, no mimicry' },
        { val:'daggermux',badge:'b-cyan',   star:'‚ö°',  desc:'DaggerMux ‚Äî pcap DPI bypass, needs root' },
      ];
      body.innerHTML = opts.map(o => `
        <div class="pm-item mb8" style="cursor:pointer;padding:10px 12px;border-radius:8px;
          border:1px solid ${wizData.transport===o.val?'var(--accent)':'var(--border)'};
          background:${wizData.transport===o.val?'rgba(0,212,255,.07)':'var(--bg2)'};"
          onclick="wizSelectTransport('${o.val}',this)">
          <span class="badge ${o.badge}" style="min-width:80px;text-align:center">${o.val} ${o.star}</span>
          <span style="font-size:12px;color:var(--text2);margin-left:10px">${o.desc}</span>
        </div>`).join('');
    }

    // ‚îÄ‚îÄ STEP 3: Connection details ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    else if (step === 'connection') {
      document.getElementById('wiz-title').textContent = 'Connection details';
      const isServer   = wizData.role === 'server';
      const portMap    = { httpmux:'80', kcpmux:'2020', daggermux:'2020' };
      const defaultPort = portMap[wizData.transport] || '443';
      body.innerHTML = `
        <div class="form-group">
          <label>Pre-Shared Key (PSK) ‚Äî your license key</label>
          <div class="flex">
            <input type="password" id="wiz-psk" value="${escHtml(wizData.psk||'')}"
              placeholder="Paste license key from @DaggerConnectBot"
              style="flex:1;border-radius:8px 0 0 8px">
            <button class="btn btn-ghost" onclick="wizTogglePsk()" style="border-radius:0 8px 8px 0;border-left:none">üëÅ</button>
          </div>
          <div class="hint">Must be identical on both server and client. Buy at <a href="https://t.me/DaggerConnectBot" target="_blank" style="color:var(--accent)">@DaggerConnectBot</a></div>
        </div>
        ${isServer ? `
        <div class="form-row2">
          <div class="form-group"><label>Listen IP</label>
            <input type="text" id="wiz-ip" value="${escHtml(wizData.ip||'0.0.0.0')}">
          </div>
          <div class="form-group"><label>Listen Port</label>
            <input type="number" id="wiz-port" value="${wizData.port||defaultPort}">
          </div>
        </div>` : `
        <div class="form-group"><label>Server Address (ip:port)</label>
          <input type="text" id="wiz-addr" value="${escHtml(wizData.addr||'')}" placeholder="IRAN_SERVER_IP:${defaultPort}">
        </div>`}
        <div class="toggle-row">
          <label>Verbose Logging</label>
          <div class="toggle${wizData.verbose?' on':''}" id="wiz-verbose" onclick="this.classList.toggle('on')"></div>
        </div>`;
    }

    // ‚îÄ‚îÄ STEP 4: Transport-specific options ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    else if (step === 'transport_opts') {
      const t        = wizData.transport || 'httpsmux';
      const hasMimic = ['httpsmux','httpmux','wssmux','wsmux'].includes(t);
      const hasCert  = ['httpsmux','wssmux'].includes(t);
      const isDagger = t === 'daggermux';
      const isKcp    = t === 'kcpmux';
      document.getElementById('wiz-title').textContent = `Transport options ‚Äî ${t}`;

      let html = '';

      if (hasMimic) {
        const domains = ['www.google.com','www.cloudflare.com','api.github.com','www.microsoft.com','cdn.jsdelivr.net'];
        html += `
        <div style="margin-bottom:16px">
          <div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:10px">
            <span class="badge b-cyan">${t}</span>&nbsp; HTTP Mimicry
          </div>
          <div class="form-row2">
            <div class="form-group">
              <label>Fake Domain</label>
              <select id="wiz-fake-domain">
                ${domains.map(d=>`<option${d===(wizData.fakeDomain||'www.google.com')?' selected':''}>${d}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label>Fake Path</label>
              <input type="text" id="wiz-fake-path" value="${escHtml(wizData.fakePath||'/search')}" placeholder="/search">
            </div>
          </div>
          <div class="toggle-row">
            <label>Session Cookie</label>
            <div class="toggle${wizData.sessionCookie===false?'':' on'}" id="wiz-session-cookie" onclick="this.classList.toggle('on')"></div>
          </div>
        </div>`;
      }

      if (hasCert) {
        html += `
        <div style="background:rgba(79,142,247,.05);border:1px solid rgba(79,142,247,.2);border-radius:9px;padding:14px;margin-bottom:16px">
          <div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:10px">üîí TLS Certificate paths</div>
          <div class="form-group">
            <label>Cert File</label>
            <input type="text" id="wiz-cert-file" value="${escHtml(wizData.certFile||'/etc/DaggerConnect/certs/cert.pem')}">
          </div>
          <div class="form-group">
            <label>Key File</label>
            <input type="text" id="wiz-key-file" value="${escHtml(wizData.keyFile||'/etc/DaggerConnect/certs/key.pem')}">
          </div>
          <div class="hint">Generate a self-signed cert in Security ‚Üí TLS if you don't have one yet.</div>
        </div>`;
      }

      if (isDagger) {
        html += `
        <div style="margin-bottom:14px">
          <div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:10px">
            <span class="badge b-purple">daggermux</span>&nbsp; KCP / pcap settings
          </div>
          <div class="form-row2">
            <div class="form-group"><label>MTU</label>
              <input type="number" id="wiz-dm-mtu" value="${(wizData.dm&&wizData.dm.mtu)||1350}" min="576" max="1500">
            </div>
            <div class="form-group"><label>Send Window</label>
              <input type="number" id="wiz-dm-sndwnd" value="${(wizData.dm&&wizData.dm.sndWnd)||1024}" min="64">
            </div>
          </div>
          <div class="form-row2">
            <div class="form-group"><label>Recv Window</label>
              <input type="number" id="wiz-dm-rcvwnd" value="${(wizData.dm&&wizData.dm.rcvWnd)||1024}" min="64">
            </div>
            <div class="form-group"><label>Socket Buffer</label>
              <input type="number" id="wiz-dm-sockbuf" value="${(wizData.dm&&wizData.dm.sockBuf)||4194304}" min="65536">
            </div>
          </div>
          <div class="form-row2">
            <div class="form-group"><label>FEC data_shard</label>
              <input type="number" id="wiz-dm-data" value="${(wizData.dm&&wizData.dm.dataShard)||10}" min="1" max="100">
            </div>
            <div class="form-group"><label>FEC parity_shard</label>
              <input type="number" id="wiz-dm-parity" value="${(wizData.dm&&wizData.dm.parityShard)||1}" min="0" max="50">
            </div>
          </div>
          <div class="form-group">
            <label>TCP Flag Profile</label>
            <select id="wiz-dm-flags">
              <option value="http" ${ (!wizData.dm||wizData.dm.flagProfile==='http')?'selected':'' }>HTTP ‚Äî PA,A / PA,A (most common ‚Äî looks like web traffic)</option>
              <option value="bulk" ${ (wizData.dm&&wizData.dm.flagProfile==='bulk')?'selected':'' }>Bulk ‚Äî PA,A,PA / PA,A (data transfer)</option>
              <option value="tls"  ${ (wizData.dm&&wizData.dm.flagProfile==='tls') ?'selected':'' }>TLS-like ‚Äî PA,A,PSH / PA,A (TLS handshake mimicry)</option>
            </select>
          </div>
          <div style="background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2);border-radius:8px;padding:10px;font-size:10px;color:var(--text2);margin-top:6px;line-height:1.6">
            ‚ö†Ô∏è DaggerMux requires <strong>root + libpcap</strong>.<br>
            <code>obfuscation: enabled: false</code> is mandatory ‚Äî enabling it causes MTU violations.
          </div>
        </div>`;
      }

      if (isKcp) {
        html += `
        <div style="margin-bottom:14px">
          <div style="font-size:11px;font-weight:700;color:var(--text);margin-bottom:10px">
            <span class="badge b-amber">kcpmux</span>&nbsp; KCP settings
          </div>
          <div class="form-row2">
            <div class="form-group"><label>FEC data_shard</label>
              <input type="number" id="wiz-kcp-data" value="${(wizData.kcp&&wizData.kcp.dataShard)||10}" min="1" max="100">
            </div>
            <div class="form-group"><label>FEC parity_shard</label>
              <input type="number" id="wiz-kcp-parity" value="${(wizData.kcp&&wizData.kcp.parityShard)||1}" min="0" max="50">
            </div>
          </div>
          <div class="form-row2">
            <div class="form-group"><label>MTU</label>
              <input type="number" id="wiz-kcp-mtu" value="${(wizData.kcp&&wizData.kcp.mtu)||1350}" min="576" max="1500">
            </div>
            <div class="form-group"><label>Socket Buffer</label>
              <input type="number" id="wiz-kcp-sockbuf" value="${(wizData.kcp&&wizData.kcp.sockBuf)||4194304}" min="65536">
            </div>
          </div>
          <div class="hint">Higher parity_shard = more packet loss recovery, more bandwidth overhead.</div>
        </div>`;
      }

      if (!hasMimic && !isDagger && !isKcp) {
        html += `
        <div style="padding:40px 20px;text-align:center;color:var(--text2)">
          <div style="font-size:32px;margin-bottom:12px">‚úÖ</div>
          <strong style="font-size:14px">${t}</strong> has no extra configuration options.<br>
          <span style="font-size:11px;color:var(--text3);margin-top:8px;display:block">Click Next to continue to port / path setup.</span>
        </div>`;
      }

      body.innerHTML = html;
    }

    // ‚îÄ‚îÄ STEP 5: Listeners (server) / Paths (client) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    else if (step === 'listeners') {
      if (wizData.role === 'server') {
        document.getElementById('wiz-title').textContent = 'Configure Listeners';
        // Ensure at least one listener seeded from step 3
        if (!wizData.listeners || wizData.listeners.length === 0) {
          wizData.listeners = [{
            addr: (wizData.ip || '0.0.0.0') + ':' + (wizData.port || '443'),
            transport: wizData.transport || 'httpsmux',
            ports: wizData.ports && wizData.ports.length ? wizData.ports : [],
            tun: null
          }];
        }
        body.innerHTML = `
          <div style="font-size:11px;color:var(--text3);margin-bottom:12px">
            Each listener runs on a separate port with its own transport, port maps, and optional TUN interface.
            The first listener was pre-filled from your earlier choices.
          </div>
          <div id="wiz-listeners-list">${renderWizListeners()}</div>
          <button class="btn btn-ghost" style="margin-top:10px;width:100%" onclick="wizAddListener()">+ Add Another Listener</button>`;
      } else {
        document.getElementById('wiz-title').textContent = 'Configure Paths';
        const transportOpts = ['httpsmux','httpmux','wssmux','wsmux','kcpmux','tcpmux','daggermux']
          .map(t => `<option value="${t}"${t===(wizData.transport||'httpsmux')?' selected':''}>${t}</option>`).join('');
        body.innerHTML = `
          <div style="font-size:11px;color:var(--text3);margin-bottom:12px">
            Define connection paths to server(s). Multiple paths provide automatic failover and load distribution.
          </div>
          <div id="wiz-paths-list" style="margin-bottom:12px">${renderWizPaths()}</div>
          <div style="background:var(--bg3);border:1px solid var(--border2);border-radius:9px;padding:14px">
            <div style="font-size:11px;font-weight:600;color:var(--text);margin-bottom:10px">Add Connection Path</div>
            <div class="form-row2" style="margin-bottom:10px">
              <div class="form-group" style="margin-bottom:0">
                <label>Server address (ip:port)</label>
                <input type="text" id="wiz-new-addr" placeholder="1.2.3.4:443">
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label>Transport</label>
                <select id="wiz-new-transport">${transportOpts}</select>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end">
              <div class="form-group" style="margin-bottom:0">
                <label>Connection Pool</label>
                <input type="number" id="wiz-new-pool" value="3" min="1" max="16">
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label>Dial Timeout (s)</label>
                <input type="number" id="wiz-new-timeout" value="20" min="5" max="120">
              </div>
              <button class="btn btn-primary" onclick="wizAddPath()">+ Add</button>
            </div>
          </div>`;
      }
    }

    // ‚îÄ‚îÄ STEP 6: Performance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    else if (step === 'performance') {
      document.getElementById('wiz-title').textContent = 'Performance profile';
      const profiles = [
        { val:'balanced',      emoji:'‚öñÔ∏è', name:'Balanced',    desc:'Default ‚Äî stable for most use cases' },
        { val:'aggressive',    emoji:'‚ö°', name:'Aggressive',  desc:'Max speed, higher CPU usage' },
        { val:'latency',       emoji:'üéØ', name:'Latency',     desc:'Low ping, best for gaming/VoIP' },
        { val:'cpu-efficient', emoji:'üê¢', name:'CPU Eff.',    desc:'Reduced CPU on weak hardware' },
        { val:'gaming',        emoji:'üéÆ', name:'Gaming',      desc:'Real-time optimised' },
      ];
      body.innerHTML = `
        <div class="prof-grid" style="margin-bottom:16px">
          ${profiles.map(p => `
          <div class="prof-card${(wizData.profile||'balanced')===p.val?' sel':''}"
            onclick="wizSelectProfile('${p.val}',this)" style="cursor:pointer">
            <div class="prof-emoji">${p.emoji}</div>
            <div class="prof-name">${p.name}</div>
            <div class="prof-desc">${p.desc}</div>
          </div>`).join('')}
        </div>
        <div class="form-row2">
          <div class="form-group"><label>Max Connections</label>
            <input type="number" id="wiz-maxconn" value="${wizData.maxconn||5000}">
          </div>
          <div class="form-group"><label>TCP KeepAlive (s)</label>
            <input type="number" id="wiz-tcpka" value="${wizData.tcpka||15}">
          </div>
        </div>
        <div class="toggle-row">
          <label>TCP NoDelay</label>
          <div class="toggle${wizData.nodelay===false?'':' on'}" id="wiz-nodelay" onclick="this.classList.toggle('on')"></div>
        </div>`;
    }

    // ‚îÄ‚îÄ STEP 7: Review ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    else if (step === 'review') {
      document.getElementById('wiz-title').textContent = 'Review & Generate';
      const yaml = wizBuildYaml();
      wizData._yaml = yaml;
      body.innerHTML = `
        <div style="font-size:12px;color:var(--text2);margin-bottom:10px">
          Review your config below, then click <strong>Generate YAML</strong> to load it into the editor.
        </div>
        <div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;
          font-family:'Geist Mono',monospace;font-size:10px;line-height:1.7;
          white-space:pre;overflow:auto;max-height:320px;color:var(--accent)">${escHtml(yaml)}</div>`;
    }
  }

  // ‚îÄ‚îÄ Render helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderWizPorts() {
    if (!wizData.ports.length)
      return '<div class="text-muted text-sm" style="padding:8px 0">No mappings yet ‚Äî add one below.</div>';
    return wizData.ports.map((p, i) => `
      <div class="pm-item mb6" style="padding:8px 12px">
        <span class="badge b-cyan">${p.type.toUpperCase()}</span>
        <span class="text-mono text-xs" style="margin-left:8px">${escHtml(p.bind)} ‚Üí ${escHtml(p.target)}</span>
        <button class="icn-btn d mla" onclick="wizRemovePort(${i})">‚úï</button>
      </div>`).join('');
  }

  function renderWizPaths() {
    if (!wizData.paths.length)
      return '<div class="text-muted text-sm" style="padding:8px 0">No paths yet ‚Äî add one below.</div>';
    return wizData.paths.map((p, i) => `
      <div class="pm-item mb6" style="padding:8px 12px">
        <span class="badge b-purple">${escHtml(p.transport)}</span>
        <span class="text-mono text-xs" style="margin-left:8px">${escHtml(p.addr)}</span>
        <span class="text-mono text-xs text-muted" style="margin-left:8px">pool:${p.pool||3} ¬∑ timeout:${p.timeout||20}s</span>
        <button class="icn-btn d mla" onclick="wizRemovePath(${i})">‚úï</button>
      </div>`).join('');
  }

  // ‚îÄ‚îÄ Add / Remove entries ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function wizAddPort() {
    const bind   = (document.getElementById('wiz-new-bind')?.value   || '').trim();
    const target = (document.getElementById('wiz-new-target')?.value || '').trim();
    const type   = document.getElementById('wiz-new-proto')?.value || 'tcp';
    if (!bind)   { showNotif('Enter a bind address (e.g. 0.0.0.0:8080)', '‚ö†Ô∏è'); return; }
    if (!target) { showNotif('Enter a target address (e.g. 127.0.0.1:8080)', '‚ö†Ô∏è'); return; }
    wizData.ports.push({ bind, target, type });
    document.getElementById('wiz-ports-list').innerHTML = renderWizPorts();
    document.getElementById('wiz-new-bind').value   = '';
    document.getElementById('wiz-new-target').value = '';
  }
  function wizRemovePort(i) {
    wizData.ports.splice(i, 1);
    document.getElementById('wiz-ports-list').innerHTML = renderWizPorts();
  }

  function wizAddPath() {
    const addr      = (document.getElementById('wiz-new-addr')?.value || '').trim();
    const transport = document.getElementById('wiz-new-transport')?.value || wizData.transport || 'httpsmux';
    const pool      = parseInt(document.getElementById('wiz-new-pool')?.value)    || 3;
    const timeout   = parseInt(document.getElementById('wiz-new-timeout')?.value) || 20;
    if (!addr) { showNotif('Enter a server address (e.g. 1.2.3.4:443)', '‚ö†Ô∏è'); return; }
    wizData.paths.push({ addr, transport, pool, timeout });
    document.getElementById('wiz-paths-list').innerHTML = renderWizPaths();
    document.getElementById('wiz-new-addr').value = '';
  }
  function wizRemovePath(i) {
    wizData.paths.splice(i, 1);
    document.getElementById('wiz-paths-list').innerHTML = renderWizPaths();
  }

  // ‚îÄ‚îÄ Selection helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function wizSelectRole(role, el) {
    wizData.role = role;
    el.closest('.modal-body, [id=wiz-body]').querySelectorAll('.prof-card').forEach(c => c.classList.remove('sel'));
    el.classList.add('sel');
  }
  function wizSelectTransport(val, el) {
    wizData.transport = val;
    document.querySelectorAll('#wiz-body .pm-item').forEach(c => {
      c.style.borderColor = 'var(--border)';
      c.style.background  = 'var(--bg2)';
    });
    el.style.borderColor = 'var(--accent)';
    el.style.background  = 'rgba(0,212,255,.07)';
  }
  function wizSelectProfile(val, el) {
    wizData.profile = val;
    el.closest('.prof-grid').querySelectorAll('.prof-card').forEach(c => c.classList.remove('sel'));
    el.classList.add('sel');
  }
  function wizTogglePsk() {
    const el = document.getElementById('wiz-psk');
    if (el) el.type = el.type === 'password' ? 'text' : 'password';
  }

  // ‚îÄ‚îÄ Collect step data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  WIZARD MULTI-LISTENER HELPERS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function renderWizListeners() {
    if (!wizData.listeners || wizData.listeners.length === 0) return '';
    return wizData.listeners.map((lst, i) => renderWizListenerCard(lst, i)).join('');
  }

  function renderWizListenerCard(lst, i) {
    const transports = ['httpsmux','httpmux','wssmux','wsmux','kcpmux','tcpmux','daggermux'];
    const tOpts = transports.map(t => `<option value="${t}"${lst.transport===t?' selected':''}>${t}</option>`).join('');
    const mapsHtml = (lst.ports||[]).map((p, pi) => `
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:5px;padding:5px 8px;background:var(--bg1);border-radius:6px;font-size:11px">
        <span class="badge ${p.type==='udp'?'b-amber':'b-cyan'}" style="min-width:32px;text-align:center">${p.type}</span>
        <span class="text-mono" style="flex:1">${p.bind} ‚Üí ${p.target}</span>
        <button class="icn-btn d" onclick="wizRemovePortFromListener(${i},${pi})" title="Remove">‚úï</button>
      </div>`).join('');
    const tunHtml = lst.tun && lst.tun.enabled ? `
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 80px;gap:8px;margin-top:8px">
        <div class="form-group" style="margin-bottom:0"><label>TUN Name</label><input type="text" id="wiz-lst${i}-tun-name" value="${lst.tun.name||'tun'+i}" placeholder="tun0"></div>
        <div class="form-group" style="margin-bottom:0"><label>Local IP/CIDR</label><input type="text" id="wiz-lst${i}-tun-local" value="${lst.tun.localIp||'10.0.0.1/30'}" placeholder="10.0.0.1/30"></div>
        <div class="form-group" style="margin-bottom:0"><label>Peer IP</label><input type="text" id="wiz-lst${i}-tun-peer" value="${lst.tun.peerIp||'10.0.0.2'}" placeholder="10.0.0.2"></div>
        <div class="form-group" style="margin-bottom:0"><label>MTU</label><input type="number" id="wiz-lst${i}-tun-mtu" value="${lst.tun.mtu||1420}" min="576" max="1500"></div>
      </div>` : '';
    return `
    <div style="background:var(--bg2);border:1px solid var(--border2);border-radius:10px;margin-bottom:12px;overflow:hidden" id="wiz-lst-card-${i}">
      <div style="display:flex;align-items:center;padding:10px 14px;background:var(--bg3);border-bottom:1px solid var(--border);gap:10px">
        <span class="badge b-cyan" style="min-width:24px;text-align:center">${i+1}</span>
        <span style="font-size:12px;font-weight:600;flex:1">Listener ${i+1}</span>
        ${i > 0 ? `<button class="icn-btn d" onclick="wizRemoveListener(${i})" title="Remove listener">üóë</button>` : ''}
      </div>
      <div style="padding:12px 14px">
        <div class="form-row2" style="margin-bottom:10px">
          <div class="form-group" style="margin-bottom:0">
            <label>Bind Address (IP:port)</label>
            <input type="text" id="wiz-lst${i}-addr" value="${lst.addr||'0.0.0.0:443'}" placeholder="0.0.0.0:443">
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label>Transport</label>
            <select id="wiz-lst${i}-transport">${tOpts}</select>
          </div>
        </div>

        <div style="margin-bottom:8px">
          <div style="font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">Port Mappings</div>
          <div id="wiz-lst${i}-ports">${mapsHtml || '<div style="font-size:11px;color:var(--text3);padding:4px 0">No mappings yet ‚Äî add below</div>'}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 80px auto;gap:6px;margin-top:6px;align-items:end">
            <div class="form-group" style="margin-bottom:0"><label style="font-size:9px">Bind</label><input type="text" id="wiz-lst${i}-new-bind" placeholder="0.0.0.0:8080" style="font-size:11px;padding:5px 8px"></div>
            <div class="form-group" style="margin-bottom:0"><label style="font-size:9px">Target</label><input type="text" id="wiz-lst${i}-new-target" placeholder="127.0.0.1:8080" style="font-size:11px;padding:5px 8px"></div>
            <div class="form-group" style="margin-bottom:0"><label style="font-size:9px">Proto</label>
              <select id="wiz-lst${i}-new-proto" style="font-size:11px;padding:5px 6px">
                <option value="tcp">tcp</option><option value="udp">udp</option><option value="both">both</option>
              </select>
            </div>
            <button class="btn btn-primary" style="padding:6px 10px;font-size:11px" onclick="wizAddPortToListener(${i})">+ Add</button>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:8px;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
          <label style="font-size:11px;display:flex;align-items:center;gap:6px;cursor:pointer">
            <input type="checkbox" id="wiz-lst${i}-tun-enabled" ${lst.tun&&lst.tun.enabled?'checked':''} onchange="wizToggleTun(${i},this.checked)" style="cursor:pointer">
            <span>Enable TUN interface</span>
          </label>
          <span style="font-size:10px;color:var(--text3)">(for IP routing / VPN mode)</span>
        </div>
        <div id="wiz-lst${i}-tun-fields" style="${lst.tun&&lst.tun.enabled?'':'display:none'}">${tunHtml}</div>
      </div>
    </div>`;
  }

  function wizAddListener() {
    wizCollectListeners();
    wizData.listeners.push({
      addr: '0.0.0.0:' + (444 + wizData.listeners.length),
      transport: wizData.transport || 'httpsmux',
      ports: [],
      tun: null
    });
    document.getElementById('wiz-listeners-list').innerHTML = renderWizListeners();
  }

  function wizRemoveListener(i) {
    if (wizData.listeners.length <= 1) { showNotif('Need at least one listener', '‚ö†Ô∏è'); return; }
    wizCollectListeners();
    wizData.listeners.splice(i, 1);
    document.getElementById('wiz-listeners-list').innerHTML = renderWizListeners();
  }

  function wizCollectListeners() {
    if (!wizData.listeners) return;
    wizData.listeners.forEach((lst, i) => {
      const addr = document.getElementById(`wiz-lst${i}-addr`);
      const transport = document.getElementById(`wiz-lst${i}-transport`);
      if (addr) lst.addr = addr.value.trim();
      if (transport) lst.transport = transport.value;
      const tunEnabled = document.getElementById(`wiz-lst${i}-tun-enabled`);
      if (tunEnabled && tunEnabled.checked) {
        lst.tun = {
          enabled: true,
          name:    (document.getElementById(`wiz-lst${i}-tun-name`)?.value    || 'tun'+i).trim(),
          localIp: (document.getElementById(`wiz-lst${i}-tun-local`)?.value   || '10.0.0.1/30').trim(),
          peerIp:  (document.getElementById(`wiz-lst${i}-tun-peer`)?.value    || '10.0.0.2').trim(),
          mtu:     parseInt(document.getElementById(`wiz-lst${i}-tun-mtu`)?.value) || 1420,
        };
      } else {
        lst.tun = null;
      }
    });
  }

  function wizAddPortToListener(i) {
    const bind   = document.getElementById(`wiz-lst${i}-new-bind`)?.value.trim();
    const target = document.getElementById(`wiz-lst${i}-new-target`)?.value.trim();
    const proto  = document.getElementById(`wiz-lst${i}-new-proto`)?.value || 'tcp';
    if (!bind || !target) { showNotif('Fill in bind and target addresses', '‚ö†Ô∏è'); return; }
    if (!bind.includes(':'))   { showNotif('Bind must be ip:port', '‚ö†Ô∏è'); return; }
    if (!target.includes(':')) { showNotif('Target must be ip:port', '‚ö†Ô∏è'); return; }
    wizData.listeners[i].ports.push({ type: proto, bind, target });
    document.getElementById(`wiz-lst${i}-ports`).innerHTML =
      wizData.listeners[i].ports.map((p, pi) => `
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:5px;padding:5px 8px;background:var(--bg1);border-radius:6px;font-size:11px">
          <span class="badge ${p.type==='udp'?'b-amber':'b-cyan'}" style="min-width:32px;text-align:center">${p.type}</span>
          <span class="text-mono" style="flex:1">${p.bind} ‚Üí ${p.target}</span>
          <button class="icn-btn d" onclick="wizRemovePortFromListener(${i},${pi})" title="Remove">‚úï</button>
        </div>`).join('');
    document.getElementById(`wiz-lst${i}-new-bind`).value = '';
    document.getElementById(`wiz-lst${i}-new-target`).value = '';
  }

  function wizRemovePortFromListener(i, pi) {
    wizData.listeners[i].ports.splice(pi, 1);
    document.getElementById(`wiz-lst${i}-ports`).innerHTML =
      wizData.listeners[i].ports.length === 0
        ? '<div style="font-size:11px;color:var(--text3);padding:4px 0">No mappings yet ‚Äî add below</div>'
        : wizData.listeners[i].ports.map((p, pi2) => `
            <div style="display:flex;align-items:center;gap:6px;margin-bottom:5px;padding:5px 8px;background:var(--bg1);border-radius:6px;font-size:11px">
              <span class="badge ${p.type==='udp'?'b-amber':'b-cyan'}" style="min-width:32px;text-align:center">${p.type}</span>
              <span class="text-mono" style="flex:1">${p.bind} ‚Üí ${p.target}</span>
              <button class="icn-btn d" onclick="wizRemovePortFromListener(${i},${pi2})" title="Remove">‚úï</button>
            </div>`).join('');
  }

  function wizToggleTun(i, enabled) {
    const fields = document.getElementById(`wiz-lst${i}-tun-fields`);
    if (!fields) return;
    if (enabled) {
      if (!wizData.listeners[i].tun) {
        wizData.listeners[i].tun = { enabled: true, name: 'tun'+i, localIp: `10.${i}.0.1/30`, peerIp: `10.${i}.0.2`, mtu: 1420 };
      } else {
        wizData.listeners[i].tun.enabled = true;
      }
      fields.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 80px;gap:8px;margin-top:8px">
          <div class="form-group" style="margin-bottom:0"><label>TUN Name</label><input type="text" id="wiz-lst${i}-tun-name" value="${wizData.listeners[i].tun.name}" placeholder="tun0"></div>
          <div class="form-group" style="margin-bottom:0"><label>Local IP/CIDR</label><input type="text" id="wiz-lst${i}-tun-local" value="${wizData.listeners[i].tun.localIp}" placeholder="10.0.0.1/30"></div>
          <div class="form-group" style="margin-bottom:0"><label>Peer IP</label><input type="text" id="wiz-lst${i}-tun-peer" value="${wizData.listeners[i].tun.peerIp}" placeholder="10.0.0.2"></div>
          <div class="form-group" style="margin-bottom:0"><label>MTU</label><input type="number" id="wiz-lst${i}-tun-mtu" value="${wizData.listeners[i].tun.mtu}" min="576" max="1500"></div>
        </div>`;
      fields.style.display = '';
    } else {
      if (wizData.listeners[i].tun) wizData.listeners[i].tun.enabled = false;
      fields.style.display = 'none';
    }
  }

  function wizCollect() {
    const step = WIZ_STEPS[wizStep];

    if (step === 'role') {
      if (!wizData.role) { showNotif('Please select a role', '‚ö†Ô∏è'); return false; }
    }
    else if (step === 'transport') {
      if (!wizData.transport) { showNotif('Please select a transport', '‚ö†Ô∏è'); return false; }
    }
    else if (step === 'connection') {
      wizData.psk     = (document.getElementById('wiz-psk')?.value     || '').trim();
      wizData.verbose = document.getElementById('wiz-verbose')?.classList.contains('on') || false;
      if (!wizData.psk) { showNotif('PSK is required', '‚ö†Ô∏è'); return false; }
      if (wizData.role === 'server') {
        wizData.ip   = (document.getElementById('wiz-ip')?.value || '0.0.0.0').trim();
        wizData.port = document.getElementById('wiz-port')?.value || '443';
      } else {
        wizData.addr = (document.getElementById('wiz-addr')?.value || '').trim();
        if (!wizData.addr) { showNotif('Server address is required', '‚ö†Ô∏è'); return false; }
      }
    }
    else if (step === 'transport_opts') {
      const t = wizData.transport || 'httpsmux';
      if (['httpsmux','httpmux','wssmux','wsmux'].includes(t)) {
        wizData.fakeDomain    = document.getElementById('wiz-fake-domain')?.value || 'www.google.com';
        wizData.fakePath      = (document.getElementById('wiz-fake-path')?.value || '/search').trim();
        wizData.sessionCookie = document.getElementById('wiz-session-cookie')?.classList.contains('on') ?? true;
      }
      if (['httpsmux','wssmux'].includes(t)) {
        wizData.certFile = (document.getElementById('wiz-cert-file')?.value || '/etc/DaggerConnect/certs/cert.pem').trim();
        wizData.keyFile  = (document.getElementById('wiz-key-file')?.value  || '/etc/DaggerConnect/certs/key.pem').trim();
      }
      if (t === 'daggermux') {
        const fp = document.getElementById('wiz-dm-flags')?.value || 'http';
        const flagMap = {
          http: { local: ['PA','A'],         remote: ['PA','A'] },
          bulk: { local: ['PA','A','PA'],     remote: ['PA','A'] },
          tls:  { local: ['PA','A','PSH'],    remote: ['PA','A'] },
        };
        wizData.dm = {
          mtu:         parseInt(document.getElementById('wiz-dm-mtu')?.value)    || 1350,
          sndWnd:      parseInt(document.getElementById('wiz-dm-sndwnd')?.value) || 1024,
          rcvWnd:      parseInt(document.getElementById('wiz-dm-rcvwnd')?.value) || 1024,
          sockBuf:     parseInt(document.getElementById('wiz-dm-sockbuf')?.value)|| 4194304,
          dataShard:   parseInt(document.getElementById('wiz-dm-data')?.value)   || 10,
          parityShard: parseInt(document.getElementById('wiz-dm-parity')?.value) || 1,
          flagProfile: fp,
          localFlags:  flagMap[fp] ? flagMap[fp].local  : ['PA','A'],
          remoteFlags: flagMap[fp] ? flagMap[fp].remote : ['PA','A'],
        };
      }
      if (t === 'kcpmux') {
        wizData.kcp = {
          dataShard:   parseInt(document.getElementById('wiz-kcp-data')?.value)   || 10,
          parityShard: parseInt(document.getElementById('wiz-kcp-parity')?.value) || 1,
          mtu:         parseInt(document.getElementById('wiz-kcp-mtu')?.value)    || 1350,
          sockBuf:     parseInt(document.getElementById('wiz-kcp-sockbuf')?.value)|| 4194304,
        };
      }
    }
    else if (step === 'listeners') {
      if (wizData.role === 'server') {
        wizCollectListeners();
        if (!wizData.listeners || wizData.listeners.length === 0) {
          showNotif('Add at least one listener', '‚ö†Ô∏è'); return false;
        }
        const hasPort = wizData.listeners.some(l => l.ports && l.ports.length > 0);
        if (!hasPort) { showNotif('At least one listener needs a port mapping', '‚ö†Ô∏è'); return false; }
      } else {
        if (!wizData.paths || wizData.paths.length === 0) {
          showNotif('Add at least one connection path', '‚ö†Ô∏è'); return false;
        }
      }
    }
    else if (step === 'performance') {
      wizData.profile = wizData.profile || 'balanced';
      wizData.maxconn = document.getElementById('wiz-maxconn')?.value || '5000';
      wizData.tcpka   = document.getElementById('wiz-tcpka')?.value   || '15';
      wizData.nodelay = document.getElementById('wiz-nodelay')?.classList.contains('on') ?? true;
    }
    return true;
  }

  // ‚îÄ‚îÄ Build YAML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function wizBuildYaml() {
    const d        = wizData;
    const t        = d.transport || 'httpsmux';
    const hasMimic = ['httpsmux','httpmux','wssmux','wsmux'].includes(t);
    const hasCert  = ['httpsmux','wssmux'].includes(t);
    const certFile = d.certFile || '/etc/DaggerConnect/certs/cert.pem';
    const keyFile  = d.keyFile  || '/etc/DaggerConnect/certs/key.pem';
    const domain   = d.fakeDomain    || 'www.google.com';
    const path     = d.fakePath      || '/search';
    const cookie   = d.sessionCookie === false ? 'false' : 'true';

    if (d.role === 'server') {
      // Build multi-listener YAML
      const listeners = (d.listeners && d.listeners.length > 0) ? d.listeners : [{
        addr: (d.ip||'0.0.0.0') + ':' + (d.port||'443'),
        transport: t,
        ports: d.ports || [],
        tun: null
      }];

      let yaml = `mode: "server"\npsk: "${d.psk}"\nprofile: "${d.profile||'balanced'}"\nverbose: ${d.verbose||false}\n`;
      if (hasCert)  yaml += `\ncert_file: "${certFile}"\nkey_file: "${keyFile}"\n`;
      if (hasMimic) yaml += `\nhttp_mimic:\n  fake_domain: "${domain}"\n  fake_path: "${path}"\n  session_cookie: ${cookie}\n`;
      yaml += `\nlisteners:\n`;
      listeners.forEach(lst => {
        const lT = lst.transport || t;
        const lHasCert = ['httpsmux','wssmux'].includes(lT);
        yaml += `  - addr: "${lst.addr||'0.0.0.0:443'}"\n    transport: "${lT}"\n`;
        if (lHasCert) yaml += `    cert_file: "${certFile}"\n    key_file: "${keyFile}"\n`;
        const mapsYaml = (lst.ports || []).map(p =>
          `      - type: ${p.type}\n        bind: "${p.bind}"\n        target: "${p.target}"`
        ).join('\n') || '      - type: tcp\n        bind: "0.0.0.0:2222"\n        target: "127.0.0.1:22"';
        yaml += `    maps:\n${mapsYaml}\n`;
        if (lst.tun && lst.tun.enabled) {
          yaml += `    tun:\n      name: "${lst.tun.name||'tun0'}"\n      local_ip: "${lst.tun.localIp||'10.0.0.1/30'}"\n      peer_ip: "${lst.tun.peerIp||'10.0.0.2'}"\n      mtu: ${lst.tun.mtu||1420}\n`;
        }
      });
      yaml += `\nsmux:\n  keepalive_interval: 5\n  max_frame_size: 32768\n  max_receive_buffer: 16777216\n`;
      yaml += `\ntcp:\n  nodelay: ${d.nodelay??true}\n  keepalive: ${d.tcpka||15}\n  max_connections: ${d.maxconn||5000}\n`;
      yaml += `\nobfuscation:\n  enabled: false\n  min_padding: 16\n  max_padding: 256\n  min_delay_ms: 5\n  max_delay_ms: 50\n  burst_chance: 0.15\n`;
      if (t === 'daggermux') {
        const dm = d.dm || {};
        const lf = (dm.localFlags  || ['PA','A']).map(f => `    - "${f}"`).join('\n');
        const rf = (dm.remoteFlags || ['PA','A']).map(f => `    - "${f}"`).join('\n');
        yaml += `\ndaggermux:\n  mtu: ${dm.mtu||1350}\n  snd_wnd: ${dm.sndWnd||1024}\n  rcv_wnd: ${dm.rcvWnd||1024}\n  data_shard: ${dm.dataShard||10}\n  parity_shard: ${dm.parityShard||1}\n  sock_buf: ${dm.sockBuf||4194304}\n  local_flags:\n${lf}\n  remote_flags:\n${rf}\n`;
      }
      if (t === 'kcpmux') {
        const kcp = d.kcp || {};
        yaml += `\nkcpmux:\n  mtu: ${kcp.mtu||1350}\n  data_shard: ${kcp.dataShard||10}\n  parity_shard: ${kcp.parityShard||1}\n  sock_buf: ${kcp.sockBuf||4194304}\n`;
      }
      return yaml;

    } else {
      let pathsYaml = (d.paths || []).map(p =>
        `  - transport: "${p.transport}"\n    addr: "${p.addr}"\n    connection_pool: ${p.pool||3}\n    aggressive_pool: true\n    retry_interval: 5\n    dial_timeout: ${p.timeout||20}`
      ).join('\n') || `  - transport: "${t}"\n    addr: "SERVER_IP:443"\n    connection_pool: 3\n    aggressive_pool: true\n    retry_interval: 5\n    dial_timeout: 20`;

      let yaml = `mode: "client"\npsk: "${d.psk}"\nprofile: "${d.profile||'balanced'}"\nverbose: ${d.verbose||false}\n`;
      if (hasMimic) yaml += `\nhttp_mimic:\n  fake_domain: "${domain}"\n  fake_path: "${path}"\n  session_cookie: ${cookie}\n`;
      yaml += `\npaths:\n${pathsYaml}\n`;
      yaml += `\nsmux:\n  keepalive_interval: 5\n  max_frame_size: 32768\n  max_receive_buffer: 16777216\n`;
      yaml += `\ntcp:\n  nodelay: ${d.nodelay??true}\n  keepalive: ${d.tcpka||15}\n  max_connections: ${d.maxconn||5000}\n`;
      yaml += `\nobfuscation:\n  enabled: false\n  min_padding: 16\n  max_padding: 256\n  min_delay_ms: 5\n  max_delay_ms: 50\n  burst_chance: 0.15\n`;
      if (t === 'daggermux') {
        const dm = d.dm || {};
        const lf = (dm.localFlags  || ['PA','A']).map(f => `    - "${f}"`).join('\n');
        const rf = (dm.remoteFlags || ['PA','A']).map(f => `    - "${f}"`).join('\n');
        yaml += `\ndaggermux:\n  mtu: ${dm.mtu||1350}\n  snd_wnd: ${dm.sndWnd||1024}\n  rcv_wnd: ${dm.rcvWnd||1024}\n  data_shard: ${dm.dataShard||10}\n  parity_shard: ${dm.parityShard||1}\n  sock_buf: ${dm.sockBuf||4194304}\n  local_flags:\n${lf}\n  remote_flags:\n${rf}\n`;
      }
      if (t === 'kcpmux') {
        const kcp = d.kcp || {};
        yaml += `\nkcpmux:\n  mtu: ${kcp.mtu||1350}\n  data_shard: ${kcp.dataShard||10}\n  parity_shard: ${kcp.parityShard||1}\n  sock_buf: ${kcp.sockBuf||4194304}\n`;
      }
      return yaml;
    }
  }

  function wizFinish() {
    if (!wizCollect()) return;
    const yaml   = wizBuildYaml();
    const target = wizData.role === 'client' ? 'client' : 'server';
    document.getElementById('yaml-target').value = target;
    closeWizard();
    switchTab('yaml', true);
    document.getElementById('yaml-editor').value = yaml;
    document.getElementById('yaml-file-label').textContent =
      `Wizard output ‚Äî /etc/DaggerConnect/${target}.yaml  (click Apply & Restart to save)`;
    showNotif('Wizard complete! Review YAML then click Apply & Restart', 'üßô');
  }
</script>
</body>
</html>